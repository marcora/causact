<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Adam Fleischhacker">
<meta name="dcterms.date" content="2025-01-15">

<title>A Business analyst’s introduction to business analytics (2e)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="causact_files/libs/clipboard/clipboard.min.js"></script>
<script src="causact_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="causact_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="causact_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="causact_files/libs/quarto-html/popper.min.js"></script>
<script src="causact_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="causact_files/libs/quarto-html/anchor.min.js"></script>
<link href="causact_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="causact_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="causact_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="causact_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="causact_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="causact_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="causact_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="causact_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="causact_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="causact_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="causact_files/libs/viz-1.8.2/viz.js"></script>
<link href="causact_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="causact_files/libs/grViz-binding-1.0.11/grViz.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#representing-uncertainty" id="toc-representing-uncertainty" class="nav-link" data-scroll-target="#representing-uncertainty">Representing uncertainty</a></li>
  <li><a href="#joint-distributions-tell-you-everything" id="toc-joint-distributions-tell-you-everything" class="nav-link" data-scroll-target="#joint-distributions-tell-you-everything">Joint distributions tell you everything</a>
  <ul class="collapse">
  <li><a href="#joint-distributions" id="toc-joint-distributions" class="nav-link" data-scroll-target="#joint-distributions">Joint distributions</a></li>
  <li><a href="#marginal-distributions" id="toc-marginal-distributions" class="nav-link" data-scroll-target="#marginal-distributions">Marginal distributions</a></li>
  <li><a href="#conditional-distributions" id="toc-conditional-distributions" class="nav-link" data-scroll-target="#conditional-distributions">Conditional distributions</a></li>
  <li><a href="#limitations-of-joint-distributions" id="toc-limitations-of-joint-distributions" class="nav-link" data-scroll-target="#limitations-of-joint-distributions">Limitations of joint distributions</a></li>
  </ul></li>
  <li><a href="#graphical-models-tell-joint-distribution-stories" id="toc-graphical-models-tell-joint-distribution-stories" class="nav-link" data-scroll-target="#graphical-models-tell-joint-distribution-stories">Graphical models tell joint distribution stories</a></li>
  <li><a href="#bayesian-inference-on-graphical-models" id="toc-bayesian-inference-on-graphical-models" class="nav-link" data-scroll-target="#bayesian-inference-on-graphical-models">Bayesian inference on graphical models</a>
  <ul class="collapse">
  <li><a href="#building-a-graphical-model-of-the-real-world" id="toc-building-a-graphical-model-of-the-real-world" class="nav-link" data-scroll-target="#building-a-graphical-model-of-the-real-world">Building a graphical model of the real-world</a></li>
  <li><a href="#from-model-to-joint-distribution" id="toc-from-model-to-joint-distribution" class="nav-link" data-scroll-target="#from-model-to-joint-distribution">From model to joint distribution</a></li>
  <li><a href="#bayesian-updating-of-the-joint-distribution" id="toc-bayesian-updating-of-the-joint-distribution" class="nav-link" data-scroll-target="#bayesian-updating-of-the-joint-distribution">Bayesian updating of the joint distribution</a></li>
  </ul></li>
  <li><a href="#generative-dags-as-scientific-and-statistical-models" id="toc-generative-dags-as-scientific-and-statistical-models" class="nav-link" data-scroll-target="#generative-dags-as-scientific-and-statistical-models">Generative DAGs as scientific and statistical models</a>
  <ul class="collapse">
  <li><a href="#generative-dags" id="toc-generative-dags" class="nav-link" data-scroll-target="#generative-dags">Generative DAGs</a></li>
  <li><a href="#building-generative-models" id="toc-building-generative-models" class="nav-link" data-scroll-target="#building-generative-models">Building generative models</a></li>
  <li><a href="#representing-observed-data-with-fill-and-a-plate" id="toc-representing-observed-data-with-fill-and-a-plate" class="nav-link" data-scroll-target="#representing-observed-data-with-fill-and-a-plate">Representing observed data with fill and a plate</a></li>
  </ul></li>
  <li><a href="#computational-bayesian-inference-workflows" id="toc-computational-bayesian-inference-workflows" class="nav-link" data-scroll-target="#computational-bayesian-inference-workflows">Computational Bayesian inference workflows</a>
  <ul class="collapse">
  <li><a href="#getting-started-with-dag_foo-functions" id="toc-getting-started-with-dag_foo-functions" class="nav-link" data-scroll-target="#getting-started-with-dag_foo-functions">Getting started with <code>dag_foo()</code> functions</a></li>
  <li><a href="#four-steps-to-creating-graphical-models" id="toc-four-steps-to-creating-graphical-models" class="nav-link" data-scroll-target="#four-steps-to-creating-graphical-models">Four steps to creating graphical models</a></li>
  <li><a href="#running-bayesian-inference-on-a-generative-dag" id="toc-running-bayesian-inference-on-a-generative-dag" class="nav-link" data-scroll-target="#running-bayesian-inference-on-a-generative-dag">Running Bayesian inference on a generative DAG</a></li>
  <li><a href="#investigating-the-posterior-distribution" id="toc-investigating-the-posterior-distribution" class="nav-link" data-scroll-target="#investigating-the-posterior-distribution">Investigating the posterior distribution</a></li>
  <li><a href="#making-probabilistic-statements-with-indicator-functions" id="toc-making-probabilistic-statements-with-indicator-functions" class="nav-link" data-scroll-target="#making-probabilistic-statements-with-indicator-functions">Making probabilistic statements with indicator functions</a></li>
  <li><a href="#credit-card-example" id="toc-credit-card-example" class="nav-link" data-scroll-target="#credit-card-example">Credit card example</a></li>
  </ul></li>
  <li><a href="#the-binomial-distribution" id="toc-the-binomial-distribution" class="nav-link" data-scroll-target="#the-binomial-distribution">The binomial distribution</a>
  <ul class="collapse">
  <li><a href="#using-a-beta-prior-for-the-bernoulli-parameter" id="toc-using-a-beta-prior-for-the-bernoulli-parameter" class="nav-link" data-scroll-target="#using-a-beta-prior-for-the-bernoulli-parameter">Using a Beta prior for the Bernoulli parameter</a></li>
  <li><a href="#matching-beta-parameters-to-your-beliefs" id="toc-matching-beta-parameters-to-your-beliefs" class="nav-link" data-scroll-target="#matching-beta-parameters-to-your-beliefs">Matching Beta parameters to your beliefs</a></li>
  <li><a href="#using-a-beta-prior-for-the-bernoulli-parameter-1" id="toc-using-a-beta-prior-for-the-bernoulli-parameter-1" class="nav-link" data-scroll-target="#using-a-beta-prior-for-the-bernoulli-parameter-1">Using a Beta prior for the Bernoulli parameter</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  </ul></li>
  <li><a href="#parameter-estimation" id="toc-parameter-estimation" class="nav-link" data-scroll-target="#parameter-estimation">Parameter estimation</a>
  <ul class="collapse">
  <li><a href="#normal-distribution" id="toc-normal-distribution" class="nav-link" data-scroll-target="#normal-distribution">Normal distribution</a></li>
  <li><a href="#gamma-distribution" id="toc-gamma-distribution" class="nav-link" data-scroll-target="#gamma-distribution">Gamma distribution</a></li>
  <li><a href="#student-t-distribution" id="toc-student-t-distribution" class="nav-link" data-scroll-target="#student-t-distribution">Student <span class="math inline">\(t\)</span> distribution</a></li>
  <li><a href="#poisson-distribution" id="toc-poisson-distribution" class="nav-link" data-scroll-target="#poisson-distribution">Poisson distribution</a></li>
  </ul></li>
  <li><a href="#posterior-predictive-checks" id="toc-posterior-predictive-checks" class="nav-link" data-scroll-target="#posterior-predictive-checks">Posterior predictive checks</a>
  <ul class="collapse">
  <li><a href="#posterior-predictive-checks-1" id="toc-posterior-predictive-checks-1" class="nav-link" data-scroll-target="#posterior-predictive-checks-1">Posterior predictive check(s)</a></li>
  </ul></li>
  <li><a href="#decision-making" id="toc-decision-making" class="nav-link" data-scroll-target="#decision-making">Decision making</a>
  <ul class="collapse">
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#decisions" id="toc-decisions" class="nav-link" data-scroll-target="#decisions">Decisions</a></li>
  <li><a href="#uncertainty" id="toc-uncertainty" class="nav-link" data-scroll-target="#uncertainty">Uncertainty</a></li>
  <li><a href="#creating-one-draw-of-a-generative-decision-dag" id="toc-creating-one-draw-of-a-generative-decision-dag" class="nav-link" data-scroll-target="#creating-one-draw-of-a-generative-decision-dag">Creating one draw of a generative decision DAG</a></li>
  <li><a href="#simulating-a-possible-outcome" id="toc-simulating-a-possible-outcome" class="nav-link" data-scroll-target="#simulating-a-possible-outcome">Simulating a possible outcome</a></li>
  <li><a href="#simulating-a-range-of-outcomes-for-all-possible-decisions" id="toc-simulating-a-range-of-outcomes-for-all-possible-decisions" class="nav-link" data-scroll-target="#simulating-a-range-of-outcomes-for-all-possible-decisions">Simulating a range of outcomes for all possible decisions</a></li>
  <li><a href="#faster-code" id="toc-faster-code" class="nav-link" data-scroll-target="#faster-code">Faster code</a></li>
  </ul></li>
  <li><a href="#a-simple-linear-model" id="toc-a-simple-linear-model" class="nav-link" data-scroll-target="#a-simple-linear-model">A simple linear model</a>
  <ul class="collapse">
  <li><a href="#a-simple-bayesian-linear-model" id="toc-a-simple-bayesian-linear-model" class="nav-link" data-scroll-target="#a-simple-bayesian-linear-model">A simple Bayesian linear model</a></li>
  <li><a href="#adding-robustness" id="toc-adding-robustness" class="nav-link" data-scroll-target="#adding-robustness">Adding robustness</a></li>
  <li><a href="#explanatory-variable-centering" id="toc-explanatory-variable-centering" class="nav-link" data-scroll-target="#explanatory-variable-centering">Explanatory variable centering</a></li>
  <li><a href="#getting-more-help" id="toc-getting-more-help" class="nav-link" data-scroll-target="#getting-more-help">Getting more help</a></li>
  </ul></li>
  <li><a href="#linear-predictors-and-inverse-link-functions" id="toc-linear-predictors-and-inverse-link-functions" class="nav-link" data-scroll-target="#linear-predictors-and-inverse-link-functions">Linear predictors and inverse link functions</a>
  <ul class="collapse">
  <li><a href="#linear-predictors" id="toc-linear-predictors" class="nav-link" data-scroll-target="#linear-predictors">Linear predictors</a></li>
  <li><a href="#inverse-link-functions" id="toc-inverse-link-functions" class="nav-link" data-scroll-target="#inverse-link-functions">Inverse link functions</a></li>
  </ul></li>
  <li><a href="#multi-level-modeling" id="toc-multi-level-modeling" class="nav-link" data-scroll-target="#multi-level-modeling">Multi-level modeling</a>
  <ul class="collapse">
  <li><a href="#the-gym-data" id="toc-the-gym-data" class="nav-link" data-scroll-target="#the-gym-data">The gym data</a></li>
  <li><a href="#complete-pooling" id="toc-complete-pooling" class="nav-link" data-scroll-target="#complete-pooling">Complete pooling</a></li>
  <li><a href="#no-pooling" id="toc-no-pooling" class="nav-link" data-scroll-target="#no-pooling">No pooling</a></li>
  <li><a href="#partial-pooling" id="toc-partial-pooling" class="nav-link" data-scroll-target="#partial-pooling">Partial pooling</a></li>
  </ul></li>
  <li><a href="#compelling-decisions-and-actions-under-uncertainty" id="toc-compelling-decisions-and-actions-under-uncertainty" class="nav-link" data-scroll-target="#compelling-decisions-and-actions-under-uncertainty">Compelling decisions and actions under uncertainty</a>
  <ul class="collapse">
  <li><a href="#outcomes-of-interest" id="toc-outcomes-of-interest" class="nav-link" data-scroll-target="#outcomes-of-interest">Outcomes of interest</a></li>
  <li><a href="#computing-posterior-distributions-for-outcomes-of-interest" id="toc-computing-posterior-distributions-for-outcomes-of-interest" class="nav-link" data-scroll-target="#computing-posterior-distributions-for-outcomes-of-interest">Computing posterior distributions for outcomes of interest</a></li>
  <li><a href="#visual-advocacy-for-decisions-which-improve-outcomes-of-interest" id="toc-visual-advocacy-for-decisions-which-improve-outcomes-of-interest" class="nav-link" data-scroll-target="#visual-advocacy-for-decisions-which-improve-outcomes-of-interest">Visual advocacy for decisions which improve outcomes of interest</a></li>
  </ul></li>
  <li><a href="#the-journey-continues" id="toc-the-journey-continues" class="nav-link" data-scroll-target="#the-journey-continues">The journey continues</a>
  <ul class="collapse">
  <li><a href="#additional-readings" id="toc-additional-readings" class="nav-link" data-scroll-target="#additional-readings">Additional readings</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">A Business analyst’s introduction to business analytics (2e)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Adam Fleischhacker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggformula)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mosaic)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(causact) <span class="co"># causact::install_causact_deps()</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="https://www.causact.com/#welcome">https://www.causact.com/</a></p>
<p><img src="images/clipboard-340255815.png" class="img-fluid" style="width:50.0%"></p>
<p><a href="http://www.amazon.com/dp/B0CFZMKRGX" class="uri">http://www.amazon.com/dp/B0CFZMKRGX</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>There are three languages at the core of any data analysis: narrative, math, and code.</p>
<ul>
<li><p><strong>Narrative</strong>: This is the language of your real-world understanding.</p></li>
<li><p><strong>Math</strong>: This is the language describing a faithful mathematical representation of your real-world narrative whose solution or output might turn your data into data-driven insight.</p></li>
<li><p><strong>Code</strong>: This is the programming language, the code required to generate output that exactly or approximately solves your math problem or generates the desired output.</p></li>
</ul>
<p>Using Bayesian inference is the provably best method of combining data with domain knowledge to extract interpretable and insightful results that lead us towards better outcomes.</p>
<p>This is the job of the <em>business analyst</em>; to drive better outcomes by compelling actions that are aligned with strategy and informed by data.</p>
<p><img src="images/clipboard-2076919182.png" class="img-fluid"></p>
<p><img src="images/clipboard-613416536.png" class="img-fluid"></p>
<p>The business analyst workflow consists of transforming the real-world into a compact mathematical representation that we can use, along with data, to computationally search for insights. These computational insights must then be translated back into the real-world in such a way that they inspire action which leads to improved outcomes. This is your role: transform the real-world into the math/computer world, extract mathematical/statistical/computational insight, then transform that insight into a compelling real-world call for action.</p>
<p><img src="images/clipboard-3434935492.png" class="img-fluid"></p>
</section>
<section id="representing-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="representing-uncertainty">Representing uncertainty</h2>
<p><span class="smallcaps">Real-world uncertainty</span> makes decision making hard. Conversely, without uncertainty decisions would be easier. For example, if a cafe knew exactly 10 customers would want a bagel, then they could make exactly 10 bagels in the morning; if a factory’s machine could make each part exactly the same, then quality control to ensure the part’s fit could be eliminated; if a customer’s future ability to pay back a loan was known, then a bank’s decision to underwrite the loan would be quite simple.</p>
<p>In this section, we learn to represent our real-world uncertainty (e.g.&nbsp;demand for bagels, quality of a manufacturing process , or risk of loan default) in mathematical and computational terms. We start by defining the ideal mathematical way of representing uncertainty, namely by assigning a <em>probability distribution</em> to a <em>random variable</em>. Subsequently, we learn to describe our uncertainty in a <em>random variable</em> using <em>representative samples</em> as a pragmatic computational proxy to this mathematical ideal.</p>
<p>Think of a random variable as a mapping from potential outcomes to numerical values representing the probability we assign to each outcome.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outcome</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Heads</td>
<td>0.5</td>
</tr>
<tr class="even">
<td>Tails</td>
<td>0.5</td>
</tr>
</tbody>
</table>
<p>While the table might be adequate to describe the mapping of coin flip outcomes to probability, as we make more complex models of the real-world, we will want to take advantage of the concise (and often terse) notation that mathematicians would use. In addition, we want to gain fluency in <em>math world</em> notation so that we can successfully traverse the bridge between <em>real world</em> and <em>math world</em>.</p>
<p>Above, a random variable was introduced as a mapping of outcomes to probabilities. And, this is how you should think of it most of the time. However, to start gaining fluency in the math-world definition of a random variable, we will also view this mapping process as not just one mapping, but rather a sequence of two mappings: 1) the first mapping is actually the “true” probability-theory definition of a <strong>random variable</strong> - it maps all possible outcomes to real numbers, and 2) the second mapping, known as a <strong>probability distribution</strong> in probability theory, maps the numbers from the first mapping to real numbers representing how plausibility is allocated across all possible outcomes - we often think of this allocation as assigning probability to each outcome.</p>
<p>The terse math-world representation of a mapping process like this is denoted:</p>
<p><span class="math display">\[
X:\Omega \rightarrow \mathbb{R}
\]</span></p>
<p>, where you interpret it as “random variable <span class="math inline">\(X\)</span> maps each possible outcome in sample space omega to a real number.”</p>
<p>The second mapping process then assigns a probability distribution to the random variable. By convention, lowercase letters, e.g.&nbsp;<span class="math inline">\(x\)</span>, represent actual observed outcomes. We call <span class="math inline">\(x\)</span> the <em>realization</em> of random variable <span class="math inline">\(X\)</span> and define the mapping of outcomes to probability for every <span class="math inline">\(x \in X\)</span> (read as <span class="math inline">\(x\)</span> “in” <span class="math inline">\(X\)</span> and interpret it to mean “for each possible realization of random variable <span class="math inline">\(X\)</span>”).</p>
<p>In this book, we will use <span class="math inline">\(f\)</span>, to denote a function that maps each possible realization of a random variable to its corresponding plausibilty measure and use a subscript to disambiguate which random variable is being referred to when necessary. For the coin flip example:</p>
<p><span class="math display">\[
f_X: X \rightarrow [0,1]
\]</span></p>
<p>Despite all this fancy notation, for small problems it is sometimes the best course of action to think of a random variable as a lookup table as shown here:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outcome</th>
<th>Realization (<span class="math inline">\(x\)</span>)</th>
<th><span class="math inline">\(f(x)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Heads</td>
<td>1</td>
<td>0.5</td>
</tr>
<tr class="even">
<td>Tails</td>
<td>0</td>
<td>0.5</td>
</tr>
</tbody>
</table>
<p>and where <span class="math inline">\(f(x)\)</span> can be interpreted as the plausability assigned to random variable <span class="math inline">\(X\)</span> taking on the value <span class="math inline">\(x\)</span>.</p>
<p>The Bernoulli distribution (or a Bernoulli random variable):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outcome</th>
<th>Realization (<span class="math inline">\(x\)</span>)</th>
<th><span class="math inline">\(f(x)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Success</td>
<td>1</td>
<td><span class="math inline">\(\pi\)</span></td>
</tr>
<tr class="even">
<td>Failure</td>
<td>0</td>
<td><span class="math inline">\(1-\pi\)</span></td>
</tr>
</tbody>
</table>
<p>With all of this background, we are now equipped to model uncertainty in any observable data that has two outcomes. The way we will represent this uncertainty is using two forms: 1) a graphical model and 2) a statistical model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Coin flip"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"X"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>(<span class="at">shortLabel =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-2ae4f30d7598595affc4" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-2ae4f30d7598595affc4">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Coin flip\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><span class="math display">\[
\begin{aligned}X &amp;\equiv \textrm{Coin flip outcome with heads}=1 \textrm{  and tails}=0.\\X &amp;\sim \textrm{Bernoulli}(p)\end{aligned}
\]</span></p>
<p>Instead of working with probability distributions directly as <em>mathematical</em> objects, we will most often seek a representative sample and treat them as <em>computational</em> objects (i.e.&nbsp;<strong>data</strong>). For modelling a coin flip, the representative sample might simply be a list of <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span> generated by someone flipping a coin or by a computer simulating someone flipping a coin.</p>
<p><span class="smallcaps">Turning a mathematical object into a representative sample using R</span> is quite easy as R can be used to generate random outcomes from just about all well-known probability distributions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbern</span>(<span class="dv">7</span>, <span class="at">p =</span> <span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 0 1 0 1 1 0</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe of coinflip observations</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>numFlips <span class="ot">=</span> <span class="dv">50</span> <span class="do">## flip the coin 50 times</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">flipNum =</span> <span class="dv">1</span><span class="sc">:</span>numFlips,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coinFlip =</span> <span class="fu">rbern</span>(<span class="at">n=</span>numFlips,<span class="at">prob=</span><span class="fl">0.5</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">headsProportion =</span> <span class="fu">cummean</span>(coinFlip))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot results</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> flipNum, <span class="at">y =</span> headsProportion)) <span class="sc">+</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Running Proportion of Heads"</span>) <span class="sc">+</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Flip Number"</span>) <span class="sc">+</span> </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Proportion of Heads"</span>) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><span class="math display">\[
\begin{aligned}X_i &amp;\equiv \textrm{If passenger } i \textrm{ shows up, then } X=1 \textrm{. Otherwise, } X = 0 \textrm{. Note: } i \in \{1,2,3\}.\\X_i &amp;\sim \textrm{Bernoulli}(p = 0.85)\\Y &amp;\equiv \textrm{Total number of passengers that show up.}\\Y &amp;= X_1 + X_2 + X_3\end{aligned}
\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>numFlights <span class="ot">=</span> <span class="dv">1000</span> <span class="do">## number of simulated flights</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>probShow <span class="ot">=</span> <span class="fl">0.85</span> <span class="do">## probability of passenger showing up</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># choose random seed so others can</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># replicate results</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">111</span>) </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>pass1 <span class="ot">=</span> <span class="fu">rbern</span>(<span class="at">n =</span> numFlights, <span class="at">prob =</span> probShow)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>pass2 <span class="ot">=</span> <span class="fu">rbern</span>(<span class="at">n =</span> numFlights, <span class="at">prob =</span> probShow)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>pass3 <span class="ot">=</span> <span class="fu">rbern</span>(<span class="at">n =</span> numFlights, <span class="at">prob =</span> probShow)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame (use tibble to from tidyverse) </span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>flightDF <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">simNum =</span> <span class="dv">1</span><span class="sc">:</span>numFlights,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">totalPassengers =</span> pass1 <span class="sc">+</span> pass2 <span class="sc">+</span> pass3</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># transform data to give proportion</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>propDF <span class="ot">=</span> flightDF <span class="sc">|&gt;</span> </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(totalPassengers) <span class="sc">|&gt;</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">numObserved =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">proportion =</span> numObserved <span class="sc">/</span> <span class="fu">sum</span>(numObserved))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># plot data with estimates</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(propDF, </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> totalPassengers, <span class="at">y =</span> proportion)) <span class="sc">+</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> proportion), <span class="at">nudge_y =</span> <span class="fl">0.03</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Simulation will always be your friend in the sense that if given enough time, a simulation will always give you results that approximate mathematical exactness. The only problem with this friend is it is sometimes slow to yield representative results. In these cases, sometimes mathematics provides a shortcut. The shortcut we study here is to define a probability distibution.</p>
<p><span class="math display">\[
\begin{aligned}Y &amp;\equiv \textrm{Total number of passengers that show up.}\\Y &amp;\sim \textrm{Binomial}(n = 3, p = 0.85)\end{aligned}
\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># transform data to give proportion</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>propExactDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">totalPassengers =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">proportion =</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">dbinom</span>(<span class="at">x =</span> totalPassengers,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob =</span> <span class="fl">0.85</span>))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot data with estimates</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(propExactDF, <span class="fu">aes</span>(<span class="at">x =</span> totalPassengers, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> proportion)) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> proportion), </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">nudge_y =</span> <span class="fl">0.03</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above code is both simpler and faster than the approximation code run earlier. In addition, it gives exact results. Hence, when we can take mathematical shortcuts, we will to save time and reduce the uncertainty in our results introduced by approximation error.</p>
<p>Our representation of uncertainty takes place in three worlds: 1) the real-world - we use graphical models (i.e.&nbsp;ovals) to convey the story of uncertainty, 2) the math-world - we use statistical models to rigorously define how random outcomes are generated, and 3) the computation-world - we use R functions to answer questions about exact distributions and representative samples to answer questions when the exact distribution is unobtainable.</p>
</section>
<section id="joint-distributions-tell-you-everything" class="level2">
<h2 class="anchored" data-anchor-id="joint-distributions-tell-you-everything">Joint distributions tell you everything</h2>
<p>The most complete method of reasoning about sets of random variables is by having a <em>joint probability distribution</em>. A joint probability distribution, , assigns a probability value to all possible assignments or realizations of sets of random variables. The goal of this section is to 1) introduce you to the notation of joint probability distributions and 2) convince you that if you are given a joint probability distribution, then you would be able to answer some very useful questions using probability.</p>
<section id="joint-distributions" class="level3">
<h3 class="anchored" data-anchor-id="joint-distributions">Joint distributions</h3>
</section>
<section id="marginal-distributions" class="level3">
<h3 class="anchored" data-anchor-id="marginal-distributions">Marginal distributions</h3>
</section>
<section id="conditional-distributions" class="level3">
<h3 class="anchored" data-anchor-id="conditional-distributions">Conditional distributions</h3>
</section>
<section id="limitations-of-joint-distributions" class="level3">
<h3 class="anchored" data-anchor-id="limitations-of-joint-distributions">Limitations of joint distributions</h3>
<p><span class="smallcaps">Why don’t we just use joint probability distributions all the time?</span> Despite the expressive power of having a joint probability distribution, they are not that easy to directly construct due to the <em>curse of dimensionality</em>. As the number of random variables being considered in a dataset grows, the number of potential probability assignments grows too. Even in the era of big data, this curse of dimensionality still exists.Generally speaking, an exponential increase is required in the size of the dataset as each new descriptive feature is added.</p>
<p>Let’s assume we have <span class="math inline">\(n\)</span> random variables with each having <span class="math inline">\(k\)</span> values. Thus, the joint distribution requires <span class="math inline">\(k^n\)</span> probabilites. Even if <span class="math inline">\(k=2\)</span> and <span class="math inline">\(n=34\)</span>, this leads to 17,179,869,184 possibilities (over 17 billion). To make this concrete, a typical car purchase decision might easily look at 34 different variables (e.g.&nbsp;make, model, color, style, financing, etc.). So, to model this decision would require a very large joint distribution which actually dwarfs the amount of data that is available. As a point of comparison, well under 100 million motor vehicles were sold worldwide in 2019 - i.e.&nbsp;less than one data point per possible combination of features. Despite this “curse”, we will learn to get around it with more compact representations of joint distributions. These representations will require less data, but will still yield the power to answer queries of interest; just as if we had access to the full joint distribution.</p>
</section>
</section>
<section id="graphical-models-tell-joint-distribution-stories" class="level2">
<h2 class="anchored" data-anchor-id="graphical-models-tell-joint-distribution-stories">Graphical models tell joint distribution stories</h2>
<p>Graphical models serve as compact representations of joint probability distributions.</p>
<p>It’s okay to not draw a perfect model when you are first attacking a problem.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    X[ X: It is raining ]
    Y[ Y: The curb is wet ]
    X --&gt; Y
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The diagram above is what mathematicians and computer scientists call a <em>graph</em>. To them, a <em>graph</em> is a set of related objects where the objects are called <em>nodes</em> and any pair of related nodes are known as an <em>edge</em>. For our purposes, a <em>node</em> is a visual depiction of a random variable (i.e.&nbsp;an oval) and the presence of a visible <em>edge</em> indicates a relationship between the connected random variables.</p>
<p>Our first vetting should be to ensure that nodes can be modelled as a random variable with each node representing a mapping of real-world outcomes to numerical values (see the “Representing uncertainty” section above).</p>
<p>Any variable we include in our models needs to be clearly defined and fulfill the requirements of a random variable; afterall, this is our key technique for representing the <em>real-world</em> in mathematical terms.</p>
<p>Mathematically, our goal is to have a joint distribution over the random variables of interest. Once we have that, we can answer any probability query we might have using marginal and conditional distributions (see the “Joint distributions tell you everything” section above).</p>
<p>For all but very simple models like the one above, a tabular representation of a joint distribution becomes unmanageable (computationally, cognitively, and statistically).</p>
<p>To overcome this, we use a different, more-compact structure - called a <em>Bayesian Network</em> (BN). Bayesian networks are compressed, easier-to-specify recipes for generating a full joint distribution. So, what is a BN? It is a type of <em>graph</em> (i.e.&nbsp;nodes and edges), specifically a <em>directed acyclic graph</em> (DAG), with the following requirements:</p>
<ol type="1">
<li><p>All nodes represent random variables. They are drawn using ovals. By convention, a constant is also considered a random variable.</p></li>
<li><p>All edges are pairs of random variables with a specified direction of ordering. By convention, the direction is from parent node to child node. While not always true, it is usually good to have edges reflecting a causal ordering. Edges are drawn using arrows where the tail originates from the parent and the tip points to a child.</p></li>
<li><p>Edges are uni-directional, they must only flow in one direction between any two nodes (i.e.&nbsp;<em>directed</em>).</p></li>
<li><p>The graph is <em>acyclic</em> meaning there are no cycles. In other words, if you were to put your finger on any node and trace a path following the direction of the edges, you would not be able to return to the starting node.</p></li>
<li><p>Any child node’s probability distribution will be expressed as conditional solely on its parents’ values, i.e.&nbsp;<span class="math inline">\(P(\text{child}\mid \text{parent(s)})\)</span>; this assumption is what enables more compact representations of joint distributions.</p></li>
</ol>
<p>The one edge, <span class="math inline">\(Y \rightarrow X\)</span>, means that our uncertainty in <span class="math inline">\(X\)</span> is measured using a probability function conditional on its parent - i.e.&nbsp;<span class="math inline">\(P(X|Y)\)</span>. Since there are no edges leading into <span class="math inline">\(Y\)</span>, it has no parents, its probability distribution is <span class="math inline">\(P(Y)\)</span> . With those two probabilities in place, we can recover the joint distribution, <span class="math inline">\(P(X,Y)\)</span>, based on the definition of conditional probability <span class="math inline">\(P(X,Y) = P(Y) \times P(X|Y)\)</span>.</p>
<p>If there are no edges between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, then the joint distribution is recovered via <span class="math inline">\(P(X,Y)=P(X)\cdot P(Y)\)</span>. In this case, the two random variables are independent and that is not a model structure consistent with the scenario we are exploring. If the ordering of nodes for <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are reversed such that <span class="math inline">\(Y\)</span> is the parent of <span class="math inline">\(X\)</span>, then the joint distribution would be recovered via <span class="math inline">\(P(X,Y)=P(Y)\cdot P(X\mid Y)\)</span>. This math is not consistent with the story we are trying to tell. The story is that rain causes the curb to be wet, not the other way around.</p>
<p>The general rule for a probabilistic graphical model is that its joint distribution can be factored using the chain rule formula for DAGs where <span class="math inline">\(P(X_1, X_2, \ldots, X_n) = \prod_I P(X_i|Parents(X_i))\)</span>. Hence, to model any one random variable, we only have to model its relationship to its parents instead of modelling its relationship to all of the random variables included in the model.</p>
<p>See <a href="www.youtube.com/@mathematicalmonk">mathematicalmonk</a>’s youtube video on how joint distributions are compactly represented using DAGs here: <a href="https://youtu.be/3XysEf3IQN4" class="uri">https://youtu.be/3XysEf3IQN4</a>.</p>
</section>
<section id="bayesian-inference-on-graphical-models" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-inference-on-graphical-models">Bayesian inference on graphical models</h2>
<p><em>Plausible reasoning</em> - an allocation of credibility/plausibility to all possible explanations of the observations.</p>
<p>Plausible reasoning in the math world is called Bayesian inference - a methodology for updating the credibility/plausibility of the various explanations in our mathematical representation of the world as more data becomes available.</p>
<p>Let’s walk through a hypothetical argument between two scientists as to the effect of a new drug on cognition in Alzheimer’s disease (AD).</p>
<p>Assume the two scientists have competing models for what effect the drug will have on the cognition of patients with AD:</p>
<ol type="1">
<li><p><em>The Optimist Model (Model1)</em> : This model is from a scientist who is very optimistic about the effect of the drug and argues that 70% of all patients will see at least a 5% increase in cognition.</p></li>
<li><p><em>The Pessimist Model (Model2)</em> : This model is from a scientist who is very pessimistic about the effect of the drug and argues that 20% of all patients will see at least a 5% increase in cognition.</p></li>
</ol>
<p>These two scientists recognize and respect their differing opinions - they agree to test the new drug in one patient. They hire you as a data analyst and ask you to make the decision as to whose model is more credible in light of the test’s results. Your job is to allocate credibility to the two competing models both before seeing the test results and after seeing the test results. Initially, you might not have any reason to favor one model over another, but as data is collected, your belief in whose model is more plausible/believable/credible will change. For example, if cognition decreases, then the pessimist model would seem more credible. Your task is to allocate credibility (using probability theory) to the various models/explanations, before and after the data becomes available.</p>
<section id="building-a-graphical-model-of-the-real-world" class="level3">
<h3 class="anchored" data-anchor-id="building-a-graphical-model-of-the-real-world">Building a graphical model of the real-world</h3>
<p>The first step is to create a graphical model/representation of the real world.</p>
<p>Starting simple, <em>let’s only imagine that we test the drug in one patient</em> and our single data point (i.e.&nbsp;whether cognition increases by at least 5% or not) follows a Bernoulli distribution.</p>
<p>The graphical model is simply:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Cognition increases"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"X"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>(<span class="at">shortLabel =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-f25ab85bf888dc624719" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-f25ab85bf888dc624719">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>And, the statistical model with the mathematical details is represented like this:</p>
<p><span class="math display">\[
\begin{aligned}X \equiv&amp; \textrm{ Cognition increases: } \\        &amp; \textrm{ If cognition increases more than 5}\% \textrm{, then }X=1 \textrm{ otherwise, }X=0.\\X \sim  &amp; \textrm{ Bernoulli}(\theta)\\\end{aligned}
\]</span></p>
<p>We have seen this model before when representing coin flips. Our data is analogous to heads or tails of a coin flip. The data will be reduced to a zero or one for each patient. If given <span class="math inline">\(\theta\)</span>, we could generate data using <code>rbern(n=1, prob=theta)</code>, but, we do not know <span class="math inline">\(\theta\)</span>; the reason we are looking at data is to answer the question: “what is <span class="math inline">\(\theta\)</span>?”</p>
<p>From the story above, <span class="math inline">\(\theta\)</span> can only take on two values. In the optimistic model <span class="math inline">\(\theta = 70\%\)</span> and in the pessimistic model <span class="math inline">\(\theta = 20\%\)</span>. So, we have two models of the world and are uncertain as to which one is more plausible. Without data, we have no reason to believe one scientist over another, so <span class="math inline">\(P(\theta=70\%)=50\%\)</span> and <span class="math inline">\(P(\theta=20\%)=50\%\)</span> - i.e.&nbsp;each scientist is equally likely to be correct. This is just like saying <span class="math inline">\(P(\text{model1})=P(\text{model2})=50\%\)</span>. Before any data is considered, this allocation of credibility assigning probability to all the models being considered is called the <em>prior</em>. The prior is the initial probability allocated among all the possible models.</p>
<p>See <a href="https://youtu.be/nCRTuwCdmP0" class="uri">https://youtu.be/nCRTuwCdmP0</a> for gaining some intuition about prior probabilities.</p>
<p>So now, we can more completely specify our data story using both a graphical and a statistical model with specified prior probabilities. The graphical model is now two ovals representing our uncertainty in the probability of success and the observed cognition increase (random variable math-labels for <span class="math inline">\(\Theta\)</span> and <span class="math inline">\(X\)</span> are included for extra clarity in connecting the graphical model and the statistical model):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Cognition increases"</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"X"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Success probability"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Θ"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">child =</span> <span class="st">"X"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-06a988fdd2a34d502a66" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-06a988fdd2a34d502a66">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases\nX\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success probability\nΘ\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>And, the statistical model is represented like this:</p>
<p><span class="math display">\[
\begin{aligned}
X \equiv&amp; \textrm{ Cognition increases: } \\
        &amp; \textrm{ If cognition increases more than 5} \% \textrm{, then }X=1 \textrm{ otherwise, }X=0.\\
X \sim  &amp; \textrm{ Bernoulli}(\theta)\\
\Theta \equiv&amp; \textrm{ Success probability: } \\
\end{aligned}
\]</span> <span class="math display">\[
\Theta \sim
\begin{array}{ccc}
  \textrm{Outcome } &amp; \textrm{ Realization }(\theta) &amp; f(\theta) \\
  \hline
  \textrm{Model1}  &amp; \textrm{   70}\% &amp; \textrm{  50}\% \\
  \textrm{Model2}  &amp; \textrm{   20}\% &amp; \textrm{  50}\% \\
\end{array}
\]</span></p>
<p>where the prior probability distribution for <span class="math inline">\(\Theta\)</span> is given in tabular form.</p>
<p>The graphical model and statistical model are two different ways of representing the same story. The graphical model is more visual and intuitive, while the statistical model is more precise and mathematical. Both are useful for different purposes, but both represents a generative model, i.e., a recipe for simulating real-world data observations. In this case, following the top-down flow of the graphical model, the recipe is:</p>
<ol type="1">
<li>Simulate a potential success probability by randomly picking, with equal probability, either the optimist or pessimist model.</li>
<li>Simulate a drug’s success by using the probability from (1) and generating a Bernoulli random variable with that probability of success.</li>
</ol>
<p>We can easily show how to simulate an observation by writing code for the recipe in R:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Simulate a potential success probability</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.2</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Simulate a drug's success</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rbern</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">prob =</span> theta)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>theta</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Much of your subsequent work will use this notion of generative models as recipes. You will 1) <em>create generative models</em> that serve as skeleton recipes - recipes with named probability distributions and <strong>unknown</strong> parameters - for how real-world data arises, and 2) <em>inform models with data</em> by reallocating plausibility to the recipe parameters that are most consistent with the data.</p>
<p>A guiding principle for creating good generative models is that the generated data should mimic data that you, as a data analyst, believe is plausible. If the generative model outputs implausible data in high frequency, then your model is not capturing the essence of the underlying data story; your modelling assumptions will need work. When the generative model seems correct in the absence of data, then data can feed the updating process which sensibly reallocates prior probability so that model parameters that tend to generate data similar to the observed data are deemed more plausible.</p>
</section>
<section id="from-model-to-joint-distribution" class="level3">
<h3 class="anchored" data-anchor-id="from-model-to-joint-distribution">From model to joint distribution</h3>
<p>The graphical model shows that we have uncertainty about two related random variables: 1) <em>Success Probability</em> (<span class="math inline">\(\Theta\)</span>) <em>Cognition Increases</em> (<span class="math inline">\(X\)</span>). Our assumption - built into our prior - is that one of our two models, <span class="math inline">\(\theta = 20\%\)</span> or <span class="math inline">\(\theta = 70\%\)</span>, is correct.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This implicit assumption that one of the considered generative models is correct is sometimes referred to as the <em>small world</em> assumption. See this comparison by Richard McElreath of <em>small world</em> versus <em>large world</em> highlighting the implications of this assumption: <a href="https://youtu.be/WFv2vS8ESkk" class="uri">https://youtu.be/WFv2vS8ESkk</a>.</p>
</div>
</div>
<p>We are also confident about what collecting data from one patient might yield: either a single <em>success</em> or a single <em>failure</em> in terms of the cognition increase. Prior to collecting data, there are four combinations of model and data that are potential truths. Each combination’s prior plausibility, represented by <span class="math inline">\(a\%\)</span>, <span class="math inline">\(b\%\)</span>, <span class="math inline">\(c\%\)</span> and <span class="math inline">\(d\%\)</span>, are elements of the table:</p>
<p><span class="math display">\[
\begin{array}{cc|cc}         &amp;                  &amp; \textrm{  Possible}                &amp; \textrm{Models  }                  \\         &amp;                  &amp; \theta = 70\% &amp; \theta = 20\% \\         \hline\textrm{Possible} &amp; \textit{Success} &amp; a\%   &amp; b\%                     \\\textrm{Data}     &amp; \textit{Failure} &amp; c\%   &amp; d\%\end{array}
\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate many samples from the generative model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>, <span class="cf">function</span>(x) { theta <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.2</span>), <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)); x <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="at">size=</span><span class="dv">1</span>, <span class="at">n=</span><span class="dv">1</span>, <span class="at">prob=</span>theta); <span class="fu">tibble</span>(theta, x) }) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(samples)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">x</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate joint probability distribution before seeing the data, and the marginal of theta (prior)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>joint <span class="ot">&lt;-</span> samples <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(theta, x) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">count =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> count <span class="sc">/</span> <span class="fu">sum</span>(count))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>joint</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">x</th>
<th style="text-align: right;">count</th>
<th style="text-align: right;">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4000</td>
<td style="text-align: right;">0.4000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1025</td>
<td style="text-align: right;">0.1025</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1536</td>
<td style="text-align: right;">0.1536</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3439</td>
<td style="text-align: right;">0.3439</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>joint <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(theta) <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">prior =</span> <span class="fu">sum</span>(p))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">prior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0.5025</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0.4975</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tally</span>(<span class="sc">~</span> x <span class="sc">+</span> theta, <span class="at">data =</span> samples, <span class="at">format =</span> <span class="st">'proportion'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   theta
x      0.2    0.7
  0 0.4000 0.1536
  1 0.1025 0.3439</code></pre>
</div>
</div>
</section>
<section id="bayesian-updating-of-the-joint-distribution" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-updating-of-the-joint-distribution">Bayesian updating of the joint distribution</h3>
<p><span class="math display">\[
P(Model | Data) = \frac{P(Data|Model) \times P(Model)}{P(Data)}
\]</span></p>
<p>The above formula is called <em>Bayes’ Theorem</em> and it is the mathematical engine that drives Bayesian inference. It is a simple formula, but it is very powerful. It tells us how to update our beliefs about the plausibility of various models in light of new data. The formula has four components:</p>
<ol type="1">
<li><span class="math inline">\(P(Model | Data)\)</span>: This is the <em>posterior</em> probability of the model given the data. It is what we are trying to compute. It tells us how plausible each model is after seeing the data.</li>
<li><span class="math inline">\(P(Data|Model)\)</span>: This is the <em>likelihood</em> of the data given the model. It tells us how likely the observed data is under each model.</li>
<li><span class="math inline">\(P(Model)\)</span>: This is the <em>prior</em> probability of the model.</li>
<li><span class="math inline">\(P(Data)\)</span>: This is the <em>marginal likelihood</em> of the data. It is a normalizing constant that ensures the posterior probabilities sum to one.</li>
</ol>
<p>To use Bayes’ Theorem, we need to compute the likelihood of the data under each model. This is done using the probability distributions defined in our statistical model.</p>
<p>Assume we observe a success, i.e.&nbsp;the patient’s cognition increases by at least 5%. The likelihood of this data under each model is:</p>
<ul>
<li>Under Model1 (<span class="math inline">\(\theta = 70\%\)</span>): <span class="math inline">\(P(X=1|\theta=70\%) = 0.7\)</span></li>
<li>Under Model2 (<span class="math inline">\(\theta = 20\%\)</span>): <span class="math inline">\(P(X=1|\theta=20\%) = 0.2\)</span></li>
</ul>
<p>The marginal likelihood of the data is computed by summing the likelihoods weighted by the prior probabilities:</p>
<p><span class="math display">\[
P(Data) = P(X=1) = P(X=1|\theta=70\%) \times P(\theta=70\%) + P(X=1|\theta=20\%) \times P(\theta=20\%) = 0.7 \times 0.5 + 0.2 \times 0.5 = 0.45
\]</span> Now, we can plug these values into Bayes’ Theorem to compute the posterior probabilities:</p>
<ul>
<li>For Model1 (<span class="math inline">\(\theta = 70\%\)</span>):</li>
</ul>
<p><span class="math display">\[
P(\theta=70\%|X=1) = \frac{P(X=1|\theta=70\%) \times P(\theta=70\%)}{P(X=1)} = \frac{0.7 \times 0.5}{0.45} \approx 0.778
\]</span></p>
<ul>
<li>For Model2 (<span class="math inline">\(\theta = 20\%\)</span>):</li>
</ul>
<p><span class="math display">\[
P(\theta=20\%|X=1) = \frac{P(X=1|\theta=20\%) \times P(\theta=20\%)}{P(X=1)} = \frac{0.2 \times 0.5}{0.45} \approx 0.222
\]</span></p>
<p>So, after observing a success, the posterior probabilities are approximately 77.8% for Model1 and 22.2% for Model2. This means that after seeing the data, we believe that Model1 is more plausible than Model2.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate joint probability distribution after seeing the data (x=1), and the marginal of theta (posterior)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>joint <span class="ot">&lt;-</span> samples <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(theta, x) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">count =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> count <span class="sc">/</span> <span class="fu">sum</span>(count))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>joint</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">x</th>
<th style="text-align: right;">count</th>
<th style="text-align: right;">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1025</td>
<td style="text-align: right;">0.2296</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3439</td>
<td style="text-align: right;">0.7704</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>joint <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(theta) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">prior =</span> <span class="fu">sum</span>(p))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">prior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0.2296</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0.7704</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="generative-dags-as-scientific-and-statistical-models" class="level2">
<h2 class="anchored" data-anchor-id="generative-dags-as-scientific-and-statistical-models">Generative DAGs as scientific and statistical models</h2>
<p>Up to this point, we specified a prior joint distribution using information from both a graphical model and a statistical model. In this section, we combine the two model types, graphical models and statistical models, into one visualization called the generative DAG.</p>
<p>The advantage of this is that the generative DAG unites real-world measurements (e.g.&nbsp;cognition increases) with their math/computation world counterparts (e.g.&nbsp;<span class="math inline">\(X \sim \textrm{Bernoulli}(\theta)\)</span>) without requiring the cognitive load of flipping back-and-forth between the graphical and statistical models.</p>
<p>Moreover, generative DAGs, when combined with data, enable Bayesian inference to be automated (yay! no more manual calculations using Bayes rule).</p>
<section id="generative-dags" class="level3">
<h3 class="anchored" data-anchor-id="generative-dags">Generative DAGs</h3>
<p>To build a generative DAG, we combine a graphical model with a <em>statistical model</em> into a single unifying representation.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A statistical model is a mathematically expressed recipe for creating a joint distribution of related random variables. Each variable is defined either using a probability distribution or a function of the other variables. Statistical model and generative DAG will be used interchangeably. The term statistical model is just the mathematically expressed recipe. Generative DAG is the graphically expressed recipe with an embedded statistical model.</p>
</div>
</div>
<p>The objective in building generative DAGs is to capture how we might go about simulating real-world measurements using the mathematical language we’ve been learning. Good generative DAGs are recipes for simulating a real-world observation in a way that reflects our domain knowledge. Then, with a generative DAG and some actual data, we will ask the computer to do Bayesian inference for us and to output an updated joint distribution of the random variables in our DAG.</p>
<p>The creation of a generative DAG mimics the creation of graphical models with accompanying statistical models. Both the structure of the DAG and the definition of the random variables should reflect what a domain expert knows, or wants to assume, about the data generating process being investigated.</p>
<p>Here is the generative DAG for the scenario described before. We have seen some elements of this DAG before. For example, the <em>Cognition increase</em>s <span class="math inline">\(X\)</span> node, whose prominent feature is that it can only take on two-values, <em>yes</em> or <em>no</em>. We model these binary-valued real-world outcomes with the probabilistic mapping (Bernoulli PMF) <span class="math inline">\(x \sim \textrm{Bernoulli}(\theta)\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Cognition increases"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta)) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Success probability"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">child =</span> <span class="st">"x"</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-744b8e1fe96c0688a849" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-744b8e1fe96c0688a849">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Other elements of the DAG are new. Notice, <code>theta</code> is now spelled out phonetically as opposed to using the actual Greek letter math symbol of <span class="math inline">\(\theta\)</span>. While this need not be done when drawing a generative DAG by hand, we phonetically spell out the Greek letter <span class="math inline">\(\theta\)</span> as <code>theta</code> here because computer code and computer-generated DAG visuals lack easy support for the Greek alphabet. Additionally, and more importantly, we switch to using lowercase notation for both <code>x</code> and <code>theta</code> as we want to highlight that ovals in generative DAG models represent a single realization of the random variable. Later we will introduce the representation of more than one realization.</p>
</section>
<section id="building-generative-models" class="level3">
<h3 class="anchored" data-anchor-id="building-generative-models">Building generative models</h3>
<p>As we build these generative DAGs, it is often easiest to build and read them from bottom to top; start by converting your target measurement, in this case whether the cognition of patients with AD increases after treatment with a new drug, to a brief real-world description (e.g.&nbsp;<em>Cognition increases</em>). This description is the top-line of the oval. For rigor, a more formal definition should be stored outside of the generative DAG in a simple text document that can be referenced by others.</p>
<p>Every node will also have a mathematical line (e.g.&nbsp;<span class="math inline">\(x \sim \textrm{Bernoulli}(theta)\)</span>). The mathematical line will always follow a three-part structure of 1) Left-hand side, 2) Relationship Type, and 3) Right-hand side:</p>
<p>Each line of a statistical model follows one of two forms: or</p>
<ul>
<li><p><strong>Left-hand side (LHS)</strong>: a mathematical label for a realization of the node (e.g.&nbsp;<span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span> or whatever symbol/word you choose). The purpose of the label is to have a very short way of referring to a node. To that end, you cannot include spaces in this label and try to keep it at five letters or less.</p></li>
<li><p><strong>Relationship Type</strong>: There are two types of relationships that can be specified:</p></li>
</ul>
<ol type="1">
<li><p>a <em>probabilistic</em> relationship, denoted by the <span class="math inline">\(\sim\)</span> symbol, where the LHS node’s value is determined with some uncertainty/randomness as a function of its inputs, such as the outcome of a coin flip. <span class="math inline">\(LHS \sim \textrm{Probability mass/density function}\)</span> Or,</p></li>
<li><p>a <em>deterministic</em> relationship denoted by an <span class="math inline">\(=\)</span> symbol. A deterministic relationship means the LHS node’s value is determined with zero uncertainty as a function of its inputs. <span class="math inline">\(LHS \sim \textrm{Deterministic function}\)</span></p></li>
</ol>
<ul>
<li><strong>Right-hand side (RHS)</strong>: either a known probability distribution (i.e., probability mass or density function) governing the node’s random outcome (e.g.&nbsp;<span class="math inline">\(\textrm{Bernoulli}(\theta)\)</span>) or a deterministic mathematical function defining the node’s value (e.g.&nbsp;<span class="math inline">\(x + y\)</span> ). In both cases, any parameters/variables/inputs in the RHS must be represented by a parent node to the current node in your model.</li>
</ul>
<p>To model subsequent nodes, consider any parameters or variables on the right-hand side of the mathematical lines that remain undefined; all of these undefined parameters must be defined on the LHS of a parent node. Hence, for <span class="math inline">\(x \sim \textrm{Bernoulli}(theta)\)</span>, <span class="math inline">\(\theta\)</span> should be (and is) the LHS of a parent node of <span class="math inline">\(x\)</span>.</p>
<p>Now to have a complete statistical model, we need a recipe for how all the random variables of interest can be generated. Previously, when doing Bayes rule calculations by hand, we considered a recipe for with only two possible values. However, as we move towards using the computer to do Bayesian inference for us, we now consider all of the possibilities - any value between 0 and 1.</p>
<p>The generative DAG above introduces us to the uniform distribution. The <span class="math inline">\(\textrm{uniform}(a, b)\)</span> distribution is a two-parameter probability distribution with the property that all real numbers between <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are generated with equal probability. Hence, for our application where represents a probability restricted to be between 0 and 1, we use <span class="math inline">\(\textrm{uniform}(0, 1)\)</span> to represent our consideration of the infinite possible values of success probability ranging from 0% to 100%.</p>
<p>Since all nodes/variables (<span class="math inline">\(x\)</span> and <span class="math inline">\(\theta\)</span>) have a mathematical line, and all RHS parameters/variables are defined, the DAG above represents a generative model. The top line of each oval is a meaningful real-world description of the random variable and the bottom line gives the math.</p>
<p>Notice that the generative DAG is a recipe for simulating or generating a single sample/realization from the joint distribution - read it from top-to-bottom: 1) first, simulate a random sample value of <span class="math inline">\(\theta\)</span>, say the realization is 10%, and then 2) use that sample value to simulate <span class="math inline">\(x\)</span>, which assuming <span class="math inline">\(\theta = 10\%\)</span>, is either 0 with 90% probability or 1 with 10% probability.</p>
<p>For illustrating the simulation aspect of a generative DAG, we can use simple R functions to get a joint realization of the two variables. We model <span class="math inline">\(\theta\)</span> as <span class="math inline">\(\textrm{uniform}(0, 1)\)</span> and <span class="math inline">\(x\)</span> as <span class="math inline">\(\textrm{bernoulli}(\theta)\)</span> computationally using the functions <code>runif</code> and <code>rbern</code> (i.e.&nbsp;<code>rfoo</code> for the uniform distribution and Bernoulli distribution, respectively). Hence, a random sample from the joint distribution of <span class="math inline">\(\Theta\)</span> and <span class="math inline">\(X\)</span> can be generated with the following code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># generate random theta: n is # of samples we want</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">=</span> <span class="fu">runif</span>(<span class="at">n=</span><span class="dv">1</span>,<span class="at">min=</span><span class="dv">0</span>,<span class="at">max=</span><span class="dv">1</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>theta <span class="co"># print value</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1137</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate random X</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rbern</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">prob =</span> theta)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>x <span class="co"># print value</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>For the particular model above, the recipe picked a random <span class="math inline">\(\theta\)</span> of 11.4% and then, using that small probability of success, generated a random <span class="math inline">\(x\)</span> with 11.4% chance of giving a one. Unsurprisingly, the random sample from <span class="math inline">\(x\)</span> was zero.</p>
<p>A generative models is a mathematical abstraction of a real-world data generating process (DGP); they represent, in the formal language of probability theory, our knowledge of the DGP. We will use these abstractions and Bayesian inference to combine prior information in the form of a generative DAG with observed data. The combination will yield us a posterior distribution; a joint distribution over our RV’s of interest that we can use to answer questions and generate insight. For most generative DAGs, Bayes rule is not analytically tractable (i.e.&nbsp;it can’t be reduced to simple math), and we need to define a computational model using a probabilistic programming language.</p>
</section>
<section id="representing-observed-data-with-fill-and-a-plate" class="level3">
<h3 class="anchored" data-anchor-id="representing-observed-data-with-fill-and-a-plate">Representing observed data with fill and a plate</h3>
<p>A generative DAG represents a family of recipes (i.e., hypothesis space, where each hypothesis/recipe is indexed by a parameter value or combination of parameter values) for simulating one real-world observation. We can then use data to inform us about which of the recipes seem more consistent with the data. For example, we know that observing cognition increase not in one but three patients with AD after drug treatment would be less consistent with the recipe based on the pessimist model <span class="math inline">\(\theta = 20\%\)</span> and more consistent with the recipe based on the optimist model <span class="math inline">\(\theta = 70\%\)</span>. Thus, reallocating plausibility in light of this type of data becomes a milestone during our data analysis.</p>
<p>In the generative DAG above, the reallocation of probability in light of the data will be done in such a way as to give more plausibility to <span class="math inline">\(\theta\)</span> values consistent with the observations and less plausibility to the other <span class="math inline">\(\theta\)</span> values.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Cognition increases"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> <span class="cn">TRUE</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Success probability"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">child =</span> <span class="st">"x"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-169abb3486349adfa5d8" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-169abb3486349adfa5d8">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Cognition increases"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Observation"</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"i"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">nodeLabels =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">descr =</span> <span class="st">"Success probability"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">child =</span> <span class="st">"x"</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-21dc44474b3e8cd160f8" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-21dc44474b3e8cd160f8">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Success probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i\"\n  \"1\" [label = \"Cognition increases\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In the generative DAG above, there are some additional elements. <em>Observed</em> data - in contrast to latent parameters/variables or unobserved data - gets represented by using fill shading of the ovals (e.g.&nbsp;the darker fill of <em>Cognition increases</em>). Also, rectangles called <em>plates</em> are used to indicate repetition of the enclosed random variable (or group/subgraph of random variables). In this case, the plate indicates we have observed multiple [modeled as independent in the corresponding statistical model] outcomes/realizations of <span class="math inline">\(x\)</span> from treating more than one patient with the drug.</p>
<p>Text in the lower right-hand corner of the plate indicates how variables inside the plate are repeated and indexed. In this case, there will be one realization of <span class="math inline">\(x\)</span> for each observation. The letter <span class="math inline">\(i\)</span> represents a short-hand label used to index the observations. For example, <code>x[i]</code> is the <span class="math inline">\(i^{\text{th}}\)</span> observation of <code>x</code> and therefore, <code>x[2]</code> would the <span class="math inline">\(2^{\text{nd}}\)</span> observation of <code>x</code>. The <code>[3]</code> in the lower-right hand corner represents the number of repetitions of the RV, in this case there are 3 observations of stores: <code>x[1]</code>, <code>x[2]</code>, and <code>x[3]</code>.</p>
<p>Since the <span class="math inline">\(\theta\)</span> node lacks a plate, the generative recipe implied by this generative DAG calls for just one realization of <span class="math inline">\(\theta\)</span> to be used in generating all 3 observations of <span class="math inline">\(x\)</span>. In other words, our recipe assumes there is just one “true” <span class="math inline">\(\theta\)</span> value and all observations are Bernoulli trials with the same <span class="math inline">\(\theta\)</span> value. The question we will soon answer computationally is “how to reallocate our plausibility among all possible”true” values of <span class="math inline">\(\theta\)</span> given that we have observed 3 observations of <span class="math inline">\(x\)</span>?”</p>
<p>More rigorous mathematical notation and definitions can be found in the lucid recommendations of Michael Betancourt. See his work <em>Towards a Principled Bayesian Workflow (Rstan)</em> for a more in-depth treatment of how generative models and prior distributions are only models of real-world processes. <a href="https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html" class="uri">https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html</a>. Additionally, Betancourt’s <em>Generative Modelling</em> (<a href="https://betanalpha.github.io/assets/case_studies/generative_modeling.html" class="uri">https://betanalpha.github.io/assets/case_studies/generative_modeling.html</a>) is excellent in explaining how models with narrative interpretations tell a set of stories on how data are generated. For us, we will combine our generative DAGs with observed data to refine our beliefs about which stories (i.e.&nbsp;which parameters) seem more plausible than others.</p>
</section>
</section>
<section id="computational-bayesian-inference-workflows" class="level2">
<h2 class="anchored" data-anchor-id="computational-bayesian-inference-workflows">Computational Bayesian inference workflows</h2>
<p>This section illustrates how to use the <code>causact</code> package to specify and run computational Bayesian inference workflows. The package is an easy-to-use, intuitive, and visual interface to <code>numpyro</code>. In fact, it automates the creation of <code>numpyro</code> code based on a user creating a generative DAG. <code>causact</code> advocates and enables generative DAGs to serve as a business analytics workflow (BAW) platform upon which to launch business discussions, create statistical models, and automate computational Bayesian inference.</p>
<section id="getting-started-with-dag_foo-functions" class="level3">
<h3 class="anchored" data-anchor-id="getting-started-with-dag_foo-functions">Getting started with <code>dag_foo()</code> functions</h3>
<p>In the code below, the two lines beginning with <code>dag_</code> output R list objects consisting of six data frames. Let’s not worry too much about the details, but notice that one of the data frames is for storing node information (i.e.&nbsp;<code>nodesDF</code>) and one for edge information (i.e.&nbsp;<code>edgesDF</code>).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## returns a list of data frames to store DAG info</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$nodes_df
 [1] id         label      descr      data       rhs        child     
 [7] obs        rhsID      distr      auto_label auto_descr auto_data 
[13] dimID      auto_rhs  
&lt;0 rows&gt; (or 0-length row.names)

$edges_df
[1] id   from to   type
&lt;0 rows&gt; (or 0-length row.names)

$arg_df
[1] rhsID        argName      argType      argValue     argDimLabels
&lt;0 rows&gt; (or 0-length row.names)

$plate_index_df
[1] indexID          indexLabel       indexDescription indexDisplayName
[5] dataNode         rhs             
&lt;0 rows&gt; (or 0-length row.names)

$plate_node_df
[1] indexID nodeID 
&lt;0 rows&gt; (or 0-length row.names)

$dim_df
[1] dimID         nodeID        dimType       dimDataSource dimValue     
&lt;0 rows&gt; (or 0-length row.names)

attr(,"class")
[1] "causact_graph"</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## adds a node to the list with given description</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span> <span class="fu">dag_node</span>(<span class="st">"BernoulliRV"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$nodes_df
  id label       descr data  rhs child   obs rhsID distr auto_label  auto_descr
1  1  &lt;NA&gt; BernoulliRV &lt;NA&gt; &lt;NA&gt;    NA FALSE    NA FALSE       BrRV BernoulliRV
  auto_data dimID auto_rhs   dec   det
1      &lt;NA&gt;    NA     &lt;NA&gt; FALSE FALSE

$edges_df
[1] id   from to   type
&lt;0 rows&gt; (or 0-length row.names)

$arg_df
[1] rhsID        argName      argType      argValue     argDimLabels
&lt;0 rows&gt; (or 0-length row.names)

$plate_index_df
[1] indexID          indexLabel       indexDescription indexDisplayName
[5] dataNode         rhs             
&lt;0 rows&gt; (or 0-length row.names)

$plate_node_df
[1] indexID nodeID 
&lt;0 rows&gt; (or 0-length row.names)

$dim_df
[1] dimID         nodeID        dimType       dimDataSource dimValue     
&lt;0 rows&gt; (or 0-length row.names)

attr(,"class")
[1] "causact_graph"</code></pre>
</div>
</div>
<p>The function dag_create() is used to create an empty list object that we will refer to as a <em>causact_graph</em>. Subsequently functions like <code>dag_node()</code> and <code>dag_edge()</code> will take a <em>causact_graph</em> object as input, modify them, and provide a <em>causact_graph</em> object as output. This feature allows for the chaining (i.e.&nbsp;using <code>|&gt;</code>) of these functions to build up your observational model. Once done building with <code>dag_create()</code>, <code>dag_node()</code>, and <code>dag_edge()</code>, a call to the <code>dag_render()</code> function outputs a visual depiction of your <em>causact graph</em>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"BernoulliRV"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()   <span class="do">## visualize graph</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-5a982514ce28ae593bde" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-5a982514ce28ae593bde">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"BernoulliRV\nBrRV\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="four-steps-to-creating-graphical-models" class="level3">
<h3 class="anchored" data-anchor-id="four-steps-to-creating-graphical-models">Four steps to creating graphical models</h3>
<p>Let’s use the <code>dag_foo()</code> functions to make a generative DAG with Bernoulli data, a uniform prior, and some observed data:</p>
<p><span class="math display">\[
\begin{aligned}X &amp;\sim \textrm{Bernoulli}(\theta) \\\theta &amp;\sim \textrm{uniform}(0,1)\end{aligned}
\]</span></p>
<p>Assume two successes and one failure such that:</p>
<p><span class="math display">\[
x_1 = 1, x_2 = 1, x_3 = 0
\]</span></p>
<p>The following code uses the <code>descr</code> and <code>label</code> arguments of the <code>dag_node()</code> function to, respectively, provide a long label for your random variable that is easily understood by business stakeholders and a short label that is more for notational/mathematical convenience:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span>  <span class="co"># just get one node to show</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, <span class="at">label =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-0f735d05eac75555269e" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-0f735d05eac75555269e">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Since, we actually observe this node as data, we use the <code>data</code> argument of the <code>dag_node()</code> function to specify the observed values:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span>  <span class="co"># make it an observed node by adding data</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, <span class="at">label =</span> <span class="st">"x"</span>, </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-efd07531f021030c44f5" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-efd07531f021030c44f5">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases [3]\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The node’s darker fill is automated because of the supplied observed data and the <code>[3]</code> means there are three observed realizations in the supplied data vector. You could also use a plate to represent the multiple realizations, but I recommend plate creation to be the last step in creating generative DAGs via the <code>causact</code> package.</p>
<p>One goal we often have is to take a sample of data and find plausible parameters within a distribution family (e.g.&nbsp;normal, gamma, etc.) governing how that data might have been generated - at its core, Bayesian inference is a search for plausible parameters of a specified generative DAG. To specify the distribution family governing the observed data, use the <code>rhs</code> argument of the <code>dag_node()</code> function.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>rhs</code> stands for right-hand side. The <code>rhs</code> of a node is reserved for indicating how the node is generated as a function of its parent nodes’ values. Alternatively, when not used as a distribution specification, the <code>rhs</code> is an algebraic expression or other function of data converting parent node values into a realization of the node’s value.</p>
</div>
</div>
<p>There is an implicit assumption that all unknown variables will eventually be defined by parent nodes - the <code>causact</code> package will not check for this. In the case below, we are specifying a parameter <code>theta</code> that will need to eventually be added as a parent node.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span>  <span class="co"># specify data generating distribution</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, <span class="at">label =</span> <span class="st">"x"</span>, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),  <span class="do">##add distribution </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-7ef2983315589fed18d6" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-7ef2983315589fed18d6">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases [3]\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Note, a random variable’s distribution must be part of <code>causact</code>. The full list of <code>causact</code> distributions can be found by running the following line:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>?causact<span class="sc">::</span>distributions</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For each unknown argument remaining on the <code>rhs</code> of any nodes in your causact graph, one must eventually All unknown rhs arguments for nodes must be defined prior to running any Bayesain computations.define how the unknown argument can be generated. In our data node above, the only unknown argument on the <code>rhs</code> is <code>theta</code>. We define the generative model for <code>theta</code> by making an additional node representing its value:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span>  </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta), <span class="co"># no quotation marks</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Success probability"</span>, </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"theta"</span>,  <span class="co"># labels needs quotes</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-22a76f1d8b9e786d9d3f" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-22a76f1d8b9e786d9d3f">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases [3]\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Notice, the parameters of the <code>rhs</code> distribution for <code>theta</code> are not unknown - they are actually constants (i.e.&nbsp;0 and 1) and hence, no additional parent nodes are required to be created. Take note that <code>theta</code> on the <code>rhs</code> for the <em>Cognition increases</em> node does not require quotes as it refers to an R object; specifically, this refers to the R object created by:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Success probability"</span>, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">label =</span> <span class="st">"theta"</span>,  <span class="co"># label needs quotes</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>where the <code>theta</code> object is given its name by the <code>label = "theta"</code> argument; when creating node labels via this argument, quotes are typically required.</p>
<p>Without a link between <code>theta</code> and <code>x</code>, one is not creating a properly factorizable directed acyclic graph as is required for specifying a joint distribution. Using the <code>child</code> argument of <code>dag_node</code>, one can now create the required link between <code>theta</code> as a parent node and <code>theta</code> as an argument to the distribution of its child node <code>x</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span>  <span class="co"># connect parent to child</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Success probability"</span>, <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span>  <span class="do">## ADDED LINE TO CREATE EDGE</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-e28ddcdfc64296f5794e" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-e28ddcdfc64296f5794e">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Cognition increases [3]\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using the child argument, please ensure the child was previously defined as a node. Generative DAGs are designed to be built from bottom-to-top reflecting the way a business analyst would create these DAGs. Note that computer code for Bayesian inference, like numpyro code, requires the exact opposite order - parent nodes get defined prior to their children. One way the causact package accelerates the BAW is by facilitating a bottom-up workflow that can be automatically translated to top-down computer code.</p>
</div>
</div>
<p>For more complicated modelling, repeat this process of adding parent nodes until there are no uncertain parameters on the right hand side of the top nodes.</p>
</section>
<section id="running-bayesian-inference-on-a-generative-dag" class="level3">
<h3 class="anchored" data-anchor-id="running-bayesian-inference-on-a-generative-dag">Running Bayesian inference on a generative DAG</h3>
<p>Now we use <code>dag_numpyro()</code> function to get a posterior distribution based solely on the <code>causact_graph</code> that we just made. A call to <code>dag_numpyro()</code> expects a <code>causact_graph</code> as the first argument, so make sure you are not passing the output of the <code>dag_render()</code> function by mistake. Use <code>dag_render()</code> to get a picture and <code>dag_numpyro()</code> for Bayesian inference - just do not mix them in the same chain of functions. The second argument of <code>dag_numpyro()</code> is the <code>mcmc</code> argument and its default value is <code>TRUE</code>. When <code>mcmc = FALSE</code>, <code>dag_numpyro(mcmc = FALSE)</code> gives a print-out of the <code>numpyro</code> code that would be run by <code>causact</code> to get a posterior without running the code. You can cut and paste this code into a new R-script if you wish and run it there (ESPECIALLY USEFUL FOR DEBUGGING WHEN YOU GET AN ERROR AT THIS STAGE). Alternatively and preferably, the <code>numpyro</code> code should run automatically in the background by setting <code>mcmc = TRUE</code> or simply omitting this argument because it is the default value. Usage is shown below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># running Bayesian inference</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remove dag_render() and save graph object</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Cognition increases"</span>, </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Success probability"</span>, </span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co"># pass graph to dag_numpyro</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>After some time, during which <code>numpyro</code> computes our posterior Bayesian distribution, we get that distribution as representative sample in an object I typically name <code>drawsDF</code> - a data frame of posterior draws that is now useful for computation and plotting. For a quick visual-check that all went well, pass the <code>drawsDF</code> data frame to the <code>dagp_plot()</code> function to get a quick look at the credible (posterior) values of <code>theta</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()  <span class="co"># eyeball P(theta&gt;0.65)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>the lighter fill indicates a 90% percentile interval where 5% of plausible values are excluded from the left- and right-sides of the colored interval. Consider this range your credilble values for <code>theta</code>; hence, our posterior belief is that <code>theta</code> is somewhere in the 27% to 90% range. The darker fill within the colored interval indicates a 10% percentile interval; hence, the most likely values of <code>theta</code> are centered around 60%. For more customized graphs, please use <code>bayesplot</code> or <code>ggplot2</code> with <code>ggdist</code> with <code>drawsDF</code> as the input data.</p>
</section>
<section id="investigating-the-posterior-distribution" class="level3">
<h3 class="anchored" data-anchor-id="investigating-the-posterior-distribution">Investigating the posterior distribution</h3>
<p>The object we named <code>drawsDF</code> is our posterior distribution after <code>numpyro</code> automated Bayes rule for us. The posterior distribution is expressed as a representative sample of all unobserved nodes/parameters; it is not a named probability distribution. Each row of <code>drawsDF</code> is a single individual sample or realization of the posterior distribution. Each row is referred to as a <strong>draw</strong> from the posterior.</p>
<p>To see a representative sample of the posterior distribution, we access the R object, <code>drawsDF</code>, created above. The <code>theta</code> column of <code>drawsDF</code> contains our representative sample of the posterior distribution. In this case, that representative sample includes 4,000 samples of <code>theta</code>. Recall that our prior belief about <code>theta</code>, the probability of success, was uniformly distributed between 0 and 1 - all values equally likely. Now, after observing 2 successes and 1 failure, our plausibility beliefs should favor <span class="math inline">\(\theta\)</span> values away from 0 and 1 and more towards middle values as we learned both success and failure are possible; but we let Bayes rule (via <code>numpyro</code>) do this plausibility updating for us.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3855</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.5282</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.4598</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.4707</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.4707</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.8929</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Using <code>bayesplot</code>, we can visualize how plausibility was reallocated from our uniform prior of <span class="math inline">\(\theta\)</span> in light of the observed data; in other words, we can see the posterior distribution for <span class="math inline">\(\theta\)</span> after observing 2 out of 3 stores increase sales:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice how values of <span class="math inline">\(\theta\)</span> are no longer uniformly distributed; values from 50% to 75% are represented more frequently.</p>
<p>Some other takeaways from the plot regarding plausibility reallocation:</p>
<ul>
<li><p>Low values of <span class="math inline">\(\theta\)</span> are now deemed less plausible; two out of three successes is simply inconsistent with low values of <span class="math inline">\(\theta\)</span>.</p></li>
<li><p>Very high values of <span class="math inline">\(\theta\)</span> are less plausbile; one failure in three tries is not likely to occur if <span class="math inline">\(\theta\)</span> were to be super-high.</p></li>
<li><p>Our best guess of <span class="math inline">\(\theta\)</span> went from 0.5 (i.e.&nbsp;the mean of theta when uniformly distributed) to <code>mean(drawsDF$theta) =</code> 0.60.</p></li>
<li><p>We are still very unsure about the “true” value of <span class="math inline">\(\theta\)</span> after only 3 observations. We can see this by looking at quantiles of the posterior distribution suggesting a 90% percentile interval from 0.25 to 0.91:</p></li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">theta</td>
<td style="text-align: right;">0.6064</td>
<td style="text-align: right;">0.6213</td>
<td style="text-align: right;">0.2002</td>
<td style="text-align: right;">0.2194</td>
<td style="text-align: right;">0.2503</td>
<td style="text-align: right;">0.9109</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1520</td>
<td style="text-align: right;">1964</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This continued large band of uncertainty is a good thing. We only have three data points, we should not be very confident in our point estimate of <span class="math inline">\(\theta\)</span>. If we want a tighter interval of uncertainty, then we simply need to get more data.</p>
</section>
<section id="making-probabilistic-statements-with-indicator-functions" class="level3">
<h3 class="anchored" data-anchor-id="making-probabilistic-statements-with-indicator-functions">Making probabilistic statements with indicator functions</h3>
<p>With a representative sample of the posterior joint distribution available to us, namely <code>drawsDF</code>, we can expand on the strategies of the “Joint Distributions Tell Us Everything” section to make probabilistic statements from representative samples. For example, we might be curious to know <span class="math inline">\(P(\theta \gt 50\%)\)</span>. Using indicator functions, simple functions that equal 1 when a criteria is met and 0 when it is not, we can get our estimate of <span class="math inline">\(P(\theta \gt 50\%)\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## estimate posterior probability that theta &gt; 50%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indicatorFlag =</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(theta <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">pctOfThetaVals =</span> <span class="fu">mean</span>(indicatorFlag))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">pctOfThetaVals</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.7032</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We would then state that “the probability that <span class="math inline">\(\theta\)</span> is greater than 50% is approximately 0.70”.</p>
<p>Similarly, we can answer more complicated queries. For example, what is the <span class="math inline">\(P(40\% \lt \theta \lt 50\%)\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="do">## estimate posterior probability that 40% &lt; theta &lt; 60%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indicatorFlag =</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(theta <span class="sc">&gt;</span> <span class="fl">0.4</span> <span class="sc">&amp;</span> theta <span class="sc">&lt;</span> <span class="fl">0.6</span>, </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                  <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">pctOfThetaVals =</span> <span class="fu">mean</span>(indicatorFlag))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">pctOfThetaVals</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.292</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>The power of this workflow cannot be overstated</strong> and you will use it frequently for making probabilistic statements. Statements that will come in handy when it is time to use data to inform decision making under uncertainty.</p>
<p>A more descriptive output, possibly used for plotting purposes, is shown here:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indicatorFlag =</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(theta <span class="sc">&gt;</span> <span class="fl">0.5</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"theta &gt; 0.5"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"theta &lt;= 0.5"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(indicatorFlag) <span class="sc">|&gt;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">countInstances =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentageOfInstances =</span> </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>           countInstances <span class="sc">/</span> <span class="fu">sum</span>(countInstances))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">indicatorFlag</th>
<th style="text-align: right;">countInstances</th>
<th style="text-align: right;">percentageOfInstances</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">theta &lt;= 0.5</td>
<td style="text-align: right;">1187</td>
<td style="text-align: right;">0.2968</td>
</tr>
<tr class="even">
<td style="text-align: left;">theta &gt; 0.5</td>
<td style="text-align: right;">2813</td>
<td style="text-align: right;">0.7032</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Why does this work? Let’s delve into the math for a moment just to see why.</p>
<p>An indicator function, denoted <span class="math inline">\(1_A\)</span> maps all values of a representative sample <span class="math inline">\(X\)</span> to either 0 or 1 depending on whether the values satisfy criteria to be in some set we label as <span class="math inline">\(A\)</span>. For example, assume <span class="math inline">\(A = \{x \ge 0.5\}\)</span> is math set notation for all values in representative sample <span class="math inline">\(X\)</span> such that the draw satisfies <span class="math inline">\(x \ge 0.5\)</span>. Then, the formal definition of an indicator function, denoted <span class="math inline">\(1_A\)</span>, maps elements in <span class="math inline">\(X\)</span> to either 0 or 1 depending on whether they are in <span class="math inline">\(A\)</span>:</p>
<p><span class="math display">\[
1_{A} \equiv\begin{cases}  1, &amp; \textrm{if } x \in A\\  0, &amp; \textrm{if } x \notin A\end{cases}
\]</span></p>
<p>Now, for the key math trick, known as the <em>fundamental bridge</em>. The probability of an event is the expected value (i.e.&nbsp;mean) of its indicator random variable. Mathematically,</p>
<p><span class="math display">\[
P(A) = \mathbb{E}[1_{A}]
\]</span></p>
<p>which is true since <span class="math inline">\(\mathbb{E}[1_{A}] = 1 \times P(A) + 0 \times P(\bar{A}) = P(A)\)</span> where <span class="math inline">\(\bar A\)</span> denotes not in set <span class="math inline">\(A\)</span>. So, using this formula we can make probabilistic statements about a realization <span class="math inline">\(x\)</span> meeting the criteria to be in set <span class="math inline">\(A\)</span>. Assuming <span class="math inline">\(J\)</span> draws in our data frame, each draw labelled <span class="math inline">\(j\)</span>, then we estimate <span class="math inline">\(P(A)\)</span> by taking the average value of an indicator function over the <span class="math inline">\(J\)</span> draws:</p>
<p><span class="math display">\[
P(A) = \mathbb{E}[1_{A}] \approx \frac{1}{J} \sum_{j=1}^J 1_{x_j \in A}
\]</span></p>
<p>And despite the heavy math notation, your intuition can guide you in applying this formula. For example, imagine we have a representative sample of <span class="math inline">\(X = [1,4,3,2,5]\)</span> and we want to estimate <span class="math inline">\(P(X \ge 3)\)</span>. You could answer this just by looking and say <span class="math inline">\(\frac{3}{5}\)</span> or 3 out of 5 chances for <span class="math inline">\(x \ge 3\)</span>. Applying the formula, which we could easily do with code, is shown mathematically here:</p>
<p><span class="math display">\[
P(x \geq 3) = \mathbb{E}[1_{x \geq 3}] \approx \frac{1}{5} \sum_{j=1}^5 1_{x_j \geq 3} = \frac{1}{5} \times (0+1+1+0+1) = \frac{3}{5} = 0.6
\]</span></p>
<p>We have a probabilistic statement: “the probability that <span class="math inline">\(x\)</span> is greater than or equal to 3 is 0.6”.</p>
</section>
<section id="credit-card-example" class="level3">
<h3 class="anchored" data-anchor-id="credit-card-example">Credit card example</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Get Card"</span>,<span class="st">"x"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> carModelDF<span class="sc">$</span>getCard) <span class="sc">|&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Signup Probability"</span>,<span class="st">"theta"</span>,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Car Model"</span>, <span class="st">"y"</span>,  </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> carModelDF<span class="sc">$</span>carModel,  </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="st">"theta"</span>, </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">addDataNode =</span> <span class="cn">TRUE</span>)  <span class="sc">|&gt;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observations"</span>, <span class="st">"i"</span>,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-54a4873249b169eb6149" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-54a4873249b169eb6149">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\nsubgraph cluster1{\nlabel=\"Car Model y [4]\"\n  \"2\" [label = \"Signup Probability\ntheta ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\nsubgraph cluster2{\nlabel=\"Observations i [1000]\"\n  \"1\" [label = \"Get Card\nx ~ bernoulli(theta[y])\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Car Model\ny\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"dashed\"] \n\"3\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-binomial-distribution" class="level2">
<h2 class="anchored" data-anchor-id="the-binomial-distribution">The binomial distribution</h2>
<p>Making a model requires constructing a set of inter-related random variables. Some of these random variables are observed and others are latent (i.e.&nbsp;not observed). A common pattern is to:</p>
<ol type="1">
<li><p><em>Assume observed variables comes from a specified family of probability distributions.</em> So far, that known family has been the <code>Bernoulli</code> distribution.</p></li>
<li><p><em>Use latent variables to model uncertainty in the parameters of the distribution family in step 1.</em> So far, this uncertainty was modeled with the uniform distribution.</p></li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Bernoulli RV"</span>, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(pi),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Bernoulli parameter RV"</span>, </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"pi"</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-d57ecbd3ad10bd2d35a2" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d57ecbd3ad10bd2d35a2">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Bernoulli RV [3]\nx ~ bernoulli(pi)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Bernoulli parameter RV\npi ~ uniform(0,1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The generative DAG we have been working with contains two inter-related random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(\Theta\)</span>. For any observed realization <span class="math inline">\(x\)</span>, we assume it came from a <span class="math inline">\(\textrm{Bernoulli}(\theta)\)</span> generating process; i.e.&nbsp;there is zero uncertainty that the data is generated from a Bernoulli distribution. Given a specific parameter value <span class="math inline">\(\theta\)</span>, the uncertainty in <span class="math inline">\(X\)</span> is purely due to the stochastic nature of a Bernoulli random variable. The takeaway is that for <strong>observed</strong> data, our statistical model restricts the generative recipe to be from the specified family - i.e.&nbsp;Bernoulli.</p>
<p>We also model uncertainty in the <strong>unobserved</strong> random variable <span class="math inline">\(\Theta\)</span>. Modelling uncertainty in unobserved RV’s is different in that the posterior distribution of <span class="math inline">\(\theta\)</span> is <strong>not</strong> restricted to be from the same distribution family as its prior specification. In fact, for most cases our posterior distribution for unobserved random variables cannot be summarized using a known distribution family (e.g.&nbsp;normal, uniform, etc.); posteriors will only be approximated with representative samples as that is the best we can do.</p>
<p>When it comes to representing prior uncertainty, try to pick a distribution whose <em>support</em> The support of a random variable and its associated probability distribution is the set of possible realizations with non-zero probability density.covers all possible realizations of the RV. For <span class="math inline">\(\Theta\)</span>, this would be a probability distribution whose support is all values such that <span class="math inline">\(0 \le \theta \le 1\)</span>. The <span class="math inline">\(\textrm{Uniform}(0,1)\)</span> distribution provided an example where prior uncertainty mapped to all possible values of <span class="math inline">\(\theta\)</span>, but after updating that uncertainty in light of data, we have already seen that the posterior distribution was no longer uniform.</p>
<p>If we do not have uniform beliefs about plausible values for <span class="math inline">\(\theta\)</span>, there is another well-known and more-flexible distribution that can be used as a prior for <span class="math inline">\(\theta\)</span>. In other words, if you were to ask a statistician “what other distributions have support that ensures <span class="math inline">\(0 \le \theta \le 1\)</span>?”, a likely response you will get is the distribution. In the absence of a statistician, go to wikipedia, <a href="https://en.wikipedia.org/wiki/List_of_probability_distributions" class="uri">https://en.wikipedia.org/wiki/List_of_probability_distributions</a>, and find a useful list of probability distributions. You’ll see the first one in the list is the Bernoulli distribution. To find others that might be useful in a certain case:</p>
<ol type="1">
<li><p>Match the support of the distribution with what you think is feasible. The wikipedia list has multiple categories for support, we have only seen these two so far:</p>
<ul>
<li><p>Discrete with finite support (e.g.&nbsp;Bernoulli)</p></li>
<li><p>Continuous on a bounded interval (e.g.&nbsp;uniform)</p></li>
</ul></li>
<li><p>Investigate how changing parameters can make a distribution more consistent with the assumptions you are willing to make about your generative recipe.</p></li>
</ol>
<p>In this section, we investigate the Beta distribution whose support is continuous on a bounded interval and lends itself nicely to model our assumptions about an unknown probability parameter.</p>
<section id="using-a-beta-prior-for-the-bernoulli-parameter" class="level3">
<h3 class="anchored" data-anchor-id="using-a-beta-prior-for-the-bernoulli-parameter">Using a Beta prior for the Bernoulli parameter</h3>
<p>A Beta distribution is a two-parameter distribution whose support is <span class="math inline">\([0,1]\)</span>. The two-parameters are typically called <span class="math inline">\(\alpha\)</span> (alpha) and <span class="math inline">\(\beta\)</span> (beta); yes, it is annoying and might feel confusing that the Beta distribution has a parameter of the same-name, <span class="math inline">\(\beta\)</span>, but generally, it is clear from context which one you are talking about. Let’s assume random variable <span class="math inline">\(\Theta\)</span> follows a Beta distribution. Hence,</p>
<p><span class="math display">\[
\Theta \sim \textrm{beta}(\alpha,\beta)
\]</span></p>
<p>then we can plot a representative sample:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">10000</span> <span class="co"># number of realizations to generate</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get vector of 10,000 random draws of theta</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>thetas <span class="ot">=</span> <span class="fu">rbeta</span>(n, <span class="at">shape1 =</span> <span class="dv">6</span>, <span class="at">shape2 =</span> <span class="dv">2</span>) </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="do">## make a dataframe for plotting</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>thetas <span class="ot">=</span> <span class="fu">tibble</span>(thetas) </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="do">## show some values of theta</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(thetas)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">thetas</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.8768</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7980</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.8923</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.8895</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.9039</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.9175</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(thetas)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As a prior for a Bernoulli parameter, this distribution does seem valid in the sense that <span class="math inline">\(0 \leq \theta \leq 1\)</span>. Clearly however, this is not a uniform prior anymore. This prior suggests that values greater than 50% are much more likely than smaller values (i.e.&nbsp;there is more draws of higher <code>theta</code> values in the representative sample than lower <code>theta</code> values). So, to use this prior suggests that you have a strong prior belief that success is more likely than failure.</p>
</section>
<section id="matching-beta-parameters-to-your-beliefs" class="level3">
<h3 class="anchored" data-anchor-id="matching-beta-parameters-to-your-beliefs">Matching Beta parameters to your beliefs</h3>
<p>With named probability distributions, we can use the <code>stat_function</code> layer available with ggplot2 to plot the exact distribution instead of the approximated distribution using a representative sample. For example, the below code plot the exact <span class="math inline">\(\textrm{Beta}(6,2)\)</span> distribution.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dbeta,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">c</span>(<span class="at">shape1 =</span> <span class="dv">6</span>, <span class="at">shape2 =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">theta =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> theta)) <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">stat =</span> <span class="st">"function"</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">fun =</span> dbeta, </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">args =</span> <span class="fu">c</span>(<span class="at">shape1 =</span> <span class="dv">6</span>, <span class="at">shape2 =</span> <span class="dv">2</span>),</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"gray"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_function</span>(<span class="at">fun =</span> dbeta,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">args =</span> <span class="fu">c</span>(<span class="at">shape1 =</span> <span class="dv">6</span>, <span class="at">shape2 =</span> <span class="dv">2</span>),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the perspective of using the <span class="math inline">\(\textrm{Beta}(6,2)\)</span> distribution to represent our beliefs about probability of success for a Bernoulli RV, we again see that higher probability values are more plausible than lower ones (i.e.&nbsp;there is more blue filled area above the higher theta values). If this represented our uncertainty in a trick coin’s probability of heads, we are suggesting that it is most likely biased to land on heads (i.e.&nbsp;more area for <code>theta</code> values above 0.5 than below). That being said, there is visible area (i.e.&nbsp;probability) for the <code>theta</code> values below 0.5, so using this prior also suggests that the coin has the potential to be tails-biased; we would just need to flip the coin and see a bunch of tails to reallocate our plausibility beliefs to these lower values.</p>
<p>Beta distributions for various <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> parameter values are shown below:</p>
<p><img src="images/clipboard-1766480459.png" class="img-fluid"></p>
<p>We see the Beta distribution is flexible in showing a variety of representations of our uncertainty. When looking at the distribution for <span class="math inline">\(\textrm{Beta}(0.5,0.5)\)</span> distribution (top-left) we see that <code>theta</code> values closer to zero or one have higher density values than values closer to 0.5. At the other end, a <span class="math inline">\(\textrm{Beta}(4,4)\)</span> distribution distribution places more plausibility for values closer to 0.5. In between, it seems distributions that favor high or low values for <code>theta</code> can be constructed.</p>
<p>The Beta distribution has a very neat property which can aid your selection of parameters to model your uncertainty:</p>
<blockquote class="blockquote">
<p>you can roughly interpret <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> as previously observed data where the <span class="math inline">\(\alpha\)</span> parameter is the number of successes you have observed and the <span class="math inline">\(\beta\)</span> parameter is the number of failures.</p>
</blockquote>
<p>Hence, a <span class="math inline">\(\textrm{Beta}(1,1)\)</span> distribution (which is mathematically equivalent to a <span class="math inline">\(\textrm{Uniform(0,1)}\)</span> distribution) can be thought of as saying a single success and failure have been witnessed, but we are completely unsure as to the probability of each. Whereas, a <span class="math inline">\(\textrm{Beta}(10,10)\)</span> distribution is like suggesting you have seen 20 outcomes and they have been split down the middle - i.e.&nbsp;you have observed some small evidence that the two outcomes occur in equal proportions. Another distribution, say <span class="math inline">\(\textrm{Beta}(10,20)\)</span>, can indicate a belief that would accompany having seen 30 outcomes where failures occur 2 times as frequently as successes. Finally, a distribution like <span class="math inline">\(\textrm{Beta}(500,500)\)</span> might be used to represent your uncertainty in the flip of a fair coin. These four distributions (i.e.&nbsp;probability density functions) are shown below side-by-side.</p>
<p><img src="images/clipboard-2183603856.png" class="img-fluid"></p>
<p>Moving forward, we will often use the Beta distribution to represent our prior beliefs regarding a probability or a proportion. The support is <span class="math inline">\([0,1]\)</span> and it is able to adopt some flexible shapes.</p>
</section>
<section id="using-a-beta-prior-for-the-bernoulli-parameter-1" class="level3">
<h3 class="anchored" data-anchor-id="using-a-beta-prior-for-the-bernoulli-parameter-1">Using a Beta prior for the Bernoulli parameter</h3>
<p>Let’s define a generative DAG declaring a <span class="math inline">\(\textrm{Beta}(2,2)\)</span> prior as representative of our uncertainty in <span class="math inline">\(\theta\)</span>. We aren’t saying too much with this prior. This is a <em>weak prior</em> because. as we will see, it will be easily overwhelmed by data; its just saying that two successes and two failures have been seen. Let’s imagine that we observe 20 successes and only two failures. This data is highly consistent with a very large value for theta. We can intelligently combine prior and data using <code>dag_numpyro()</code> to get our posterior:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assume twenty successes and two failures</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">20</span>), <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get representative sample of posterior</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bernoulli RV"</span>,<span class="st">"x"</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bernoulli Parameter RV"</span>,<span class="st">"theta"</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">beta</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(drawsDF, <span class="fu">aes</span>(<span class="at">x =</span> theta)) <span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">stat =</span> <span class="st">"function"</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">fun =</span> dbeta, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">args =</span> <span class="fu">list</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">'grey'</span>) <span class="sc">+</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure shows a dramatic shift from prior to posterior distribution. The weak prior suggested ot us that all values between zero and one had plausibility, but once observing 20 successes out of 22 trials, the higher values for <span class="math inline">\(\theta\)</span> became much more plausible.</p>
<p>If we want to change the prior to something stronger, say a <span class="math inline">\(\textrm{Beta}(50,50)\)</span>, then we can rerun <code>dag_numpyro()</code> after just changing the one line for the prior:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assume twenty successes and two failures</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">20</span>), <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get representative sample of posterior</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bernoulli RV"</span>,<span class="st">"x"</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bernoulli Parameter RV"</span>,<span class="st">"theta"</span>,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">beta</span>(<span class="dv">50</span>,<span class="dv">50</span>),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(drawsDF, <span class="fu">aes</span>(<span class="at">x =</span> theta)) <span class="sc">+</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">stat =</span> <span class="st">"function"</span>,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">fun =</span> dbeta, </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">args =</span> <span class="fu">list</span>(<span class="dv">50</span>,<span class="dv">50</span>),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">'grey'</span>) <span class="sc">+</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure shows a posterior distribution that is only mildly shifted from its prior. This is a direct result of a <em>strong prior</em> due to the larger <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> parameters. In general, we will seek <em>weakly informative priors</em> that yield plausible prior generating processes, yet are flexible enough to let the data inform the posterior generating process. There is a bit of an art to this and we will learn more in subsequent sections.</p>
</section>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>Your company has been testing two flavors of coffee using free samples, let’s call them Flavor A and Flavor B. You are planning to only offer one flavor for sale and are interested in whether your customers prefer Flavor A or Flavor B.</p>
<p>You use a taste testing survey of 60 randomly selected people, and find that 36 people prefer Flavor B.</p>
<p>What’s the the posterior probability that Flavor B is preferred to Flavor A? In other words, what percentage of your posterior draws (assuming the generative DAG shown below) have a <code>theta</code> that is above 0.5?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">36</span>), <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">24</span>))</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Flavor B preferred"</span>,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Prob flavor B preferred"</span>,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"theta"</span>,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">beta</span>(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="at">descr =</span> <span class="st">"Observations"</span>,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">label =</span> <span class="st">"i"</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="st">"x"</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-e76df25d4e1770d66a86" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-e76df25d4e1770d66a86">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Prob flavor B preferred\ntheta ~ beta(2,2)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observations i [60]\"\n  \"1\" [label = \"Flavor B preferred\nx ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">theta</td>
<td style="text-align: right;">0.596</td>
<td style="text-align: right;">0.5969</td>
<td style="text-align: right;">0.061</td>
<td style="text-align: right;">0.0614</td>
<td style="text-align: right;">0.4925</td>
<td style="text-align: right;">0.697</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1370</td>
<td style="text-align: right;">1904</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(drawsDF<span class="sc">$</span>theta <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.94</code></pre>
</div>
</div>
</section>
</section>
<section id="parameter-estimation" class="level2">
<h2 class="anchored" data-anchor-id="parameter-estimation">Parameter estimation</h2>
<p>We now look at multiple potential data distributions, comment on the prior distributions that can accompany them, and learn to update parameter uncertainty in response to data.</p>
<section id="normal-distribution" class="level3">
<h3 class="anchored" data-anchor-id="normal-distribution">Normal distribution</h3>
<p>The Normal distribution also known as the Gaussian is perhaps the most well-known distribution. The Normal distribution is typically notated as <span class="math inline">\(N(\mu,\sigma)\)</span> and has two parameters:</p>
<ol type="1">
<li><p><span class="math inline">\(\mu\)</span>: the mean or location/central tendency of either your data generating process or your prior uncertainty and,</p></li>
<li><p><span class="math inline">\(\sigma\)</span>: the scale or spread/uncertainty around <span class="math inline">\(\mu\)</span>.</p></li>
</ol>
<p><img src="images/clipboard-2877652671.png" class="img-fluid"></p>
<p>There is an astounding amount of data in the world that appears to be normally distributed.</p>
<p>Due to its prevalance and some nice mathematical properties, this is often the distribution you learn the most about in a statistics course. For us, it is often a good distribution when data or uncertainty is characterized by diminishing probability as potential realizations get further away from the mean. Given the small probability given to outliers, this is not the best distribution to use (at least by itself) if data far from the mean are expected. Even though mathematical theory tells us the support of the Normal distribution is <span class="math inline">\((-\infty,\infty)\)</span>, the probability of deviations far from the mean is practically zero. As such, do not use the Normal distribution by itself to model data with outliers.</p>
<p>The graphical model representing our uncertainty in the generating process for normally distributed data will have three random variables: 1) the observed data <span class="math inline">\(X\)</span>, 2) the mean <span class="math inline">\(\mu\)</span>, and 3) the standard deviation <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Normal data"</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"x"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(mu, sigma),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Location"</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"mu"</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Spread"</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"sigma"</span>,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-dcce969965edfe9f869a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-dcce969965edfe9f869a">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Normal data [60]\nx ~ normal(mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Location\nmu\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Spread\nsigma\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>and the statistical model with priors:</p>
<p><span class="math display">\[
\begin{aligned}X \sim&amp; N(\mu,\sigma) \\\mu \sim&amp; \textrm{ Some Prior Distribution} \\\sigma \sim&amp; \textrm{ Some Prior Distribution}\end{aligned}
\]</span></p>
<p>where the prior distributions get determined based on the context of the problem under study.</p>
<p>For example, let’s say we are interested in modelling the heights of cherry trees. Even if we do not know much about cherry trees, we can probably be 95% confident that they are somewhere between 1 foot and 99 feet. Hence, we can set up a prior with 95% probability between 1 and 99, i.e.&nbsp;if <span class="math inline">\(X \equiv \textrm{ Cherry Tree Height}\)</span> , then we know that <span class="math inline">\(P(\mu - 2\sigma \leq x \leq \mu + 2 \sigma) \approx 95\%\)</span> . Hence, we can select <span class="math inline">\(\mu \sim N(50,24.5)\)</span>. Note this is a prior on the average height, not the individual height of a cherry tree.</p>
<p>Choosing a prior on <span class="math inline">\(\sigma\)</span> is less intuitive. What do we know about the variation in heights of individual trees? Not much. We can probably bound it though. In fact, we can be 100% certain this is greater than zero; no two cherry trees will be the same height. And I am confident, that cherry tree heights will most definitely fall within say 50 feet of the average, so let’s go with a uniform distribution bounded by 0 and 50.</p>
<p>Hence, our statistical model becomes:</p>
<p><span class="math display">\[
\begin{aligned}X \sim &amp;  N(\mu,\sigma) \\\mu \sim &amp;  N(50,24.5) \\\sigma \sim &amp; \textrm{ Uniform}(0,50)\end{aligned}
\]</span></p>
<p>After choosing our prior, we then use data to reallocate plausibility over all our model parameters. There is a built-in dataset called <code>trees</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(trees)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Girth</th>
<th style="text-align: right;">Height</th>
<th style="text-align: right;">Volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">8.3</td>
<td style="text-align: right;">70</td>
<td style="text-align: right;">10.3</td>
</tr>
<tr class="even">
<td style="text-align: right;">8.6</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">10.3</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8.8</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">10.2</td>
</tr>
<tr class="even">
<td style="text-align: right;">10.5</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">16.4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10.7</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">18.8</td>
</tr>
<tr class="even">
<td style="text-align: right;">10.8</td>
<td style="text-align: right;">83</td>
<td style="text-align: right;">19.7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11.0</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">15.6</td>
</tr>
<tr class="even">
<td style="text-align: right;">11.0</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">18.2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11.1</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">22.6</td>
</tr>
<tr class="even">
<td style="text-align: right;">11.2</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">19.9</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11.3</td>
<td style="text-align: right;">79</td>
<td style="text-align: right;">24.2</td>
</tr>
<tr class="even">
<td style="text-align: right;">11.4</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">21.0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11.4</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">21.4</td>
</tr>
<tr class="even">
<td style="text-align: right;">11.7</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">21.3</td>
</tr>
<tr class="odd">
<td style="text-align: right;">12.0</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">19.1</td>
</tr>
<tr class="even">
<td style="text-align: right;">12.9</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">22.2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">12.9</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">33.8</td>
</tr>
<tr class="even">
<td style="text-align: right;">13.3</td>
<td style="text-align: right;">86</td>
<td style="text-align: right;">27.4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13.7</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">25.7</td>
</tr>
<tr class="even">
<td style="text-align: right;">13.8</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">24.9</td>
</tr>
<tr class="odd">
<td style="text-align: right;">14.0</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">34.5</td>
</tr>
<tr class="even">
<td style="text-align: right;">14.2</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">31.7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">14.5</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">36.3</td>
</tr>
<tr class="even">
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">38.3</td>
</tr>
<tr class="odd">
<td style="text-align: right;">16.3</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">42.6</td>
</tr>
<tr class="even">
<td style="text-align: right;">17.3</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">55.4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17.5</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">55.7</td>
</tr>
<tr class="even">
<td style="text-align: right;">17.9</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">58.3</td>
</tr>
<tr class="odd">
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">51.5</td>
</tr>
<tr class="even">
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">51.0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">20.6</td>
<td style="text-align: right;">87</td>
<td style="text-align: right;">77.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>which we will use in combination with the following generative DAG:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Tree Height"</span>,<span class="st">"x"</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(mu,sigma),</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> trees<span class="sc">$</span>Height) <span class="sc">|&gt;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg Cherry Tree Height"</span>,<span class="st">"mu"</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">50</span>,<span class="fl">24.5</span>),</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"StdDev of Observed Height"</span>,<span class="st">"sigma"</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">50</span>),</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="st">"x"</span>)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-a904450f171f14364aa3" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-a904450f171f14364aa3">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Avg Cherry Tree Height\nmu ~ normal(50,24.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"StdDevofObservedHeight\nsigma ~ uniform(0,50)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i [31]\"\n  \"1\" [label = \"Tree Height\nx ~ normal(mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Calling <code>dag_numpyro()</code>, we get our representative sample of the posterior distribution:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then, plot the credible values which for our purposes is the 90% percentile interval of the representative sample:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(drawsDF, <span class="at">pars =</span> <span class="st">"mu"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(drawsDF, <span class="at">pars =</span> <span class="st">"sigma"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>REMINDER: the posterior distribution for the average cherry tree height is no longer normally distributed and the standard deviation is no longer uniform. This is a reminder that prior distribution families do not restrict the shape of the posterior distribution.</p>
</div>
</div>
<p>We now have insight as to the height of cherry trees as our prior uncertainty is significantly reduced. REMINDER: the posterior distribution for the average cherry tree height is no longer normally distributed and the standard deviation is no longer uniform. This is a reminder that prior distribution families do not restrict the shape of the posterior distribution.Instead of cherry tree heights averaging anywhere from 1 to 99 feet as accomodated by our prior, we now say (roughly speaking) the average height is somewhere in the 70-80 foot range. Instead of the variation in height of trees being plausibly as high as 50 feet, the height of any individual tree is most likely within 15 feet of the average height (i.e.&nbsp;<span class="math inline">\(\approx \mu \pm 2\sigma\)</span>).</p>
</section>
<section id="gamma-distribution" class="level3">
<h3 class="anchored" data-anchor-id="gamma-distribution">Gamma distribution</h3>
<p>The support of any random variable with a normal distribution is <span class="math inline">\((-\infty,\infty)\)</span> which means just about any value is theoretically possible - although values far away from the mean are practically impossible. Sometimes, you want a similar distribution, but one that has constrained support of <span class="math inline">\((0,\infty)\)</span>, i.e.&nbsp;the data is restricted to being strictly positive (even 0 has no density). The Gamma distribution has such support. While the Gamma distribution is often used to fit real-world data like total insurance claims and total rainfall, we will often use this distribution as a prior for another distribution’s parameters. For example, the standard deviation of a normally distributed random variable is strictly positive, so perhaps the Gamma could be appropriate for modelling uncertainty in a standard deviation parameter. Let’s take a deeper look.</p>
<p>The Gamma distribution is a two-parameter distribution notated <span class="math inline">\(\textrm{Gamma}(\alpha,\beta)\)</span>. While there other ways to specify the two parameters, we will use the convention that <span class="math inline">\(\alpha\)</span> is a shape parameter and <span class="math inline">\(\beta\)</span> is a rate parameter.</p>
<p><img src="images/clipboard-1272439291.png" class="img-fluid"></p>
<p>When choosing <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> so that our prior uncertainty is accurately represented, we will use a few mathematical properties of the Gamma distribution. Assuming <span class="math inline">\(\textrm{Gamma}(\alpha,\beta)\)</span>, the following properties are true: <span class="math inline">\(E[X] = \frac{\alpha}{\beta}\)</span> and <span class="math inline">\(\textrm{Var}[X] = \frac{\alpha}{\beta^2}\)</span>.</p>
</section>
<section id="student-t-distribution" class="level3">
<h3 class="anchored" data-anchor-id="student-t-distribution">Student <span class="math inline">\(t\)</span> distribution</h3>
<p>For our purposes, the Student <span class="math inline">\(t\)</span> distribution is a normal distribution with fatter tails - i.e.&nbsp;it places more plausibility to values far from the mean than a similar Normal distribution would. Whereas estimates for the mean of a distribution can get pulled towards outliers, the Student <span class="math inline">\(t\)</span> distribution is less susceptible to that issue. Hence, for just about all practical questions, the Student <span class="math inline">\(t\)</span> is a more robust distribution both as likelihood and for expressing prior uncertainty.</p>
<p>The Student <span class="math inline">\(t\)</span> distribution is a three parameter distribution notated <span class="math inline">\(\textrm{Student-t}(\nu,\mu,\sigma)\)</span>.</p>
<p>The last two parameters, <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, can be interpreted just as they are with the Normal distribution. The first parameter, <span class="math inline">\(\nu\)</span> (greek letter pronounced “new” and phonetically spelled “nu”), refers to the degrees of freedom. Interestingly, as <span class="math inline">\(\nu \rightarrow \infty\)</span> (i.e.&nbsp;as <span class="math inline">\(\nu\)</span> gets large) the Student <span class="math inline">\(t\)</span> distribution and the Normal distribution become identical; in other words, the fatter tails go away. For all of our purposes, we use a gamma prior for representing our uncertianty in as recommended in <a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations" class="uri">https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations</a>.</p>
<p><img src="images/clipboard-3417554164.png" class="img-fluid"></p>
<p>If we wanted to model the cherry tree heights using a Student <span class="math inline">\(t\)</span> distribution instead of a Normal distribution, the following generative DAG can be used:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Tree Height"</span>,<span class="st">"x"</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">student</span>(nu,mu,sigma),</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> trees<span class="sc">$</span>Height) <span class="sc">|&gt;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Degrees Of Freedom"</span>,<span class="st">"nu"</span>,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">2</span>,<span class="fl">0.1</span>),</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg Cherry Tree Height"</span>,<span class="st">"mu"</span>,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">50</span>,<span class="fl">24.5</span>),</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"StdDev of Observed Height"</span>,<span class="st">"sigma"</span>,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">50</span>),</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="st">"x"</span>)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-ebedfbfc52d82635d988" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-ebedfbfc52d82635d988">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Degrees Of Freedom\nnu ~ gamma(2,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Avg Cherry Tree Height\nmu ~ normal(50,24.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"4\" [label = \"StdDevofObservedHeight\nsigma ~ uniform(0,50)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i [31]\"\n  \"1\" [label = \"Tree Height\nx ~ student(nu,mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Calling <code>dag_numpyro()</code>, we get our representative sample of the posterior distribution:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then, plot the credible values to observe very similar results to those using the Normal distribution:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The wide distribution for <span class="math inline">\(\nu\)</span> can be interpreted as saying we do not know how fat the tails for this distribution should be. Which makes sense! You need alot of data to potentially observe outliers, so with only 31 observations our generative model remains uncertain about this degrees of freedom parameter.</p>
<p>To highlight the robustness of the Student <span class="math inline">\(t\)</span> distribution to outliers and the lack of robustness of the Normal distribution, let’s add a mismeasured cherry tree height to the data. While most heights are between 60-80 feet, a mismeasured and truly unbelievable height of 1,000 is added to the data (i.e.&nbsp;<code>dataWithOutlier = c(trees$Height,1000)</code>). The figure below shows recalculated posterior densities for both the Normal and Student <span class="math inline">\(t\)</span> priors.</p>
<p><img src="images/clipboard-1599969966.png" class="img-fluid"></p>
<p>The posterior estimate of the mean when using a Normal prior is greatly affected by the outlier data point - the posterior average height gets concentrated around an absurd 100 feet. Whereas, the Student <span class="math inline">\(t\)</span> prior seems to correctly ignore that mismeasured data and concentrates the posterior expectation of average cherry tree height around 76 (as discovered previously). While in this case, ignoring the outliers is desirable and the student t distribution provides a robust method for discounting outliers, all modelling choices should be made so that the posterior distribution accurately reflects your prior expectations of how data should be mixed with prior knowledge.</p>
</section>
<section id="poisson-distribution" class="level3">
<h3 class="anchored" data-anchor-id="poisson-distribution">Poisson distribution</h3>
<p>The Poisson distribution is useful for modelling the number of times an event occurs within a specified time interval. It is a one parameter distribution where if <span class="math inline">\(K \sim \textrm{Poisson}(\lambda)\)</span>, then any realization <span class="math inline">\(k\)</span> represents the number of times an event occurred in an interval. The parameter, <span class="math inline">\(\lambda\)</span>, has a nice property in that it is a rate parameter representing the average number of times an event occurs in a given interval. Given this interpretability, estimating this parameter is often of interest. A graphical model for estimating a Poisson rate from count data is shown below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Count data"</span>,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"k"</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">poisson</span>(lambda),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> data) <span class="sc">|&gt;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="at">descr =</span> <span class="st">"Rate parameter"</span>,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"lambda"</span>,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>) <span class="sc">|&gt;</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-c6e12f4c52b7f36e26c3" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-c6e12f4c52b7f36e26c3">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Count data [60]\nk ~ poisson(lambda)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Rate parameter\nlambda\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>and a prior for <span class="math inline">\(\lambda\)</span> will be determined by the use case.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are several assumptions about Poisson random variables that dictate the appropriateness of modelling counts using a Poisson random variable. Three of those assumptions are: 1) <span class="math inline">\(k\)</span> is a non-negative integer of counts in a specified time interval, 2) the rate <span class="math inline">\(\lambda\)</span> at which events occur is constant, and 3) the occurrence of one event does not affect the probability of additional events occurring (i.e.&nbsp;events are independent).</p>
</div>
</div>
<p>Let’s create a dataframe of tickets issued on Wednesday’s in New York City, and then model the rate of ticketing on Wednesdays using the Poisson likelihood with appropriate prior.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>tickets <span class="ot">&lt;-</span> ticketsDF <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dayOfWeek =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dayOfWeek <span class="sc">==</span> <span class="st">"Wed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">numTickets =</span> <span class="fu">sum</span>(daily_tickets))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(numTickets <span class="sc">~</span> date, <span class="at">data =</span> tickets)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, we model these two years of observations using a Poisson likelihood and a prior that reflects beliefs that the average number of tickets issued on any Wednesday in NYC is somewhere between 3,000 and 7,000; for simplicity, let’s choose a <span class="math inline">\(\textrm{Uniform}(3000,7000)\)</span> prior as in the following generative DAG:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Daily # of Tickets"</span>,<span class="st">"k"</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">poisson</span>(rate),</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> tickets<span class="sc">$</span>numTickets) <span class="sc">|&gt;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg # Daily Tickets"</span>,<span class="st">"rate"</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">3000</span>,<span class="dv">7000</span>),</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-00a71d5df3d80f5735ca" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-00a71d5df3d80f5735ca">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Daily # of Tickets [105]\nk ~ poisson(rate)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Avg # Daily Tickets\nrate ~ uniform(3000,7000)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>And extracting our posterior for the average rate of ticket issuance, (NOTE: we use <code>rate</code> in code instead of <code>lambda</code> due to the latter being a reserved word in Python that will cause issues with using <code>dag_numpyro()</code>), yields the following posterior:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>where we see that that the average rate of ticketing in NYC is somewhere slightly more than 5,000 tickets per day.</p>
</section>
</section>
<section id="posterior-predictive-checks" class="level2">
<h2 class="anchored" data-anchor-id="posterior-predictive-checks">Posterior predictive checks</h2>
<p><img src="images/clipboard-382068582.png" class="img-fluid" style="width:20.0%"></p>
<blockquote class="blockquote">
<p>Cobra snakes are known for hypnotizing their prey. Like cobras, Bayesian posteriors can fool you into submission - thinking you have a good model with small uncertainty. The seductiveness of getting results needs to be counter-balanced with a good measure of skepticism. For us, that skepticism manifests as a posterior predictive check - a method of ensuring the posterior distribution can simulate data that is similar to the observed data. We want to ensure our BAW leads to actionable insights, not intoxicating and venomous results.</p>
</blockquote>
<p>When modelling real-world data, your generative DAG <strong>never</strong> captures the <em>true</em> generating process - the real-world is too messy. However, if your generative DAG can approximate reality, then your model might be useful. Modelling with generative DAGs provides a good starting place from which to confirm, deny, or refine business narratives.</p>
<p>Whether your generative DAG proves successful or not, the modelling process by itself puts you on a good path towards learning more from both the domain expertise of business stakeholders and observed data.</p>
<p>In the last section, we were modelling the daily number of tickets issued in New York City on Wednesdays. We made a dataframe, <code>tickets</code>, that had our observed data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tickets)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">numTickets</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2014-01-01</td>
<td style="text-align: right;">2991</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-01-08</td>
<td style="text-align: right;">5587</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-01-15</td>
<td style="text-align: right;">6034</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-01-22</td>
<td style="text-align: right;">2716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2014-01-29</td>
<td style="text-align: right;">5616</td>
</tr>
<tr class="even">
<td style="text-align: left;">2014-02-05</td>
<td style="text-align: right;">2853</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The generative DAG, which we thought was successful, yielded a posterior distribution with a huge reduction in uncertainty. As we will see, this DAG will turn out to be the hypnotizing cobra I was warning you about. Let’s learn a way of detecting models that are inconsistent with observation.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Daily # of Tickets"</span>,<span class="st">"k"</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">poisson</span>(rate),</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> tickets<span class="sc">$</span>numTickets) <span class="sc">|&gt;</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg # Daily Tickets"</span>,<span class="st">"rate"</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">3000</span>,<span class="dv">7000</span>),</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-af1367c25ca3336b15b0" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-af1367c25ca3336b15b0">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Daily # of Tickets [105]\nk ~ poisson(rate)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Avg # Daily Tickets\nrate ~ uniform(3000,7000)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"2\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Prior uncertainty gave equal plausibility to any number between 3,000 and 7,000. The plausible range for the posterior spans a drastically smaller range, about 5,005 - 5,030. So while this might lead us to think we have a good model, do not be hypnotized into believing it just yet.</p>
<section id="posterior-predictive-checks-1" class="level3">
<h3 class="anchored" data-anchor-id="posterior-predictive-checks-1">Posterior predictive check(s)</h3>
<p>A <em>posterior predictive check</em> compares simulated data using a draw of your posterior distribution to the observed data you are modelling - usually represented by the data node at the bottom of your generative DAG. This means we simulate 105 observations of tickets issued, <span class="math inline">\(K\)</span>, and compare the simulated data to the 105 real-world observations (two years worth of Wednesday tickets).</p>
<p>Here we use just one draw from the posterior for demonstrating a posterior predictive check. It is actually more appropriate to use dozens of draws to get a feel for the variability within the entire sample of feasible posterior distributions.</p>
<p>Simulating 105 observations requires us to convert the DAGs joint distribution recipe into computer code - we do this going from top to bottom of the graph. At the top of the DAG is <code>lambda</code>, so we get a single random draw from the posterior:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>rate <span class="ot">=</span> drawsDF <span class="sc">|&gt;</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(rate)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>rate</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5016</code></pre>
</div>
</div>
<p>Continuing the recipe conversion by moving from parent to child, we simulate 105 realizations of using the appropriate <code>rfoo</code> functions (<code>causact</code> does not support posterior predictive checks yet, so we must use R’s built-in random variable samplers, namely <code>rpois</code> for a Poisson random variable):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>simData <span class="ot">=</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="dv">105</span>, <span class="at">lambda =</span> rate)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then, we can compare the histograms of the simulated data and the observed data:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">k_observed =</span> tickets<span class="sc">$</span>numTickets, <span class="at">k_simulated =</span> simData)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># make df in tidy format (use tidyr::pivot_longer)</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co"># so fill can be mapped to observed vs simulated data</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(k_observed,k_simulated),</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"type"</span>,</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"numTickets"</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">type</th>
<th style="text-align: right;">numTickets</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">k_observed</td>
<td style="text-align: right;">2991</td>
</tr>
<tr class="even">
<td style="text-align: left;">k_simulated</td>
<td style="text-align: right;">5067</td>
</tr>
<tr class="odd">
<td style="text-align: left;">k_observed</td>
<td style="text-align: right;">5587</td>
</tr>
<tr class="even">
<td style="text-align: left;">k_simulated</td>
<td style="text-align: right;">4982</td>
</tr>
<tr class="odd">
<td style="text-align: left;">k_observed</td>
<td style="text-align: right;">6034</td>
</tr>
<tr class="even">
<td style="text-align: left;">k_simulated</td>
<td style="text-align: right;">5033</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_density</span>(<span class="sc">~</span> numTickets, <span class="at">data =</span> d, <span class="at">fill =</span> <span class="sc">~</span> type)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure above shows two very different distributions of data. The observed data seemingly can vary from 0 to 8,000 while the simulated data never strays too far from 5,000. The real-world dispersion is not being captured by our generative DAG. Why not?</p>
<p>Our generative DAG wrongly assumes that every Wednesday has the exact same conditions for tickets being issued. In research done by Auerbach (2017) [“Are New York City Drivers More Likely to Get a Ticket at the End of the Month?” <em>Significance</em> 14 (4): 20–25] based off the same data, they consider holidays and ticket quotas as just some of the other factors driving the variation in tickets issued. To do better, we would need to account for this variation.</p>
<p>Let’s now look at how a posterior predictive check for a good generative DAG might work. Consider the following graphical model from the previous chapter which modeled cherry tree heights:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Tree Height"</span>,<span class="st">"x"</span>,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">student</span>(nu,mu,sigma),</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> trees<span class="sc">$</span>Height) <span class="sc">|&gt;</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Degrees Of Freedom"</span>,<span class="st">"nu"</span>,</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">2</span>,<span class="fl">0.1</span>),</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg Cherry Tree Height"</span>,<span class="st">"mu"</span>,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">50</span>,<span class="fl">24.5</span>),</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"StdDev of Observed Height"</span>,<span class="st">"sigma"</span>,</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">50</span>),</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="st">"x"</span>)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-293a530a78b6872d546c" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-293a530a78b6872d546c">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Degrees Of Freedom\nnu ~ gamma(2,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Avg Cherry Tree Height\nmu ~ normal(50,24.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"4\" [label = \"StdDevofObservedHeight\nsigma ~ uniform(0,50)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i [31]\"\n  \"1\" [label = \"Tree Height\nx ~ student(nu,mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We get the posterior as usual:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then compare data simulated from a random posterior draw to the observed data. <em>Actually, we will compare simulated data from several draws, say 20, to get a fuller picture of what the posterior implies for observed data.</em> By creating multiple simulated datasets, we can see how much the data distributions vary. Observed data is subject to lots of randomness, so we just want to ensure that the observed randomness falls within the realm of our plausible narratives.</p>
<p>Getting the twenty random draws, which is technically a random sample of the posterior representative sample, we place them in <code>paramsDF</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>paramsDF <span class="ot">=</span> drawsDF <span class="sc">|&gt;</span> <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">20</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>paramsDF</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mu</th>
<th style="text-align: right;">nu</th>
<th style="text-align: right;">sigma</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">74.86</td>
<td style="text-align: right;">19.620</td>
<td style="text-align: right;">8.244</td>
</tr>
<tr class="even">
<td style="text-align: right;">75.54</td>
<td style="text-align: right;">72.249</td>
<td style="text-align: right;">7.950</td>
</tr>
<tr class="odd">
<td style="text-align: right;">79.24</td>
<td style="text-align: right;">32.620</td>
<td style="text-align: right;">8.179</td>
</tr>
<tr class="even">
<td style="text-align: right;">73.81</td>
<td style="text-align: right;">6.113</td>
<td style="text-align: right;">7.380</td>
</tr>
<tr class="odd">
<td style="text-align: right;">74.88</td>
<td style="text-align: right;">57.793</td>
<td style="text-align: right;">7.527</td>
</tr>
<tr class="even">
<td style="text-align: right;">73.89</td>
<td style="text-align: right;">30.891</td>
<td style="text-align: right;">7.838</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.92</td>
<td style="text-align: right;">6.975</td>
<td style="text-align: right;">6.585</td>
</tr>
<tr class="even">
<td style="text-align: right;">74.07</td>
<td style="text-align: right;">25.896</td>
<td style="text-align: right;">7.852</td>
</tr>
<tr class="odd">
<td style="text-align: right;">76.80</td>
<td style="text-align: right;">10.467</td>
<td style="text-align: right;">4.792</td>
</tr>
<tr class="even">
<td style="text-align: right;">75.18</td>
<td style="text-align: right;">18.760</td>
<td style="text-align: right;">7.707</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.42</td>
<td style="text-align: right;">40.454</td>
<td style="text-align: right;">6.701</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.29</td>
<td style="text-align: right;">36.440</td>
<td style="text-align: right;">6.703</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.45</td>
<td style="text-align: right;">43.029</td>
<td style="text-align: right;">7.634</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.94</td>
<td style="text-align: right;">52.276</td>
<td style="text-align: right;">6.752</td>
</tr>
<tr class="odd">
<td style="text-align: right;">76.37</td>
<td style="text-align: right;">15.467</td>
<td style="text-align: right;">6.657</td>
</tr>
<tr class="even">
<td style="text-align: right;">77.45</td>
<td style="text-align: right;">12.468</td>
<td style="text-align: right;">6.100</td>
</tr>
<tr class="odd">
<td style="text-align: right;">74.48</td>
<td style="text-align: right;">41.508</td>
<td style="text-align: right;">6.155</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.96</td>
<td style="text-align: right;">20.509</td>
<td style="text-align: right;">7.449</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.21</td>
<td style="text-align: right;">19.839</td>
<td style="text-align: right;">6.394</td>
</tr>
<tr class="even">
<td style="text-align: right;">72.99</td>
<td style="text-align: right;">26.524</td>
<td style="text-align: right;">7.618</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Then, for each row of <code>paramsDF</code>, we will simulate 31 observations. Since we are going to do the same simulation 20 times, once for each row of parameters, I write a function which returns a vector of simulated tree heights. Again, we convert the generative DAG recipe to code that enables our posterior predictive check:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>simData <span class="ot">=</span> <span class="cf">function</span>(nu,mu,sigma) {</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use n = 31 because 31 observed heights in the data</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(extraDistr<span class="sc">::</span><span class="fu">rlst</span>(<span class="at">n =</span> <span class="dv">31</span>, <span class="at">df =</span> nu, <span class="at">mu =</span> mu, <span class="at">sigma =</span> sigma))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>N.B.: The Student-t distribution in <code>causact</code> is based on the <code>rlst()</code> function in the <code>extraDistr</code> package.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> paramsDF <span class="sc">|&gt;</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simID =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simData =</span> <span class="fu">list</span>(<span class="fu">simData</span>(nu, mu, sigma))) <span class="sc">|&gt;</span> </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 89%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">mu</th>
<th style="text-align: right;">nu</th>
<th style="text-align: right;">sigma</th>
<th style="text-align: right;">simID</th>
<th style="text-align: left;">simData</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">74.86</td>
<td style="text-align: right;">19.620</td>
<td style="text-align: right;">8.244</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">81.01, 77.37, 73.02, 76.70, 90.65, 75.25, 94.84, 80.81, 72.81, 75.96, 79.77, 81.97, 82.38, 72.13, 59.63, 52.36, 77.53, 70.14, 79.86, 84.78, 79.41, 68.96, 80.32, 72.11, 79.40, 60.69, 66.81, 73.44, 55.76, 82.21, 71.77</td>
</tr>
<tr class="even">
<td style="text-align: right;">75.54</td>
<td style="text-align: right;">72.249</td>
<td style="text-align: right;">7.950</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">74.47, 85.36, 74.89, 75.78, 78.51, 77.86, 75.83, 71.75, 75.52, 77.80, 72.82, 78.08, 75.45, 72.34, 69.26, 68.02, 84.53, 79.57, 68.26, 85.08, 78.60, 77.66, 77.39, 83.64, 68.82, 78.67, 64.94, 90.66, 70.97, 62.53, 78.68</td>
</tr>
<tr class="odd">
<td style="text-align: right;">79.24</td>
<td style="text-align: right;">32.620</td>
<td style="text-align: right;">8.179</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">73.85, 93.62, 85.64, 73.78, 70.78, 90.82, 76.56, 82.15, 78.55, 82.86, 79.15, 75.37, 79.56, 101.67, 72.09, 62.05, 69.32, 68.63, 71.25, 84.12, 86.95, 81.77, 82.22, 86.07, 89.57, 65.01, 76.72, 80.47, 71.63, 79.46, 88.03</td>
</tr>
<tr class="even">
<td style="text-align: right;">73.81</td>
<td style="text-align: right;">6.113</td>
<td style="text-align: right;">7.380</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">71.25, 65.53, 42.04, 84.34, 77.63, 87.46, 68.71, 92.91, 62.09, 65.68, 82.21, 70.51, 79.14, 76.77, 88.72, 65.98, 67.13, 65.78, 77.48, 65.84, 82.19, 81.07, 68.54, 66.69, 64.87, 47.57, 77.89, 83.61, 74.38, 67.03, 82.36</td>
</tr>
<tr class="odd">
<td style="text-align: right;">74.88</td>
<td style="text-align: right;">57.793</td>
<td style="text-align: right;">7.527</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">72.34, 82.65, 87.36, 83.75, 96.17, 72.53, 71.75, 70.84, 69.57, 72.14, 83.77, 77.54, 60.85, 68.35, 79.13, 68.78, 71.48, 68.31, 71.70, 75.03, 63.49, 74.90, 83.86, 76.84, 84.21, 79.26, 76.05, 74.74, 81.40, 79.15, 76.25</td>
</tr>
<tr class="even">
<td style="text-align: right;">73.89</td>
<td style="text-align: right;">30.891</td>
<td style="text-align: right;">7.838</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">67.73, 66.98, 79.37, 70.61, 72.45, 72.52, 88.90, 75.71, 73.97, 65.31, 82.84, 62.15, 63.43, 73.43, 74.15, 72.69, 71.39, 70.79, 70.92, 75.18, 63.82, 76.44, 68.49, 59.40, 77.76, 80.55, 60.59, 70.24, 75.67, 78.26, 82.07</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.92</td>
<td style="text-align: right;">6.975</td>
<td style="text-align: right;">6.585</td>
<td style="text-align: right;">7</td>
<td style="text-align: left;">65.90, 71.74, 83.84, 81.14, 74.76, 62.98, 82.55, 74.49, 77.74, 68.39, 79.90, 75.14, 66.85, 71.05, 79.97, 65.75, 79.87, 74.99, 75.32, 75.14, 71.14, 73.11, 70.50, 66.34, 57.25, 80.41, 76.19, 67.89, 77.13, 67.54, 78.11</td>
</tr>
<tr class="even">
<td style="text-align: right;">74.07</td>
<td style="text-align: right;">25.896</td>
<td style="text-align: right;">7.852</td>
<td style="text-align: right;">8</td>
<td style="text-align: left;">76.71, 69.57, 80.20, 66.86, 79.15, 94.00, 74.22, 59.31, 63.08, 85.55, 82.75, 78.64, 67.96, 73.27, 74.38, 83.85, 72.76, 71.35, 78.27, 84.47, 65.13, 76.03, 62.64, 68.68, 77.43, 76.28, 78.69, 83.22, 69.28, 70.41, 78.09</td>
</tr>
<tr class="odd">
<td style="text-align: right;">76.80</td>
<td style="text-align: right;">10.467</td>
<td style="text-align: right;">4.792</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">79.30, 80.08, 77.46, 79.96, 85.70, 81.29, 68.08, 82.34, 81.59, 72.68, 73.23, 80.31, 74.95, 79.44, 67.69, 67.08, 75.20, 73.42, 77.42, 85.65, 76.44, 77.66, 78.06, 93.82, 79.77, 71.10, 79.82, 61.49, 76.87, 77.81, 86.46</td>
</tr>
<tr class="even">
<td style="text-align: right;">75.18</td>
<td style="text-align: right;">18.760</td>
<td style="text-align: right;">7.707</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">77.23, 67.45, 81.62, 72.91, 82.49, 79.25, 59.36, 78.40, 89.02, 87.10, 79.44, 90.47, 82.78, 59.94, 84.64, 48.54, 67.03, 86.48, 71.36, 68.77, 82.19, 84.82, 73.56, 71.25, 73.22, 74.21, 89.71, 70.68, 74.89, 94.13, 75.17</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.42</td>
<td style="text-align: right;">40.454</td>
<td style="text-align: right;">6.701</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">70.78, 66.93, 80.43, 78.05, 71.83, 91.40, 75.40, 79.55, 71.28, 76.27, 75.72, 81.66, 95.48, 66.28, 76.14, 69.15, 71.47, 77.84, 83.28, 80.27, 73.37, 79.90, 72.64, 90.68, 69.90, 42.16, 72.38, 81.40, 74.78, 79.14, 78.01</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.29</td>
<td style="text-align: right;">36.440</td>
<td style="text-align: right;">6.703</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">71.57, 77.01, 75.57, 83.99, 83.50, 61.83, 83.24, 75.65, 75.68, 76.41, 71.56, 72.48, 70.37, 70.66, 80.50, 75.18, 78.21, 81.85, 79.37, 83.07, 77.67, 90.16, 69.84, 85.38, 65.97, 72.21, 55.63, 69.64, 76.67, 79.58, 67.91</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.45</td>
<td style="text-align: right;">43.029</td>
<td style="text-align: right;">7.634</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">72.47, 69.25, 79.98, 77.91, 66.03, 79.19, 79.97, 59.68, 81.52, 73.93, 72.48, 79.12, 77.22, 68.93, 73.40, 78.58, 60.52, 83.08, 82.63, 81.59, 73.11, 78.82, 74.84, 77.75, 75.92, 91.84, 77.57, 74.82, 80.53, 74.56, 68.35</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.94</td>
<td style="text-align: right;">52.276</td>
<td style="text-align: right;">6.752</td>
<td style="text-align: right;">14</td>
<td style="text-align: left;">88.21, 75.86, 67.00, 80.55, 75.09, 83.94, 73.38, 71.17, 75.54, 90.92, 80.32, 80.78, 88.47, 78.25, 77.91, 81.85, 85.27, 67.36, 66.82, 66.72, 85.63, 81.78, 90.73, 77.31, 75.44, 69.05, 71.78, 78.62, 83.94, 89.73, 83.13</td>
</tr>
<tr class="odd">
<td style="text-align: right;">76.37</td>
<td style="text-align: right;">15.467</td>
<td style="text-align: right;">6.657</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">78.78, 75.31, 71.60, 89.04, 81.00, 77.21, 83.19, 70.62, 69.48, 72.16, 76.07, 68.21, 89.87, 69.40, 86.28, 78.82, 82.26, 71.64, 79.45, 84.60, 78.70, 83.97, 79.34, 74.28, 83.04, 76.19, 65.79, 78.21, 69.85, 68.42, 81.18</td>
</tr>
<tr class="even">
<td style="text-align: right;">77.45</td>
<td style="text-align: right;">12.468</td>
<td style="text-align: right;">6.100</td>
<td style="text-align: right;">16</td>
<td style="text-align: left;">80.30, 76.06, 64.77, 73.26, 68.91, 85.87, 79.20, 71.08, 72.58, 64.62, 88.42, 84.72, 75.05, 75.48, 87.19, 70.04, 77.27, 82.49, 73.87, 77.75, 80.05, 86.69, 75.31, 77.16, 76.42, 73.97, 85.46, 73.36, 85.62, 78.32, 78.40</td>
</tr>
<tr class="odd">
<td style="text-align: right;">74.48</td>
<td style="text-align: right;">41.508</td>
<td style="text-align: right;">6.155</td>
<td style="text-align: right;">17</td>
<td style="text-align: left;">76.63, 84.63, 66.23, 71.64, 77.51, 75.65, 72.71, 77.79, 85.14, 76.85, 89.22, 80.12, 75.98, 81.12, 74.04, 77.00, 89.86, 76.07, 78.99, 80.62, 78.31, 64.05, 83.39, 79.81, 80.49, 70.56, 80.94, 72.61, 70.67, 66.89, 68.40</td>
</tr>
<tr class="even">
<td style="text-align: right;">76.96</td>
<td style="text-align: right;">20.509</td>
<td style="text-align: right;">7.449</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">81.75, 83.05, 75.47, 74.66, 75.01, 74.34, 85.50, 73.42, 76.49, 73.88, 78.65, 85.86, 77.48, 80.87, 90.53, 77.47, 83.05, 82.24, 74.53, 77.68, 79.32, 73.17, 65.45, 77.04, 83.87, 80.32, 86.40, 59.35, 70.41, 82.90, 81.58</td>
</tr>
<tr class="odd">
<td style="text-align: right;">75.21</td>
<td style="text-align: right;">19.839</td>
<td style="text-align: right;">6.394</td>
<td style="text-align: right;">19</td>
<td style="text-align: left;">80.88, 68.16, 66.94, 73.30, 74.86, 68.17, 70.21, 73.11, 71.44, 67.07, 75.96, 75.29, 64.13, 75.69, 74.84, 85.29, 69.60, 70.15, 71.48, 81.82, 88.41, 76.42, 64.03, 65.15, 77.33, 78.94, 65.16, 59.21, 74.46, 74.07, 82.38</td>
</tr>
<tr class="even">
<td style="text-align: right;">72.99</td>
<td style="text-align: right;">26.524</td>
<td style="text-align: right;">7.618</td>
<td style="text-align: right;">20</td>
<td style="text-align: left;">62.05, 73.39, 78.14, 71.39, 65.70, 65.19, 74.05, 73.33, 83.88, 72.79, 82.44, 78.03, 77.02, 68.50, 77.47, 73.18, 59.67, 67.14, 63.48, 61.77, 67.35, 75.06, 74.12, 67.81, 71.38, 75.78, 59.85, 63.25, 68.87, 62.16, 60.78</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(simID, simData) <span class="sc">|&gt;</span> </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_longer</span>(simData) <span class="sc">|&gt;</span> <span class="co"># flatten list-column to numeric values</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_dens</span>(<span class="sc">~</span> simData, <span class="at">color =</span> <span class="sc">~</span> <span class="fu">factor</span>(simID)) <span class="sc">|&gt;</span> </span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_dens</span>(<span class="sc">~</span> Height, <span class="at">data =</span> trees, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">inherit =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This type of spaghetti plot (so-called for obvious reasons), shows 21 different density lines. The twenty light-colored lines each represent a density derived from the 31 points of a single posterior draw. The thicker dark-line is the observed density based on the actual 31 observations. As can be seen, despite the variation across all the lines, the posterior does seem capable of generating data like that which we observed. While this is not a definitive validation of the generative DAG, it is a very good sign that your generative DAG is on the right track.</p>
<p>Despite any posterior predictive success, remain vigilant for factors not included in your generative DAG. Investigating these can lead to substantially more refined narratives of how your data gets generated.</p>
<p><em>Do not be a business analyst who only looks at data</em>, get out and talk to domain experts! See this Twitter thread for a real-world example of why this matters: <a href="https://twitter.com/oziadias/status/1221531710820454400" class="uri">https://twitter.com/oziadias/status/1221531710820454400</a>. It shows how data generated in the real-world of emergency physicians can only be modeled properly when real-world considerations are factored in.</p>
</section>
</section>
<section id="decision-making" class="level2">
<h2 class="anchored" data-anchor-id="decision-making">Decision making</h2>
<p>Objectives, decisions, and uncertainty are foundational elements of a field known as <em>decision theory</em>.</p>
<blockquote class="blockquote">
<p>Boardwalk Bathhouse’s business plan is to bring a private shower facility to the Ocean City, MD boardwalk. Currently, beachgoers visiting for the day have no way to wash off the saltwater and sand from a day at the beach. Nobody wants to get into their car or go out for dinner without a way of freshening up. We just need your help in deciding a location along the 2.5-mile long boardwalk (see Figure <a href="https://www.causact.com/intro#fig:boardwalk">20.1</a>) to maximize our chances of success. Where should we put our bathhouse?</p>
</blockquote>
<section id="objectives" class="level3">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<p>For Boardwalk Bathhouse, we will keep things simple and claim the business to be profit-maximizing. In more complex situations, we will often find a strong strategy statement provides time-saving clarity around which objectives or performance measures are important to look at.</p>
</section>
<section id="decisions" class="level3">
<h3 class="anchored" data-anchor-id="decisions">Decisions</h3>
<p>The following is a first pass at depicting the Boardwalk Bathhouse decision in a model. Decision nodes, shown as rectangles, are just like random variable nodes (ovals) with the exception that their value is controlled by an internal decision-maker. Hence, we get to choose the realization for a decision node and use that to feed information to the children nodes. In this case, we see how the location decision drives revenue, expenses, and subsequently, profit.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"# of Hot Day Beachgoers"</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="fu">c</span>(<span class="st">"Rent by Location"</span>,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Beachgoer Location Probability"</span>),</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="fu">c</span>(<span class="st">"Revenue"</span>,<span class="st">"Expenses"</span>,<span class="st">"Profit"</span>),</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">det =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bathhouse Location"</span>,</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">dec =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_edge</span>(<span class="at">from =</span> <span class="fu">c</span>(<span class="st">"# of Hot Day Beachgoers"</span>,</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Beachgoer Location Probability"</span>,</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Bathhouse Location"</span>),</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">to =</span> <span class="st">"Revenue"</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_edge</span>(<span class="at">from =</span> <span class="fu">c</span>(<span class="st">"Bathhouse Location"</span>,</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Rent by Location"</span>),</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">to =</span> <span class="st">"Expenses"</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_edge</span>(<span class="at">from =</span> <span class="fu">c</span>(<span class="st">"Revenue"</span>,<span class="st">"Expenses"</span>),</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">to =</span> <span class="st">"Profit"</span>)</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>(<span class="at">shortLabel =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-c16a4cadc5f8c7ab9ff9" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-c16a4cadc5f8c7ab9ff9">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"# of Hot Day Beachgoers\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Rent by Location\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Beachgoer Location\nProbability\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Revenue\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Expenses\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Profit\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Bathhouse Location\", shape = \"rect\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n\"1\"->\"4\" [style = \"solid\"] \n\"3\"->\"4\" [style = \"solid\"] \n\"7\"->\"4\" [style = \"solid\"] \n\"7\"->\"5\" [style = \"solid\"] \n\"2\"->\"5\" [style = \"solid\"] \n\"4\"->\"6\" [style = \"solid\"] \n\"5\"->\"6\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The top-down narrative is as follows. Boardwalk Beachhouse’s target customers are hot day beachgoers whose exposure to surf, salt, and sand will make them good candidates for wanting to get cleaned up. Since future weather and human behavior are unpredictable, the <em># of Hot Day Beachgoers</em> is a random variable. These beachgoers spread-out across the 2.5 mile-long beach in a well-studied pattern represented as an observed data node named <em>Beachgoer Location Probability</em>. Using the <em># of Hot Day Beachgoers</em> and <em>Beachgoer Location Probability</em> inputs, one can calculate <em>Revenue</em> as a function of these inputs and a given bathhouse location. Presumably, beachgoers closer to the <em>Bathhouse Location</em> will be more likely to contribute to revenue, but these details are currently omitted from the DAG. Similarly, <em>Bathhouse Location</em> also determines expenses, but further details are omitted from the DAG to keep things simpler.</p>
<p>The DAG reveals how we are mapping our location decision and other model inputs to the objectives we care about (revenue, expenses, and profit). Our strategy is similar to that of any other generative DAG in that we seek representative samples of unknown values; only this time, these representative samples are a function of our decision, e.g.&nbsp;<em>Bathhouse Location</em>. With representative samples in hand, we will pick the location that offers the best mix of objectives aligned with the firm’s strategy!</p>
</section>
<section id="uncertainty" class="level3">
<h3 class="anchored" data-anchor-id="uncertainty">Uncertainty</h3>
<p>The only uncertainty in the DAG is how many hot-day beachgoers will visit the beach during the year. Although often possible and sometimes preferable, we will ignore exact mathematical specification of this uncertainty and simply look at uncertainty expressed as a representative sample, e.g.&nbsp;from a marginal, a joint distribution or some past data that we feel is representative of the future. For now, let’s pretend we are interpeting this as a representative sample from a posterior distribution. We can obtain a representative sample of # of hot-day beachgoers in a season from a vector built into the <code>causact</code> package named <code>totalBeachgoersRepSample</code>. A quick histogram of this representative sample is shown below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>beachgoerDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">totalBeachgoers =</span> totalBeachgoersRepSample)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_dens</span>(<span class="sc">~</span> totalBeachgoers, <span class="at">data =</span> beachgoerDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot above tells us to expect around 9,000,000 beach visitors (plus or minus a few million) every year to Ocean City. Boardwalk Bathhouse’s profitability will likely be very dependent on this uncertain number. That should not stop us from making a decision though, we boldy accept this uncertainty and use a generative recipe for analyzing our performance measures of interest.</p>
</section>
<section id="creating-one-draw-of-a-generative-decision-dag" class="level3">
<h3 class="anchored" data-anchor-id="creating-one-draw-of-a-generative-decision-dag">Creating one draw of a generative decision DAG</h3>
<p>The <code>causact</code> package is not developed enough to automate the simulation of generative models that include decisions. So, while we can use <code>causact</code> to go from prior to posterior and can use <code>causact</code> to create figures for communicating about models with decisions, we need to manually do the simulation from posterior to decision choice.</p>
<p>To aid our introduction, we make the following assumptions:</p>
<ul>
<li><p>1% of beachgoers within 0.1 miles will become a customer of the bathhouse</p></li>
<li><p>Each customer will pay $30.</p></li>
</ul>
<p>In a more accurate model, these assumptions would also be turned into distributions that reflect any uncertainty in those assumptions.</p>
<p>Any changes to the above assumptions will alter our expectations and even alter the ideal action. While they should be explored in a real-world analysis, we will again ignore these additional details in favor of focusing on the translation from posterior uncertainty to decision making.</p>
<p><span class="smallcaps">Generating a potential realization of revenue</span> requires specification of the three parent nodes: 1) <em># of Hot Day Beachgoers</em>, 2) <em>Beachgoer Location Probability</em>, and 3) <em>Bathhouse Location</em>. So, let’s create a recipe for calculating each of these parent nodes and then, subsequently calculating <em>Revenue</em>.</p>
<p><em># of Hot Day Beachgoers</em> is modelled using our representative sample (described above). To get a sample draw, we simply sample a single value from the representative sample as follows:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>getNumBeachgoers <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample</span>(totalBeachgoersRepSample,<span class="dv">1</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><em>Beachgoer Location Probability</em> is considered known and a table of location probability (<code>beachgoerProb</code>) by milemarker (<code>mileMarker</code>) is in the following built-in <code>causact</code> data frame:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>beachLocProbDF <span class="ot">=</span> beachLocDF <span class="sc">|&gt;</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mileMarker, beachgoerProb)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>beachLocProbDF  </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mileMarker</th>
<th style="text-align: right;">beachgoerProb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.060</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.1</td>
<td style="text-align: right;">0.070</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">0.050</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3</td>
<td style="text-align: right;">0.050</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.4</td>
<td style="text-align: right;">0.045</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.5</td>
<td style="text-align: right;">0.040</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.6</td>
<td style="text-align: right;">0.020</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">0.030</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.8</td>
<td style="text-align: right;">0.040</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.9</td>
<td style="text-align: right;">0.040</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">0.030</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.1</td>
<td style="text-align: right;">0.020</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.2</td>
<td style="text-align: right;">0.010</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.3</td>
<td style="text-align: right;">0.020</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.4</td>
<td style="text-align: right;">0.025</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.5</td>
<td style="text-align: right;">0.030</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.6</td>
<td style="text-align: right;">0.030</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.7</td>
<td style="text-align: right;">0.035</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.8</td>
<td style="text-align: right;">0.035</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.9</td>
<td style="text-align: right;">0.040</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">0.045</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.1</td>
<td style="text-align: right;">0.045</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.2</td>
<td style="text-align: right;">0.050</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.3</td>
<td style="text-align: right;">0.055</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.4</td>
<td style="text-align: right;">0.050</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.5</td>
<td style="text-align: right;">0.050</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><em>Bathhouse Location</em> is our decision, we get to choose this. Since the possible locations are already listed in <code>beachLocProbDF</code>, we will consider <code>beachLocProbDF$mileMarker</code> as our vector of possible locations choices. Hence, we assume there are 26 possible alternatives, one location possibility every tenth of a mile.</p>
<p>In decision theory, you would call the set of possible locations either <em>alternatives</em> or <em>actions</em>. When reading more about decision theory, knowing these terms will be useful.</p>
<p><em>Revenue</em> is now a function of the three parents. Let’s make the function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>revenueFun <span class="ot">=</span> <span class="cf">function</span>(numBeachgoers,</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>                      locProbDF,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                      bathhouseLocation) {</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get number of potential customers exiting </span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## beach within 0.1 miles of bathhouse</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  numPotentialCustomers <span class="ot">=</span> locProbDF <span class="sc">|&gt;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">abs</span>(mileMarker <span class="sc">-</span> bathhouseLocation) <span class="sc">&lt;=</span> <span class="fl">0.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">custByMileMark =</span> beachgoerProb <span class="sc">*</span> numBeachgoers) <span class="sc">|&gt;</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">potentialCustomers =</span> <span class="fu">sum</span>(custByMileMark)) <span class="sc">|&gt;</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(potentialCustomers)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## capturing 1% of potential customers on average</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## means actual customers are a binomial rv</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## hence, use the rbinom() function (see the</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">##representing uncertainty chapter for more info).</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  numCust <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="fu">as.integer</span>(numPotentialCustomers),</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prob =</span> <span class="fl">0.01</span>)</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## $30 per customer</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>  revenue <span class="ot">=</span> numCust <span class="sc">*</span> <span class="dv">30</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(revenue)</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Testing the revenue function above, we use numbers that let us easily verify the math. Assume there are 1,000,000 beachgoers, we know from <code>beachLocDF</code> that mile marker 0 will see around 13% of those beachgoers and 1% of those exiting beachgoers turn into customers (about 1,300 customers). At $30 per customer, revenue of around $39,000 is expected. Let’s see if the function works:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">revenueFun</span>(<span class="at">numBeachgoers =</span> <span class="dv">1000000</span>,</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">locProbDF =</span> beachLocProbDF,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">bathhouseLocation =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 38910</code></pre>
</div>
</div>
<p>Close enough for me. Yay!</p>
<p><em>Rent by Location</em> is considered known and a table of rent expenses (<code>beachgoerProb</code>) by milemarker (<code>mileMarker</code>) is in the following built-in <code>causact</code> data frame:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>beachExpDF <span class="ot">=</span> beachLocDF <span class="sc">|&gt;</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mileMarker,expenseEst)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>beachExpDF</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mileMarker</th>
<th style="text-align: right;">expenseEst</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">160000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.1</td>
<td style="text-align: right;">160000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2</td>
<td style="text-align: right;">140000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3</td>
<td style="text-align: right;">140000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.4</td>
<td style="text-align: right;">140000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.5</td>
<td style="text-align: right;">140000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.6</td>
<td style="text-align: right;">110000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.7</td>
<td style="text-align: right;">110000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.8</td>
<td style="text-align: right;">110000</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.9</td>
<td style="text-align: right;">110000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">110000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.1</td>
<td style="text-align: right;">100000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.2</td>
<td style="text-align: right;">100000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.3</td>
<td style="text-align: right;">100000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.4</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.5</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.6</td>
<td style="text-align: right;">76000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.7</td>
<td style="text-align: right;">76000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.8</td>
<td style="text-align: right;">76000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.9</td>
<td style="text-align: right;">76000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">96000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.1</td>
<td style="text-align: right;">102000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.2</td>
<td style="text-align: right;">108000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.3</td>
<td style="text-align: right;">112000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.4</td>
<td style="text-align: right;">120000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.5</td>
<td style="text-align: right;">140000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><em>Expenses</em> is a function of its two parents. Let’s make the function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>expenseFun <span class="ot">=</span> <span class="cf">function</span>(locExpenseDF,bathhouseLocation) {</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get number of customers exiting at each mile marker</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## by taking total # of beachgoers and using location</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## probability to break the number down by mileMarker</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  beachExpDF <span class="ot">=</span> locExpenseDF <span class="sc">|&gt;</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(mileMarker <span class="sc">==</span> bathhouseLocation)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(beachExpDF<span class="sc">$</span>expenseEst)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s make sure this function works. We know from <code>beachLocDF</code> that mile marker 0 will have expenses of $160,000. Testing this:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expenseFun</span>(<span class="at">locExpenseDF =</span> beachExpDF,</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">bathhouseLocation =</span> <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 160000</code></pre>
</div>
</div>
<p>And now this works too.</p>
<p>Last node to simulate in our top-down approach to computing a joint realization of the generative decision DAG is the profit node. We use a typical formula for profit:</p>
<p><span class="math display">\[
\textrm{Profit} = \textrm{Revenue} - \textrm{Expenses}
\]</span></p>
<p>which we will model computationally in the next section where we simulate a draw from the generative decision DAG.</p>
</section>
<section id="simulating-a-possible-outcome" class="level3">
<h3 class="anchored" data-anchor-id="simulating-a-possible-outcome">Simulating a possible outcome</h3>
<p>With all the building blocks in place, we create a function that takes a potential decision and simulates one realization of revenue, expenses, and profit. It will return a single row as a data frame representing the draw.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>generativeRecipe <span class="ot">=</span> <span class="cf">function</span>(bathhouseLocation) {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  numBeachgoers <span class="ot">=</span> <span class="fu">getNumBeachgoers</span>()</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  locProbDF <span class="ot">=</span> beachLocDF <span class="sc">|&gt;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(mileMarker,beachgoerProb)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bathhouseLocation is passed as input to function</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  locExpenseDF <span class="ot">=</span> beachLocDF <span class="sc">|&gt;</span> </span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(mileMarker,expenseEst)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  rev <span class="ot">=</span> <span class="fu">revenueFun</span>(numBeachgoers,</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>                   locProbDF,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>                   bathhouseLocation) </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>  exp <span class="ot">=</span> <span class="fu">expenseFun</span>(locExpenseDF,</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>                   bathhouseLocation)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>  profit <span class="ot">=</span> rev <span class="sc">-</span> exp</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  decDrawsDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">locDec =</span> bathhouseLocation,</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">numBeachgoers =</span> numBeachgoers,</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">rev =</span> rev,</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">exp =</span> exp,</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">profit =</span> profit)</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(decDrawsDF)</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s test it:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">generativeRecipe</span>(<span class="at">bathhouseLocation =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">locDec</th>
<th style="text-align: right;">numBeachgoers</th>
<th style="text-align: right;">rev</th>
<th style="text-align: right;">exp</th>
<th style="text-align: right;">profit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">8960000</td>
<td style="text-align: right;">187320</td>
<td style="text-align: right;">110000</td>
<td style="text-align: right;">77320</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>This also looks good. Yay again!!</p>
</section>
<section id="simulating-a-range-of-outcomes-for-all-possible-decisions" class="level3">
<h3 class="anchored" data-anchor-id="simulating-a-range-of-outcomes-for-all-possible-decisions">Simulating a range of outcomes for all possible decisions</h3>
<p>Here we will use two <code>for</code> loops to get a representative sample of performance measures for each of the possible bathouse locations. The first loop, the <em>outer loop</em>, loops over possible decisions. The second loop, the <em>inner loop</em>, will then get 30 sample draws for a given decision. This code may take a minute or two; we have dramatically sacrificed computational speed in this chapter to keep the code intuitive (the end of this chapter offers guidance on making this simulation faster):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>numSimsPerDec <span class="ot">=</span> <span class="dv">30</span> <span class="co"># number of sims per decision</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="do">## create empty dataframe to store results</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>decDrawsDF <span class="ot">=</span> <span class="fu">tibble</span>()</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (bathLoc <span class="cf">in</span> beachLocDF<span class="sc">$</span>mileMarker) {</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (simNum <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numSimsPerDec) {</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    drawDF <span class="ot">=</span> <span class="fu">generativeRecipe</span>(</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">bathhouseLocation =</span> bathLoc)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    decDrawsDF <span class="ot">=</span> <span class="fu">bind_rows</span>(decDrawsDF, drawDF)</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end inner loop</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>} <span class="co"># end outer loop</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then, we do a quick visual to inspect our decisions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(profit <span class="sc">~</span> locDec, <span class="at">data =</span> decDrawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-95-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From visual inspection of the figure above, there are certain locations that seem really good. However, be very skeptical of yourself - “can 30 points really capture a representative sample?” I would argue NO. We will see how to more quickly generate 1,000’s of samples in a subsequent section.</p>
<p>To demonstrate incorporating additional complexity into our simulation, let’s assume we only have $100,000 to invest, that disqualifies many of the locations. The change to incorporate this is common; manipulate the dataframe to eliminate the infeasible choices and then view the results.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(profit <span class="sc">~</span> locDec, <span class="at">data =</span> decDrawsDF <span class="sc">|&gt;</span> <span class="fu">filter</span>(exp <span class="sc">&lt;</span> <span class="dv">100000</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-96-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Under the budget constraint, locating at mile markers 1.9 (expenses of $96,000) or at mile marker 2.0 (expenses are $76,000) now provide the best outcomes.</p>
</section>
<section id="faster-code" class="level3">
<h3 class="anchored" data-anchor-id="faster-code">Faster code</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take nSims as argument</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>fasterGenRecipe <span class="ot">=</span> <span class="cf">function</span>(nSims) {</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  fastGenDF <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">simNum =</span> <span class="dv">1</span><span class="sc">:</span>nSims,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">numBeachgoers =</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sample</span>(totalBeachgoersRepSample,nSims)) <span class="sc">|&gt;</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">crossing</span>(beachLocDF) <span class="sc">|&gt;</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">numAtMileMarker =</span> </span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>             numBeachgoers <span class="sc">*</span> beachgoerProb) <span class="sc">|&gt;</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(simNum,numAtMileMarker,</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>           mileMarker,expenseEst,numAtMileMarker) <span class="sc">|&gt;</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(simNum) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(mileMarker) <span class="sc">|&gt;</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">numPotentialCust =</span> </span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">lag</span>(numAtMileMarker, <span class="at">default =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>             numAtMileMarker <span class="sc">+</span> </span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>             <span class="fu">lead</span>(numAtMileMarker, <span class="at">default =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="fu">arrange</span>(simNum,mileMarker) <span class="sc">|&gt;</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">estRevenue =</span> </span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>             <span class="dv">30</span> <span class="sc">*</span> numPotentialCust <span class="sc">*</span> <span class="fl">0.01</span>) <span class="sc">|&gt;</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">profit =</span> estRevenue <span class="sc">-</span> expenseEst) <span class="sc">|&gt;</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(simNum,mileMarker,profit,</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>           estRevenue,expenseEst)</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fastGenDF)</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># separate out caption for readability of code</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>plotCaption <span class="ot">=</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Median Profit (dark point) and 90% Credible Interval"</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fasterGenRecipe</span>(<span class="dv">4000</span>) <span class="sc">|&gt;</span> <span class="fu">group_by</span>(mileMarker) <span class="sc">|&gt;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(<span class="at">q05 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(profit,<span class="fl">0.05</span>),</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">q50 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(profit,<span class="fl">0.50</span>),</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">q95 =</span> stats<span class="sc">::</span><span class="fu">quantile</span>(profit,<span class="fl">0.95</span>),</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">expense =</span> <span class="fu">first</span>(expenseEst)) <span class="sc">|&gt;</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(mileMarker) <span class="sc">|&gt;</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> mileMarker, <span class="at">yend =</span> mileMarker)) <span class="sc">+</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> q05, <span class="at">xmax =</span> q95), </span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#5f9ea0"</span>) <span class="sc">+</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> q50), </span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#11114e"</span>) <span class="sc">+</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> (expense <span class="sc">-</span> <span class="dv">120000</span>), </span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">label =</span> </span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="st">"Annual Expense = "</span>,</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>                           scales<span class="sc">::</span><span class="fu">dollar</span>(expense))),</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"darkred"</span>) <span class="sc">+</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Bathhouse Location Milemarker"</span>,</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> <span class="st">"Annual Profit($)"</span>,</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> plotCaption) <span class="sc">+</span> </span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50000</span>,<span class="dv">450000</span>),</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">dollar_format</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-98-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I encourage you to avoid presenting point estimates whenever possible. They are so incomplete in the information provided and will make your predictions look foolish as the most likely scenario is still rarely the scenario one sees play out in the business world. In the previous figure, declaring mile marker 1.5 to bring profit of $150,000 does not convey the real uncertainty where very different profit outcomes are possible - anywhere from $120,000 to over $200,000 are all very plausible outcomes.</p>
</section>
</section>
<section id="a-simple-linear-model" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-linear-model">A simple linear model</h2>
<blockquote class="blockquote">
<p>BuildIt Inc.&nbsp;flips houses - they buy houses to quickly renovate and then sell. Their specialty is building additions on to existing houses in established neighborhoods and then selling the home at prices above their total investment. BuildIt’s decision to move into a neighborhood is based on how sales price fluctuates with square footage. If sales price seems to increase by more than $120 per additional square foot, then they consider that neighborhood to be a good candidate for buying houses. BuildIt is eyeing a new neighborhood and records the square footage and prices of some recent sales transactions.</p>
</blockquote>
<p>The following code creates a dataframe with BuildIt’s findings (note: <code>salesPrice</code> is in thousands of dollars):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>dataDF <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">salesPrice =</span> <span class="fu">c</span>(<span class="dv">160</span>, <span class="dv">220</span>, <span class="dv">190</span>, <span class="dv">250</span>, <span class="dv">290</span>, <span class="dv">240</span>),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sqFootage =</span> <span class="fu">c</span>(<span class="dv">960</span>, <span class="dv">1285</span>, <span class="dv">1350</span>, <span class="dv">1600</span>, <span class="dv">1850</span>, <span class="dv">1900</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Visually, we can confirm what appears to be a linear relationship between square footage and sales prices by creating a scatterplot with a linear regression line drawn in blue: The so-called best line fit to six points. It is the line that minimizes the squared deviations between the line’s predictions of price and the observed prices. We will seek to draw multiple plausible lines, not just one.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_lm</span>(salesPrice <span class="sc">~</span> sqFootage, <span class="at">data =</span> dataDF) <span class="sc">|&gt;</span> <span class="fu">gf_point</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>BuildIt is interested in the slope of this line which gives the estimated change in mean sales price for each unit change in square footage. For BuildIt, they want to know if this slope is above 120 per square foot?</p>
<p>Letting,</p>
<p><span class="math display">\[
\begin{aligned}x_i \equiv &amp;\textrm{ The square footage for the } i^{th} \textrm{ house.} \\y_i \equiv &amp;\textrm{ The observed sales price, in 000's, for the } i^{th} \textrm{ house.} \\\alpha &amp;\equiv \textrm{ The intercept term for the regression line.} \\\beta &amp;\equiv \textrm{ The slope coefficient representing change in expected price per square footage.} \\\mu_i \equiv &amp;\textrm{ The expected sales price, in 000's, for any given square footage where } \\&amp; \hspace{0.2cm} \mu_i = E(y_i | x_i) \textrm{ and } \mu_i = \alpha + \beta \times x_i.\end{aligned}
\]</span></p>
<p>the regression output can be extracted using the <code>lm()</code> function in R. <span class="math inline">\(\alpha\)</span> is the <code>(intercept)</code> and <code>sqFootage</code> is the slope coefficient, <span class="math inline">\(\beta\)</span>, for square footage:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(salesPrice <span class="sc">~</span> sqFootage, <span class="at">data =</span> dataDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = salesPrice ~ sqFootage, data = dataDF)

Coefficients:
(Intercept)    sqFootage  
     58.906        0.111  </code></pre>
</div>
</div>
<p>Based on the output, the following linear equation is the so-called “best” line:</p>
<p><span class="math display">\[
\mu_i = 58.91 + 0.1114 \times x_i
\]</span></p>
<p>Using this model, BuildIt can anticipate being able to sell additional square footage for about $111 per square foot (i.e.&nbsp;<span class="math inline">\(1000 \times \beta\)</span> because price is in 000’s). This would not earn them acceptable profit as it is less than $120 per square foot. However, with only 6 data points, there is obviously going to be tremendous uncertainty in this estimate. A Bayesian model can capture this uncertainty.</p>
<section id="a-simple-bayesian-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="a-simple-bayesian-linear-model">A simple Bayesian linear model</h3>
<p>From previous coursework, you are probably familiar with simple linear regression in a non-Bayesian context. Extending this model to our Bayesian context, we will create an observational model with the assumption that our observed data is normally distributed around some line. Let’s use the following notation to describe the line:</p>
<p><span class="math display">\[
\mu_i = \alpha + \beta x_i
\]</span></p>
<p>where,</p>
<p><span class="math display">\[
\begin{aligned}x_i &amp;\equiv \textrm{The value of an explanatory variable for the } i^{th} \textrm{ observation.} \\\alpha &amp;\equiv \textrm{ The intercept term for the line.} \\\beta &amp;\equiv \textrm{ The slope coefficient for the line.} \\\mu_i &amp;\equiv \textrm{ The expected value (or mean) for the } i^{th} \textrm{ observation.}\end{aligned}
\]</span></p>
<p>In our generative DAG workflow, we represent the Bayesian version of simple linear regression:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Sales Price"</span>,<span class="st">"y"</span>,</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(mu,sigma),</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>salesPrice) <span class="sc">|&gt;</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Expected Sales Price"</span>,<span class="st">"mu"</span>,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x) <span class="sc">|&gt;</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>,</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="sc">-</span><span class="dv">100</span>,<span class="dv">175</span>)) <span class="sc">|&gt;</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Square Footage"</span>,<span class="st">"x"</span>,</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>sqFootage,</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Std. Dev."</span>,<span class="st">"sigma"</span>,</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">4</span>,<span class="fl">0.1</span>),</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Per SqFt Slope"</span>, <span class="st">"beta"</span>,</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="fl">0.120</span>,<span class="fl">0.80</span>),</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observations"</span>,<span class="st">"i"</span>,</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"y"</span>,<span class="st">"mu"</span>,<span class="st">"x"</span>))</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-23acfc8df40fd67c2027" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-23acfc8df40fd67c2027">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"3\" [label = \"Intercept\nalpha ~ uniform(-100,175)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Price Std. Dev.\nsigma ~ gamma(4,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Price Per SqFt Slope\nbeta ~ normal(0.12,0.8)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observations i [6]\"\n  \"1\" [label = \"Sales Price\ny ~ normal(mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Expected Sales Price\nmu = alpha + beta * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Square Footage\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"2\" [style = \"solid\"] \n\"4\"->\"2\" [style = \"solid\"] \n\"5\"->\"1\" [style = \"solid\"] \n\"6\"->\"2\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The statistical model of the generative DAG has reasonable priors that we will analyze later - for now, let’s digest the implied narrative. Starting at the bottom:</p>
<ul>
<li><p><em>Sales Price</em> Node(<code>y</code>): We observe <em>Sales Price</em> data where each realization is normally distributed about an <em>Expected Sales Price</em>, <span class="math inline">\(\mu\)</span>.</p></li>
<li><p><em>Expected Sales Price</em> Node(<code>mu</code>): Each realization <span class="math inline">\(\mu\)</span> is actually a deterministic function of this node’s parents. Graphically, the double perimeter around the node signals this. This node’s presence on the observation plate alerts us that this expectation varies with each observation. The only way this can happen is that it has a parent that varies with each observation; namely <em>Square Footage</em>.</p>
<ul>
<li><p><em>Square Footage</em> Node(<code>x</code>): The <em>Square Footage</em> is observed (as noted by the darker fill) and its lack of <code>rhs</code> means we are not modelling any of the variation in realizations (<span class="math inline">\(x\)</span>); we just take it as a given.</p></li>
<li><p>All other yet-to-be discussed nodes are outside the <em>Observations</em> plate. Therefore, the model assumes these three other nodes each have one <em>true</em> value. The one we are most interested in <em>Price Per SqFt Slope</em>, <span class="math inline">\(\beta\)</span>, as this will serve as an estimate of how home prices change when Build-It adds square footage. <em>Intercept</em> just sets some base-level home value and <em>Price Std. Dev.</em> gives a measure of how much home prices vary about the calculated expected price, <span class="math inline">\(\mu\)</span>.</p></li>
</ul></li>
</ul>
<p>A main deficiency of non-Bayesian linear regression lines is that they do not measure uncertainty in slope coefficients as well. Ultimately, we would rather make decisions that do not fall victim to the hubris of a single estimate and instead make informed decisions with measured uncertainty. For us, we seek to investigate all <strong>plausible</strong> parameter values for the square footage coefficient, not just one.</p>
<p>To highlight the idea of having multiple plausible lines, consider capturing the relationship between sales price and square footage using one of these 8 alternative lines (shown using dashed lines):</p>
<p><img src="images/clipboard-2200813982.png" class="img-fluid"></p>
<p><strong>Might these alternative lines also describe the relationship between square footage and the expected sales price of a house?</strong> Actually, they do seem reasonable - by golly, there should be multiple plausible lines. So instead of just defining one plausible line, let’s use Bayesian inference to get a posterior distribution over all plausible lines consistent with our model.</p>
<p>To get our posterior, the <code>numpyro</code> model is executed with additional arguments so that it runs longer to yield the posterior distribution (extra samples are needed to explore the posterior realm because both our measly 6 points of data and our weak prior leave a very large plausible space to explore):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_numpyro</span>(<span class="at">num_warmup =</span> <span class="dv">2000</span>, <span class="at">num_samples =</span> <span class="dv">5000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Our interest is in the slope of the plausible lines. Because different slope terms can dramatically affect where the line crosses the y-axis, the intercept term should be allowed to fluctuate. Instead of trying the difficult task of placing a prior on the intercept, we can just use a wide uniform prior where we know the line will be positively sloped and not too far from 0. A better way to do this is to transform x to represent the deviation from the average x. In this case, the intercept prior just represents our belief about the price of an average square footage house.</p>
</div>
</div>
<p>When analyzing the posterior distribution, we are really just interested in the slope coefficient (i.e.&nbsp;000’s per square foot), we just want a posterior distribution over <span class="math inline">\(\beta\)</span>. Visually, that posterior distribution can be retrieved by:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(beta) <span class="sc">|&gt;</span> </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows estimates around 0.120 are plausible, but does not clearly put the majority of plausibility above 0.120. While the estimates are most likely positive (most of the posterior density is where ), the percent above 0.120 will have to be calculated via a query of the posterior distribution:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">above120 =</span> <span class="fu">ifelse</span>(beta <span class="sc">&gt;</span> <span class="fl">0.120</span>,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">pctAbove120 =</span> <span class="fu">mean</span>(above120))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">pctAbove120</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.4146</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Yielding an approximate 41.9% probability for the company to at least break-even.</p>
<p>Interestingly, because of the uncertainty in the estimate, there is still meaningful probability that the company can earn much more than $120 per square foot, For example, here is the probability of being above $140 per square foot.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>critValue <span class="ot">=</span> <span class="fl">0.140</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">aboveCriticalValue =</span> </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(beta <span class="sc">&gt;</span> critValue,<span class="dv">1</span>,<span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">pctAbove =</span> <span class="fu">mean</span>(aboveCriticalValue))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">pctAbove</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2234</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>yielding an approximate 21.9% probability for the company to earn over a very favorable $140 per square foot.</p>
<p>In conclusion, there is still alot of uncertainty in the estimate of <span class="math inline">\(\beta\)</span>. Yet, the company needs to make a decision. If all relevant information has already been collected and BuildIt wants to be confident they will not lose money, then the best decision is to not invest in houses from this neighborhood. However, given the uncertainty in the estimate, this neighborhood certainly has the potential to be profitable. More data and/or more modelling assumptions will be the only ways to reduce that uncertainty and hence, be more confident in this opportunity. This makes sense - we only have six data points to go off of.</p>
</section>
<section id="adding-robustness" class="level3">
<h3 class="anchored" data-anchor-id="adding-robustness">Adding robustness</h3>
<p>When modelling, assumptions should reflect the reality you are trying to model. Use care traversing the business analytics bridge from real-world to math-world. For example, when it comes to housing prices, there might be alot of outliers in your data. Hence, it might be better to say that housing prices are Student-<span class="math inline">\(t\)</span> distributed about some expected sales price rather than normally distributed - this will make estimates much more robust to outliers. In a Bayesian context, model assumption changes are readily accomodated, we do not need new or special techniques. In the generative DAG we change the observed data distribution from Normal to Student-<span class="math inline">\(t\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Sales Price"</span>,<span class="st">"y"</span>,</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">student</span>(nu,mu,sigma),  <span class="do">###NEW DIST.</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>salesPrice) <span class="sc">|&gt;</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Deg. of Freedom"</span>,<span class="st">"nu"</span>,    <span class="do">###NEW NODE</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">2</span>,<span class="fl">0.1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Expected Sales Price"</span>,<span class="st">"mu"</span>,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Std. Dev."</span>,<span class="st">"sigma"</span>,</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">4</span>,<span class="fl">0.1</span>),</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Square Footage"</span>,<span class="st">"x"</span>,</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>sqFootage,</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>,</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="sc">-</span><span class="dv">100</span>,<span class="dv">175</span>)) <span class="sc">|&gt;</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Per SqFt Slope"</span>, <span class="st">"beta"</span>,</span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="fl">0.120</span>,<span class="fl">0.80</span>),</span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observations"</span>,<span class="st">"i"</span>,</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"y"</span>,<span class="st">"mu"</span>,<span class="st">"x"</span>))   </span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-a709d8c7d17cf4080686" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-a709d8c7d17cf4080686">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Deg. of Freedom\nnu ~ gamma(2,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Price Std. Dev.\nsigma ~ gamma(4,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Intercept\nalpha ~ uniform(-100,175)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Price Per SqFt Slope\nbeta ~ normal(0.12,0.8)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observations i [6]\"\n  \"1\" [label = \"Sales Price\ny ~ student(nu,mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Expected Sales Price\nmu = alpha + beta * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Square Footage\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"1\" [style = \"solid\"] \n\"5\"->\"3\" [style = \"solid\"] \n\"6\"->\"3\" [style = \"solid\"] \n\"7\"->\"3\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="explanatory-variable-centering" class="level3">
<h3 class="anchored" data-anchor-id="explanatory-variable-centering">Explanatory variable centering</h3>
<p>There are always mathematical tricks to do something a little better. In this book, we mostly shy away from the tricks to focus on the core creation process of generative DAGs. However, as you advance on in your BAW journey, you’ll see models leveraging these tricks as if they are common knowledge.</p>
<p><img src="images/clipboard-2232385158.png" class="img-fluid"></p>
<p>The trick we will use now is <em>centering an explanatory variable</em>. The plot above expands the regression line shown in the previous figure to show the y-intercept at the point <code>(0,58.9)</code> and two other lines that plausibly describe the data. Notice the wild swings in intercepts of these lines. We captured knowledge about these wild swings with the node below, but it does not feel natural.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="sc">-</span><span class="dv">100</span>,<span class="dv">175</span>)) <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-b93cfbc9973e359619ea" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-b93cfbc9973e359619ea">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"1\" [label = \"Intercept\nalpha ~ uniform(-100,175)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>After adding a centered column of square footage to <code>dataDF</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>dataDF <span class="ot">=</span> dataDF <span class="sc">|&gt;</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">centeredSqFootage =</span> </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>           sqFootage <span class="sc">-</span> <span class="fu">mean</span>(sqFootage))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can create the figure below:</p>
<p><img src="images/clipboard-2118476944.png" class="img-fluid"></p>
<p>By centering the <em>Square Footage</em> variable, we are effectively shifting the y-axis to be drawn in the middle of our <em>Square Footage</em> data, <span class="math inline">\(x\)</span>. More importantly, this transforms our interpretation of the y-intercept. Any line predicting expected sales price now intersects the y-axis at the average square footage. Hence, our y-intercept is the expected sales price of an average house. It is much easier for us to elicit assumptions about the average price of an average house than it is to imagine the meaning of the y-intercept for a zero square foot house. For our problem, we will say the average house gets sold in the $200K range, <span class="math inline">\(\alpha \sim N(200,50)\)</span>. The updated generative DAG is shown below:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Sales Price"</span>,<span class="st">"y"</span>,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">student</span>(nu,mu,sigma),  </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>salesPrice) <span class="sc">|&gt;</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Deg. of Freedom"</span>,<span class="st">"nu"</span>,    </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">2</span>,<span class="fl">0.1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Expected Sales Price"</span>,<span class="st">"mu"</span>,</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Std. Dev."</span>,<span class="st">"sigma"</span>,</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">gamma</span>(<span class="dv">4</span>,<span class="fl">0.1</span>),</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Cent. Square Footage"</span>,<span class="st">"x"</span>,  </span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dataDF<span class="sc">$</span>centeredSqFootage, <span class="do">## CHANGE</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>,</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">200</span>,<span class="dv">50</span>)) <span class="sc">|&gt;</span>  <span class="do">## CHANGE PRIOR</span></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Price Per SqFt Slope"</span>, <span class="st">"beta"</span>,</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="fl">0.120</span>,<span class="fl">0.80</span>),</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"mu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observations"</span>,<span class="st">"i"</span>,</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"y"</span>,<span class="st">"mu"</span>,<span class="st">"x"</span>))   </span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">|&gt;</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-20b8fc9c72093435cc6a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-20b8fc9c72093435cc6a">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"2\" [label = \"Deg. of Freedom\nnu ~ gamma(2,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Price Std. Dev.\nsigma ~ gamma(4,0.1)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Intercept\nalpha ~ normal(200,50)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Price Per SqFt Slope\nbeta ~ normal(0.12,0.8)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observations i [6]\"\n  \"1\" [label = \"Sales Price\ny ~ student(nu,mu,sigma)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Expected Sales Price\nmu = alpha + beta * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Cent. Square Footage\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"1\" [style = \"solid\"] \n\"5\"->\"3\" [style = \"solid\"] \n\"6\"->\"3\" [style = \"solid\"] \n\"7\"->\"3\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">|&gt;</span> </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_numpyro</span>(<span class="at">num_warmup =</span> <span class="dv">2000</span>, <span class="at">num_samples =</span> <span class="dv">5000</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">|&gt;</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-111-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get 20 draws from posterior</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>plotDF <span class="ot">=</span> drawsDF <span class="sc">|&gt;</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">20</span>)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_lm</span>(salesPrice <span class="sc">~</span> centeredSqFootage, <span class="at">data =</span> dataDF) <span class="sc">|&gt;</span> <span class="fu">gf_point</span>() <span class="sc">|&gt;</span> </span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_abline</span>(<span class="at">intercept =</span> <span class="sc">~</span> alpha, <span class="at">slope =</span> <span class="sc">~</span> beta, <span class="at">data =</span> plotDF, <span class="at">alpha =</span> .<span class="dv">25</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-112-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>and realize that there are lots of lines that look plausible through our data. Build-it is going to need more data before they can be confident about the relationship between price and square footage.</p>
<p>More generally, please start to think of Bayesian models as things you, as a Business Analyst, get to create. As long as you are mimicking reality with your models, you will find great success taking the building blocks you know and building models of increasing complexity that capture further nuances of the real-world. These models are yours to build - go boldly and make tailored models of the world you work in!</p>
</section>
<section id="getting-more-help" class="level3">
<h3 class="anchored" data-anchor-id="getting-more-help">Getting more help</h3>
<p>Richard McElreath’s course uses <code>Stan</code> instead of <code>causact</code> and <code>numpyro</code>, yet outside of the computational engine, the material is relevant to your study. I highly recommend his lesson on linear models (see <a href="https://youtu.be/0biewTNUBP4" class="uri">https://youtu.be/0biewTNUBP4</a>). If you have the time, watch from the beginning. If you want to zero in on the simple linear model, he creates the first linear model trying to predict height as a function of weight at 43:00.</p>
</section>
</section>
<section id="linear-predictors-and-inverse-link-functions" class="level2">
<h2 class="anchored" data-anchor-id="linear-predictors-and-inverse-link-functions">Linear predictors and inverse link functions</h2>
<p>We are learning building blocks for making models of data-generating processes. Each block is used to make some mathematical representation of the real-world. The better our representations, the better our insights. We have almost all the building blocks we need, latent nodes, observed nodes, calculated nodes, edges, plates, linear models, and probability distributions, but this section introduces one last powerful building block - the inverse link function.</p>
<section id="linear-predictors" class="level3">
<h3 class="anchored" data-anchor-id="linear-predictors">Linear predictors</h3>
<p>We focus on restricting the <em>range</em> of linear predictors. The <em>range</em> of a function is the set of values that the function can give as output. For a linear predictor with non-zero slope, this range is any number from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span>.</p>
<p>A linear predictor for data observation, <span class="math inline">\(i\)</span> , is any function expressible in this form:</p>
<p><span class="math display">\[
f(x_{i1},x_{i2},\ldots,x_{in}) = \alpha + \beta_1 * x_{i1} + \beta_2 * x_{i2} + \cdots + \beta_n * x_{in}
\]</span></p>
<p>where <span class="math inline">\(x_{i1},x_{i2},\ldots,x_{in}\)</span> is the <span class="math inline">\(i^{th}\)</span> observation of a set of <span class="math inline">\(n\)</span> explanatory variables, <span class="math inline">\(\alpha\)</span> is the base-level output when all the explanatory variables are zero (e.g.&nbsp;y-intercept when <span class="math inline">\(n=1\)</span>), and <span class="math inline">\(\beta_j\)</span> the coefficient for the <span class="math inline">\(j^{th}\)</span> explanatory variable (<span class="math inline">\(j \in {1,2,\ldots,n}\)</span>). When <span class="math inline">\(n = 1\)</span>, this is just the equation of a line as in the last section. When there is more than one explanatory variable, we are making a function with <em>high-dimensional</em> input - meaning the input includes multiple explanatory RV realizations per observed row. High-dimensional functions are no longer easily plotted, but the interpretation of the coefficients remain consistent with our intuition.</p>
<p>Explanatory variable effects are fully summarized in the corresponding coefficients, <span class="math inline">\(\beta\)</span>. If an individual coefficient <span class="math inline">\(\beta\)</span> is positive, the linear prediction increases by <span class="math inline">\(\beta\)</span> units for each unit change in the explanatory variable. For example, we thought it plausible for the expected sales price of a home to go up by $120 for every additional square foot; 10 additional square feet, then the home value increases $1,200; 100 additional square feet, then the home value increases $12,000. You can continue this logic ad-nauseum until you have infinitely big houses with infinite home prices. The takeaway is that linear predictors, in theory, can take on values anywhere from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span>.</p>
</section>
<section id="inverse-link-functions" class="level3">
<h3 class="anchored" data-anchor-id="inverse-link-functions">Inverse link functions</h3>
<p>An inverse link function takes linear predictor output, which ranges from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span>, and confines it in some way to a different scale. For example, if we want to use many explanatory variables to explain success probability, our method will be to estimate a linear predictor and then, transform it so its value is forced to lie between zero and 1 (i.e.&nbsp;match the domain over which probabilities exist). More generally, inverse link functions are used to make linear predictors map to predicted values that are on a different scale. For our purposes, we will look at two specific inverse link functions:</p>
<ol type="1">
<li><em>Exponential</em>: The exponential function converts a linear predictor of the form <span class="math inline">\(\alpha + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_n x_n\)</span> into a curve that is restricted to values between 0 and <span class="math inline">\(\infty\)</span>. This is useful for converting a linear predictor into a non-negative value. For example, the rate of tickets issued in New York city can be modeled by taking a linear predictor for tickets and turning it into a non-negative rate of ticket issuance. If we label the linear predictor value <span class="math inline">\(y\)</span> and the transformed value <span class="math inline">\(\lambda\)</span>, the exponential function converting <span class="math inline">\(y\)</span> to <span class="math inline">\(\lambda\)</span> is defined here:</li>
</ol>
<p><span class="math display">\[
\lambda = \exp(y) = \exp(\alpha + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_n x_n)
\]</span></p>
<ol start="2" type="1">
<li><em>Inverse Logit</em> (aka logistic): This function provides a way to convert a linear predictor of the form <span class="math inline">\(\alpha + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_n x_n\)</span> into a curve that is restricted to values between 0 and 1. This is useful for converting a linear predictor to a probability. If we label the linear predictor value <span class="math inline">\(y\)</span> and the transformed value <span class="math inline">\(\theta\)</span>, the inverse logit function converting <span class="math inline">\(y\)</span> to <span class="math inline">\(\theta\)</span> is defined here (note the negative sign):</li>
</ol>
<p><span class="math display">\[
\theta = \frac{1}{1+\exp(-y)}= \frac{1}{1+\exp(-(\alpha + \beta_1 x_1 + \beta_2 x_2 + \ldots + \beta_n x_n))}
\]</span></p>
<p>While the beauty of these functions is that it allows us to use the easily-understood linear model form and still also have a form that is useful in a generative DAG. The downside is we lose interpretability of the coefficients. The only thing we get to say easily is that higher values of the linear predictor correspond to higher values of the transformed output.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When communicating the effects of explanatory variables that are put through inverse link functions, you should either: 1) simulate observed data using the prior or posterior’s generative recipe, or 2) consult one of the more rigorous texts on Bayesian data analysis for some mathematical tricks to interpreting generative recipes with these inverse link functions (see references at end of book).</p>
</div>
</div>
<section id="exponential-function" class="level4">
<h4 class="anchored" data-anchor-id="exponential-function">Exponential function</h4>
<p>The generative DAG below is a generic example of a Poisson count variable and makes the expected rate of occurrence a function of an explanatory variable:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Count Data"</span>,<span class="st">"k"</span>,</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">poisson</span>(rate),</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Exp Rate"</span>,<span class="st">"rate"</span>,</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">exp</span>(y),</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Linear Predictor"</span>,<span class="st">"y"</span>,</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x,</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"rate"</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Explantory Var Coeff"</span>,<span class="st">"beta"</span>,</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Observed Expl Var"</span>,<span class="st">"x"</span>,</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"rate"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-0a1833198698d6599fd3" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-0a1833198698d6599fd3">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"4\" [label = \"Intercept\nalpha\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Explantory Var Coeff\nbeta\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i\"\n  \"1\" [label = \"Count Data\nk ~ poisson(rate)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Exp Rate\nrate = exp(y)\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Linear Predictor\ny = alpha + beta * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Observed Expl Var\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"2\" [style = \"solid\"] \n\"4\"->\"3\" [style = \"solid\"] \n\"5\"->\"3\" [style = \"solid\"] \n\"6\"->\"3\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The inverse link function transformation takes place in the node for <code>rate</code>. The linear predictor, <span class="math inline">\(y\)</span>, can take on any value from <span class="math inline">\(-\infty\)</span> to <span class="math inline">\(\infty\)</span>, but as soon as it is transformed with the exponential function, it can only be a positive number. This transformation is shown in the figure below where positive and negative x-axis values become solely positive y-axis values.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3504728207.png" class="img-fluid figure-img"></p>
<figcaption>Graph of the exponential function. The linear predictor in our case is alpha + beta * x. The role of the exp function is to map this linear predictor to a scale that is non-negative. This essentially takes any number from -infinity to infinity and provides a positive number as an output.</figcaption>
</figure>
</div>
<p>From this figure, we see that negative values of the linear predictor are transformed into values of rate between 0 and 1 and positive values of the linear predictor get transformed into rate values greater than 1. Notice this transformation is non-linear, and hence caution must be used interpreting the slope coefficients of the linear predictor.</p>
</section>
<section id="inverse-logit" class="level4">
<h4 class="anchored" data-anchor-id="inverse-logit">Inverse logit</h4>
<p>The generative DAG below is a generic example which leverages the inverse logit link function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">|&gt;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Bernoulli Data"</span>,<span class="st">"z"</span>,</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">bernoulli</span>(theta),</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Success Probability"</span>,<span class="st">"theta"</span>,</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y)),</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"z"</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Linear Predictor"</span>,<span class="st">"y"</span>,</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x,</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"theta"</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Explantory Var Coeff"</span>,<span class="st">"beta"</span>,</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Observed Expl Var"</span>,<span class="st">"x"</span>,</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>,</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">obs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"z"</span>,<span class="st">"theta"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-fc9738c86864160d6d85" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-fc9738c86864160d6d85">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"4\" [label = \"Intercept\nalpha\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Explantory Var Coeff\nbeta\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Observation i\"\n  \"1\" [label = \"Bernoulli Data\nz ~ bernoulli(theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Success Probability\ntheta = 1 / (1 + exp(-y))\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Linear Predictor\ny = alpha + beta * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"6\" [label = \"Observed Expl Var\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"2\" [style = \"solid\"] \n\"4\"->\"3\" [style = \"solid\"] \n\"5\"->\"3\" [style = \"solid\"] \n\"6\"->\"3\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Note the inverse link function transformation takes place in the node for <code>theta</code>. To start to get a feel for what this transformation does, observe the figure below. When the linear predictor is zero, the associated probability is 50%. Increasing the linear predictor will increase the associated probability, but with diminishing effect. When the linear predictor is increased by one unit from say 1 to 2, the corresponding probability goes from about 73% to 88% (i.e.&nbsp;from to ). This is a 15% jump. However, increasing the linear predictor by one additional unit has probability go from 88% to 95% - only a 7% jump. Further increasing the linear predictor has diminishing effect. Likewise, large negative values in the linear predictor lead to ever-closer to zero values for probability.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3967822332.png" class="img-fluid figure-img"></p>
<figcaption>Graph of the inverse logit function (aka the logistic function). The linear predictor in our case is alpha + beta * x. The role of the inverse logit function is to map this linear predictor to a scale bounded by zero and one. This essentailly takes any number from -infinity to infinty and provides a probability value as an output.</figcaption>
</figure>
</div>
<p>Almost anytime you are modelling a probability as a function of many explanatory variables, using the inverse logit-link function is an obvious choice to make the mathematics work.</p>
<p>The use of the inverse logit function is done inside a method called logistic regression. Check out this sequence of videos that begin here (<a href="https://youtu.be/zAULhNrnuL4" class="uri">https://youtu.be/zAULhNrnuL4</a>) on logistic regression for some additional insight.</p>
<p>You have officially been exposed to all the building blocks you need for executing Bayesian inference of ever-increasing complexity. These include latent nodes, observed nodes, calculated nodes, edges, plates, probability distributions, linear predictors, and inverse-link functions. While you have not seen every probability distribution or every inverse-link function, you have now seen enough that you should be able to digest new instances of these things. In the next chapter, we seek to build confidence by increasing the complexity of the business narrative and the resulting generative DAG to yield insights. Insights you might not even have thought possible!</p>
</section>
</section>
</section>
<section id="multi-level-modeling" class="level2">
<h2 class="anchored" data-anchor-id="multi-level-modeling">Multi-level modeling</h2>
<blockquote class="blockquote">
<p>Crossfit Gyms is growing - they started the year with 5 locations and have more than doubled in size in the last five months. Additionally, Crossfit Gyms has secured funding to open 100 more gyms over the next year. Their key recruitment mechanism is to offer free trial memberships that last a calendar month, but management is unsure how to measure the success of this trial. Additionally, some gyms have been randomly chosen to increase the stretching, called “Yoga Stretch”, done during these trial classes. Crossfit Gyms is unsure whether this has helped convert trial customers into memberships. The theory is that new members, typically less athletic than current clients, benefit from the additional stretching and are more likely to enjoy the additional stretch time.</p>
</blockquote>
<p>Our task is to help Crossfit Gyms understand the effect of its trial membership program and whether additional stretching leads to better conversion of free-trial customers into paying members. As we go through this example, we will explore three different ways to model the problem:</p>
<ol type="1">
<li><p><strong>Complete Pooling</strong>: This modelling method will <em>pool</em> or aggregate all the data for all the gyms. It will model two conversions rate for the entire franchise - one with yoga stretching and one without.</p></li>
<li><p><strong>No Pooling</strong>: This method will treat each gym individually with the underlying assumption that the two conversion rates (with and without yoga) at one gym are completely independent of conversion rates at every other gym.</p></li>
<li><p><strong>Partial Pooling</strong>: Under partial pooling, we assume each gym’s two conversion rates have both a unique component (like the no pooling case) as well as a component that is dictated by company-wide policies (like the complete pooling case). Hint: This is the case we will always use as the other two cases are subsets of these types of models.</p></li>
</ol>
<section id="the-gym-data" class="level3">
<h3 class="anchored" data-anchor-id="the-gym-data">The gym data</h3>
<p>Crossfit Gyms does not have alot of data, so let’s look at it.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"gymDF"</span>)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>gymDF</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">gymID</th>
<th style="text-align: right;">timePeriod</th>
<th style="text-align: right;">nTrialCustomers</th>
<th style="text-align: right;">nSigned</th>
<th style="text-align: right;">yogaStretch</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">56</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">79</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">86</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>When thinking about visualizing this dataset, we need to understand that each row represents a particular gym (<code>gymID</code>) running one month of free trial classes.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>gymDF <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gymID) <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">numberOfObservations =</span> <span class="fu">n</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">gymID</th>
<th style="text-align: right;">numberOfObservations</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We discover that we have twelve unique gyms; the first 5 gyms give us five months of data each, while the next seven have less data (ranging from one to four free-trial months).</p>
<p>Since the small <code>gymdDF</code> data frame consists of only five variables, I am confident that I can map all five to aesthetics and show all the data using one plot command. After several iterations of plots (excluded here), here is one way to do that:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>plotDF <span class="ot">=</span> gymDF <span class="sc">%&gt;%</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stretchType =</span> </span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(yogaStretch <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Yoga Stretch"</span>, </span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Traditional"</span>))</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plotDF, </span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> timePeriod, <span class="co">#map time to x-axis</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> nTrialCustomers, <span class="co">#map numTrials to y-axis</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> stretchType <span class="co">#map fill to stretch type</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>                  )) <span class="sc">+</span> </span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.75</span>, </span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.55</span>) <span class="sc">+</span>  <span class="co"># use transparency</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.75</span>, </span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">y =</span> nSigned)) <span class="sc">+</span> <span class="co"># different y-mapping</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(gymID), <span class="at">labeller =</span> label_both) <span class="sc">+</span> </span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="dv">11</span>) <span class="sc">+</span> </span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.caption =</span> </span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>, <span class="at">face =</span> <span class="st">"italic"</span>),</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"# of Trial Customers"</span>) <span class="sc">+</span></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> </span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Darker fill for # of sign-ups."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-117-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can see from the figure above that the recruitment rate at each gym, represented by the proportion of dark fill to lighter fill, seems pretty consistent. However, there is apparent high variability across gyms. For example, <code>gymID: 2</code> seems to be a consistently poor performer while <code>gymID: 5</code> is somehow able to consistently make more conversions from free trials to paying memberships.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Talking to the managers of these gyms to understand the differences in performance should be high on your to-do list, but for now (and because we do not have access to these managers), we will stick with the data that is available.</p>
</div>
</div>
<p>In terms of providing insight as to recruitment rates and the effect of extra yoga stretching (indicated by fill color), the visualization can only go so far. Yes, we can say <code>gymID: 5</code> outperforms <code>gymID: 2</code>, but with only five months of data, how can we quantify our uncertainty about the differences? Additionally, yoga stretching seems to lead to better conversion rates, but how confident should we be given the seemingly small amounts of data?</p>
</section>
<section id="complete-pooling" class="level3">
<h3 class="anchored" data-anchor-id="complete-pooling">Complete pooling</h3>
<p>The complete pooling model considers all observations to come from identical probability distributions; it does not differentiate based on <code>gymID</code> or <code>timePeriod</code>. Hence, all 44 observations behave as if they come from a single gym’s generative model. For this generative model, the unobserved parameter <code>theta</code> will be the only distinguishing feature. It takes one value for a traditional stretching class and another value for a yoga stretching class.</p>
<p>Under the complete pooling assumption, there is enough data that empirical estimates provide good probability estimates for the conversion rates by class type:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>gymDF <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(yogaStretch) <span class="sc">%&gt;%</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">nTrials =</span> <span class="fu">sum</span>(nTrialCustomers),</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">nSuccess =</span> <span class="fu">sum</span>(nSigned)) <span class="sc">%&gt;%</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pctSuccess =</span> nSuccess <span class="sc">/</span> nTrials)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">yogaStretch</th>
<th style="text-align: right;">nTrials</th>
<th style="text-align: right;">nSuccess</th>
<th style="text-align: right;">pctSuccess</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1675</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">0.2388</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">630</td>
<td style="text-align: right;">219</td>
<td style="text-align: right;">0.3476</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Here, we see that conversion rates seem to rise with the additional stretching from a base rate of 23.9% to 34.8%.</p>
<p>The figure below shows the generative DAG for complete pooling. Despite not being a very good model for reasons we will see, it still provides a posterior with seemingly small uncertainty:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">%&gt;%</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Signups"</span>,<span class="st">"k"</span>,</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">binomial</span>(nTrials,theta),</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nSigned) <span class="sc">%&gt;%</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Signup Probability"</span>,<span class="st">"theta"</span>,</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">beta</span>(<span class="dv">2</span>,<span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Trials"</span>,<span class="st">"nTrials"</span>,</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nTrialCustomers) <span class="sc">%&gt;%</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Yoga Stretch Flag"</span>,<span class="st">"x"</span>,</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>yogaStretch,</span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">nodeLabels =</span> <span class="st">"theta"</span>,</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">addDataNode =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"x"</span>,<span class="st">"nTrials"</span>))</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>graph <span class="sc">%&gt;%</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-5a80d96970b9501c191a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-5a80d96970b9501c191a">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\nsubgraph cluster1{\nlabel=\"Observation i [44]\"\n  \"1\" [label = \"Number of Signups\nk ~ binomial(nTrials,theta[x])\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Number of Trials\nnTrials\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Yoga Stretch Flag\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\nsubgraph cluster2{\nlabel=\"Yoga Stretch Flag x [2]\"\n  \"2\" [label = \"Signup Probability\ntheta ~ beta(2,2)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\n\"2\"->\"1\" [style = \"dashed\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"1\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Notice that the graphical model has four random variables. Three of them are observed and enclosed in a plate labelled <code>Observation i</code>. This plate means that for each observation in our data (i.e.&nbsp;one of the 44 unique gym/time period rows in <code>gymDF</code>) , there are three observed random variables: 1) Number of signups (<code>k</code>), 2) Number of Trial Customers (<code>nTrials</code>), and 3) a flag indicating whether yoga stretch ws used or not (<code>x</code>). In contrast, the plate around Signup Probability, labelled <em>Yoga Stretch Flag</em>, indicates we have two random variables for Signup Probability: 1) a Signup Probability for traditional Stretching (i.e.&nbsp;probability when <code>x=0</code>) and 2) a Signup Probability for yoga Stretching (i.e.&nbsp;probability when <code>x=1</code>). In other words, all gyms have the same two success probabilities associated with them; we call this <em>complete pooling</em> of the gyms as according to the model, each gym is identical. We know this is a ridiculous assumption from visualizing the data, but we use this to illustrate that there are very meaningful assumptions tied to each graphical model we make.</p>
<p>Computationally, we go through the standard process to get our posterior and then we look at our posterior draws. Estimated signup probability for yoga stretching (about 35%) seems to range higher than without yoga (less than 25%).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph <span class="sc">%&gt;%</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">%&gt;%</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-121-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Perhaps, the fact that these probability estimates align with the emprical estimates (above) should seem comforting, but there is something sinister lurking in our model choice. Recall that our visual sensibilities have already noticed differences among the gyms. So, it should be expected that we are not accurately modeling the data generation process when ignoring these differences. By performing a posterior predictive check, we see how looking at this overly simple <em>complete pooling</em> model fails to capture some of the patterns observed in the actual data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>paramsDF <span class="ot">=</span> drawsDF <span class="sc">|&gt;</span> <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">20</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>paramsDF</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">theta_0</th>
<th style="text-align: right;">theta_1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2485</td>
<td style="text-align: right;">0.3573</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2350</td>
<td style="text-align: right;">0.3523</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2510</td>
<td style="text-align: right;">0.3333</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2597</td>
<td style="text-align: right;">0.3503</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2369</td>
<td style="text-align: right;">0.3445</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2526</td>
<td style="text-align: right;">0.3727</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2266</td>
<td style="text-align: right;">0.3610</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2476</td>
<td style="text-align: right;">0.3567</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2322</td>
<td style="text-align: right;">0.3456</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2381</td>
<td style="text-align: right;">0.3508</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2470</td>
<td style="text-align: right;">0.3484</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2275</td>
<td style="text-align: right;">0.3769</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2381</td>
<td style="text-align: right;">0.3843</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2435</td>
<td style="text-align: right;">0.3584</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2390</td>
<td style="text-align: right;">0.3605</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2406</td>
<td style="text-align: right;">0.3551</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2417</td>
<td style="text-align: right;">0.3343</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2207</td>
<td style="text-align: right;">0.3522</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2360</td>
<td style="text-align: right;">0.3685</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2371</td>
<td style="text-align: right;">0.3161</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>simData <span class="ot">&lt;-</span> <span class="cf">function</span>(theta_0, theta_1, data) {</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  simData <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">signupProb =</span> <span class="fu">ifelse</span>(yogaStretch <span class="sc">==</span> <span class="dv">0</span>, theta_0, theta_1)) <span class="sc">%&gt;%</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nSigned =</span> <span class="fu">rbinom</span>(</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> nTrialCustomers,</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob =</span> signupProb</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(nSigned)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> paramsDF <span class="sc">|&gt;</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simID =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">simData =</span> <span class="fu">list</span>(<span class="fu">simData</span>(theta_0, theta_1, gymDF))) <span class="sc">|&gt;</span> </span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>d</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">theta_0</th>
<th style="text-align: right;">theta_1</th>
<th style="text-align: right;">simID</th>
<th style="text-align: left;">simData</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.2485</td>
<td style="text-align: right;">0.3573</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">6, 14, 9, 20, 14, 10, 14, 12, 19, 17, 1, 10, 15, 13, 13, 3, 29, 19, 6, 14, 18, 17, 6, 16, 19, 16, 25, 4, 19, 15, 13, 25, 9, 23, 15, 22, 26, 8, 11, 13, 11, 18, 22, 12</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2350</td>
<td style="text-align: right;">0.3523</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">7, 11, 6, 17, 19, 12, 16, 9, 20, 19, 3, 10, 22, 11, 16, 14, 26, 16, 5, 16, 20, 18, 10, 12, 14, 13, 13, 7, 15, 20, 12, 13, 13, 14, 18, 23, 23, 7, 10, 9, 6, 10, 14, 8</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2510</td>
<td style="text-align: right;">0.3333</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">11, 18, 8, 18, 19, 13, 15, 13, 11, 23, 4, 14, 22, 10, 21, 10, 24, 25, 5, 16, 18, 13, 9, 10, 16, 15, 26, 4, 18, 23, 9, 13, 11, 19, 14, 17, 27, 3, 11, 19, 10, 15, 20, 10</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2597</td>
<td style="text-align: right;">0.3503</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">6, 16, 8, 16, 23, 13, 20, 14, 15, 14, 5, 11, 21, 13, 13, 5, 28, 27, 4, 11, 18, 23, 10, 16, 14, 18, 21, 4, 19, 22, 11, 19, 9, 25, 21, 19, 28, 4, 10, 15, 10, 13, 18, 6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2369</td>
<td style="text-align: right;">0.3445</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">5, 12, 7, 18, 23, 7, 15, 12, 11, 12, 4, 11, 16, 12, 15, 11, 25, 12, 4, 16, 27, 20, 9, 19, 16, 16, 23, 3, 19, 11, 13, 20, 11, 14, 18, 31, 30, 5, 12, 19, 10, 12, 19, 8</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2526</td>
<td style="text-align: right;">0.3727</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">12, 12, 11, 15, 24, 4, 24, 8, 19, 19, 5, 13, 21, 14, 17, 6, 35, 15, 4, 14, 22, 17, 12, 13, 12, 27, 23, 9, 18, 14, 15, 15, 10, 15, 13, 27, 22, 7, 13, 12, 10, 12, 25, 11</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2266</td>
<td style="text-align: right;">0.3610</td>
<td style="text-align: right;">7</td>
<td style="text-align: left;">3, 14, 8, 9, 16, 8, 17, 11, 19, 17, 7, 16, 30, 14, 18, 10, 31, 12, 7, 9, 27, 26, 4, 8, 21, 24, 22, 3, 15, 21, 10, 21, 12, 20, 9, 24, 30, 1, 10, 18, 11, 13, 19, 11</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2476</td>
<td style="text-align: right;">0.3567</td>
<td style="text-align: right;">8</td>
<td style="text-align: left;">10, 16, 6, 12, 26, 10, 14, 6, 20, 16, 5, 11, 20, 14, 14, 8, 22, 27, 6, 13, 22, 22, 14, 16, 14, 15, 18, 6, 13, 12, 10, 21, 11, 13, 12, 24, 26, 3, 8, 21, 12, 15, 19, 9</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2322</td>
<td style="text-align: right;">0.3456</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">10, 12, 8, 12, 21, 4, 17, 6, 15, 12, 4, 7, 19, 9, 17, 9, 23, 19, 9, 11, 18, 24, 12, 14, 17, 16, 23, 4, 13, 18, 14, 24, 10, 14, 16, 20, 27, 8, 8, 12, 8, 11, 19, 6</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2381</td>
<td style="text-align: right;">0.3508</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">9, 16, 10, 15, 15, 13, 15, 14, 10, 13, 3, 14, 17, 9, 14, 6, 34, 17, 3, 14, 15, 19, 13, 16, 13, 19, 18, 3, 11, 21, 12, 11, 13, 14, 13, 22, 23, 6, 17, 19, 9, 12, 13, 10</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2470</td>
<td style="text-align: right;">0.3484</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">6, 16, 10, 15, 14, 10, 17, 9, 21, 16, 3, 10, 21, 11, 18, 8, 24, 14, 8, 13, 21, 18, 13, 11, 17, 18, 21, 5, 14, 13, 17, 13, 6, 9, 12, 31, 25, 8, 13, 20, 9, 15, 14, 13</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2275</td>
<td style="text-align: right;">0.3769</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">6, 17, 10, 12, 20, 11, 19, 11, 12, 17, 1, 10, 19, 12, 15, 12, 29, 13, 3, 12, 22, 27, 14, 12, 18, 14, 16, 7, 21, 12, 8, 14, 12, 15, 22, 30, 19, 4, 11, 17, 10, 9, 15, 6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2381</td>
<td style="text-align: right;">0.3843</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">5, 9, 9, 11, 16, 10, 12, 9, 14, 20, 4, 12, 12, 12, 15, 13, 16, 18, 7, 12, 25, 23, 14, 16, 15, 17, 19, 3, 12, 16, 14, 13, 12, 18, 16, 32, 24, 4, 13, 20, 9, 12, 16, 8</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2435</td>
<td style="text-align: right;">0.3584</td>
<td style="text-align: right;">14</td>
<td style="text-align: left;">6, 14, 9, 13, 18, 5, 19, 7, 14, 16, 7, 10, 19, 8, 15, 6, 26, 16, 7, 13, 20, 16, 11, 12, 13, 15, 20, 5, 13, 18, 8, 17, 10, 21, 11, 29, 28, 3, 11, 16, 10, 18, 16, 16</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2390</td>
<td style="text-align: right;">0.3605</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">9, 13, 10, 11, 25, 4, 15, 6, 16, 18, 6, 12, 14, 9, 13, 5, 33, 24, 8, 12, 19, 22, 15, 12, 19, 15, 17, 3, 14, 23, 14, 17, 9, 27, 19, 30, 30, 2, 9, 11, 13, 17, 23, 10</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2406</td>
<td style="text-align: right;">0.3551</td>
<td style="text-align: right;">16</td>
<td style="text-align: left;">3, 17, 8, 17, 21, 12, 12, 10, 22, 16, 4, 11, 17, 11, 13, 10, 20, 19, 2, 14, 23, 18, 7, 17, 19, 21, 17, 3, 19, 15, 15, 24, 8, 19, 13, 23, 24, 2, 12, 18, 15, 7, 17, 10</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2417</td>
<td style="text-align: right;">0.3343</td>
<td style="text-align: right;">17</td>
<td style="text-align: left;">6, 14, 3, 10, 26, 11, 19, 21, 11, 12, 5, 13, 17, 10, 16, 10, 24, 17, 6, 17, 23, 16, 12, 15, 11, 14, 16, 3, 14, 18, 12, 13, 7, 13, 11, 23, 17, 8, 7, 19, 6, 8, 16, 11</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2207</td>
<td style="text-align: right;">0.3522</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">5, 12, 8, 8, 23, 9, 17, 9, 11, 11, 6, 15, 13, 10, 10, 2, 23, 19, 6, 14, 14, 19, 12, 17, 19, 16, 19, 6, 14, 18, 10, 17, 15, 16, 19, 19, 19, 4, 4, 11, 13, 9, 17, 7</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.2360</td>
<td style="text-align: right;">0.3685</td>
<td style="text-align: right;">19</td>
<td style="text-align: left;">4, 10, 10, 13, 21, 4, 23, 8, 19, 14, 2, 10, 19, 10, 12, 12, 28, 18, 7, 8, 16, 25, 14, 11, 20, 16, 23, 6, 15, 17, 13, 17, 14, 16, 19, 30, 28, 6, 8, 24, 9, 13, 14, 5</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.2371</td>
<td style="text-align: right;">0.3161</td>
<td style="text-align: right;">20</td>
<td style="text-align: left;">11, 18, 10, 8, 21, 5, 22, 13, 14, 22, 7, 12, 16, 8, 12, 7, 23, 14, 2, 11, 16, 20, 8, 12, 14, 12, 25, 4, 13, 17, 15, 10, 10, 24, 17, 18, 18, 2, 15, 17, 8, 13, 18, 7</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>d <span class="sc">|&gt;</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(simID, simData) <span class="sc">|&gt;</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_longer</span>(simData) <span class="sc">|&gt;</span> <span class="co"># flatten list-column to numeric values</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_dens</span>(<span class="sc">~</span> simData, <span class="at">color =</span> <span class="sc">~</span> <span class="fu">factor</span>(simID)) <span class="sc">|&gt;</span> </span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_dens</span>(<span class="sc">~</span> nSigned, <span class="at">data =</span> gymDF, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">inherit =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-125-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure above shows the observed data density plot across gyms as represented by the dark blue line. This observed distribution is not captured by the spaghetti lines, i.e.&nbsp;predicted distributions from the posterior, none of the 20 sample predicted distributions come close to mimicking the behavior seen in the actual data. This is a clear signal we are not modelling something right; namely each gym will have some differences in recruiting probabilities, and hence, produce more varied amounts of success than suggested by the complete pooling model.</p>
</section>
<section id="no-pooling" class="level3">
<h3 class="anchored" data-anchor-id="no-pooling">No pooling</h3>
<p>The no pooling model treats each gym as distinct completely independent entities, i.e.&nbsp;the Crossfit Gym franchise has no overarching effect on success probabilities. Thus, learning about one gym’s success in recruiting tells us nothing about the population of gyms or any other specific gym.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The no pooling model is shown for the contrast it provides in relation to other models we will look at; it is an ill-advised model when you have small data and transferable learning. We will assume learning about one gym’s success rate should impact our opinion about another gym’s success rate - we do not want each gym to be distinct.</p>
</div>
</div>
<p>On our path to modelling the effects of yoga, we are going to refine our previous generative DAG to get closer to the business narrative. Specifically, we want to ensure a direct modelling of the effect of yoga stretching.</p>
<p>We are going to assume there is a base-level of recruitment at each gym and that yoga stretching provides some deviation from the base. If we were to model the deviation as a probability deviation, say yoga increases recruitment probability 20%, than its possible that forecasting the effect of yoga at a gym with a base recruitment rate of 85% leads to 105% sign-up probability - this is a problem as probability of signup cannot be over 100%.</p>
<p>To remedy this, we use a linear predictor as input into an inverse logit link function; it ensures signup probability draws are actually probability values between 0 and 1. This new generative story with base recuitment probability and deviation for yoga is reflected in the following generative DAG:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>graph2 <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Signups"</span>,<span class="st">"k"</span>,</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">binomial</span>(nTrials,theta),</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nSigned) <span class="sc">%&gt;%</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Signup Probability"</span>,<span class="st">"theta"</span>,</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y))) <span class="sc">%&gt;%</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Trials"</span>,<span class="st">"nTrials"</span>,</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nTrialCustomers) <span class="sc">%&gt;%</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Linear Predictor"</span>,<span class="st">"y"</span>,</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x,</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"theta"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Yoga Stretch Flag"</span>,<span class="st">"x"</span>,</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>yogaStretch,</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">1.5</span>),</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Yoga Slope Coeff"</span>,<span class="st">"beta"</span>,</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.75</span>),</span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Gym"</span>,<span class="st">"j"</span>,</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>),</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> gymDF<span class="sc">$</span>gymID,</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">addDataNode =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"x"</span>,<span class="st">"j"</span>,</span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"nTrials"</span>,<span class="st">"theta"</span>,<span class="st">"y"</span>))</span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>graph2 <span class="sc">%&gt;%</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-d406bbf49928d385f1dd" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d406bbf49928d385f1dd">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\nsubgraph cluster1{\nlabel=\"Gym j [12]\"\n  \"6\" [label = \"Intercept\nalpha ~ normal(-1,1.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Yoga Slope Coeff\nbeta ~ normal(0,0.75)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\nsubgraph cluster2{\nlabel=\"Observation i [44]\"\n  \"1\" [label = \"Number of Signups\nk ~ binomial(nTrials,theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Signup Probability\ntheta = 1 / (1 + exp(-y))\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Number of Trials\nnTrials\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Linear Predictor\ny = alpha[j] + beta[j] * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Yoga Stretch Flag\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"8\" [label = \"Gym\nj\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"6\"->\"4\" [style = \"dashed\"] \n\"7\"->\"4\" [style = \"dashed\"] \n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"2\" [style = \"solid\"] \n\"5\"->\"4\" [style = \"solid\"] \n\"8\"->\"4\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>This generative DAG has slope and intercept terms that are not directly understandable - they go through an inverse logit function before we see their impact on a node that we can understand. To understand the prior on these terms (or any prior), we simulate how its values are transferred to a parameter of interest, in this case that parameter is signup probability.</p>
<section id="using-prior-predictive-checks-to-help-choose-priors" class="level4">
<h4 class="anchored" data-anchor-id="using-prior-predictive-checks-to-help-choose-priors">Using prior predictive checks to help choose priors</h4>
<p>Unfortunately, I am always writing custom code to explore the effect of priors on the children of transformed linear predictors. This part of the BAW process will be accelerated in future versions of <code>causact</code>. Until then, here is some code to help find a good <code>alpha</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>numSims <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="do">## guess at distribution and params for alpha</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="do">## let's say alpha ~ normal(0,10) was my first guess</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="do">## then simulate effects on theta.  Do they mimic</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="do">## your uncertainty in theat without data?  If no,</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="do">## iterate with a different guess. After </span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="do">## many iterations I settled on normal(-1,1.5)</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="do">## below code gets repsample of theta for this prior</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">alpha =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> numSims, </span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mean =</span> <span class="sc">-</span><span class="fl">1.</span>, </span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sd =</span> <span class="fl">1.5</span>))</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span></span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> alpha) <span class="sc">%&gt;%</span> <span class="do">##follows DAG</span></span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>y)))  <span class="do">## inv logit</span></span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a><span class="do">## plot implied theta distribution</span></span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_density</span>(<span class="sc">~</span> theta, <span class="at">data =</span> simDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure above is the result of many iterations of looking at the effect of changes in <code>alpha</code>’s prior on success probability <code>theta</code>. I stopped at because it reflected my mild belief that sign-up probability will be smaller than 50%, but should also remain open to any possible value. I am also comfortable with the hump of probability around 10%, that sounds like a good mode for recruiting.</p>
<p>Your prior should be open to changing its mind, but it should also reflect assumptions you are willing to make. Don’t be afraid to have mildly informative priors, they do not all need to be uniform. This will protect you from bad decisions when there is not alot of data to inform the posterior.</p>
<p>A similar exercise is done for the prior on . Recognizing that stretching is most likely going to have a small effect. I run the following code to find my prior:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>numSims <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="do">## guess at distribution and params for beta</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="do">## since beta is deviation from base rate alpha</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="do">## assume a base rate and then, see effects</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="do">## mean should absolutely be zero to indicate no prior</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="do">## preference for whether yoga is helpful</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="do">## let the data tip the scales</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="do">## sd should be smaller than that used for alpha</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>baseRate <span class="ot">=</span> <span class="fl">0.20</span>  <span class="do">## assumed for now</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="do">## logit function </span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="do">## input: probability, </span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="do">## output: linear Predictor</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a><span class="do">## inverse of the inverse logit function</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a><span class="do">## linearPredictor = log(probability / (1-probability))</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">log</span>(baseRate <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> baseRate))</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">alpha =</span> alpha,</span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">beta =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> numSims,</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>                            <span class="at">mean =</span> <span class="dv">0</span>,  </span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd =</span> <span class="fl">0.75</span>))</span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yNoYoga =</span> alpha) <span class="sc">%&gt;%</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yWithYoga =</span> alpha <span class="sc">+</span> beta) <span class="sc">%&gt;%</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thetaNoYoga =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>yNoYoga))) <span class="sc">%&gt;%</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">thetaWithYoga =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>yWithYoga))) <span class="sc">%&gt;%</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probDiff =</span> thetaWithYoga <span class="sc">-</span> thetaNoYoga)</span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a><span class="do">## plot implied theta distribution</span></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_density</span>(<span class="sc">~</span> probDiff, <span class="at">data =</span> simDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-128-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="parameter-estimation-1" class="level4">
<h4 class="anchored" data-anchor-id="parameter-estimation-1">Parameter estimation</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph2 <span class="sc">%&gt;%</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">%&gt;%</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-130-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Recall that these are components of a linear predictor (i.e.&nbsp;<span class="math inline">\(\alpha + \beta x\)</span>). If the linear predictor is zero, that corresponds to a probability of 50%. Hence, values for <span class="math inline">\(\alpha &lt; 0\)</span> would imply base conversion rates less than 50%. Values for <span class="math inline">\(\beta\)</span> indicate whether that base probability should be adjusted up or down; <span class="math inline">\(\beta \lt 0\)</span> implies a negative effect for the yoga stretching routine and <span class="math inline">\(\beta \gt 0\)</span> indicates that the effect is positive.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>plotDF <span class="ot">=</span> gymDF <span class="sc">%&gt;%</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stretchType =</span> </span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(yogaStretch <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Yoga Stretch"</span>, </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Traditional"</span>))</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plotDF, </span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> timePeriod, <span class="co">#map time to x-axis</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> nTrialCustomers, <span class="co">#map numTrials to y-axis</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> stretchType <span class="co">#map fill to stretch type</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>                  )) <span class="sc">+</span> </span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.75</span>, </span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.55</span>) <span class="sc">+</span>  <span class="co"># use transparency</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.75</span>, </span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">y =</span> nSigned)) <span class="sc">+</span> <span class="co"># different y-mapping</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(gymID), <span class="at">labeller =</span> label_both) <span class="sc">+</span> </span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="dv">11</span>) <span class="sc">+</span> </span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.caption =</span> </span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>, <span class="at">face =</span> <span class="st">"italic"</span>),</span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"# of Trial Customers"</span>) <span class="sc">+</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> </span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>         <span class="st">"Darker fill for # of sign-ups."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-131-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Comparing the estimates above with the gym data from the top (copied above for convenience), notice how the posterior estimates correspond with your expectations. The <span class="math inline">\(\alpha\)</span> values with the smallest credible intervals are for gyms that have the largest number of trial customers participating in trials with traditional stretching (i.e.&nbsp;gyms 2, 5, and 8). Similarly, the <span class="math inline">\(\beta\)</span> values with the smallest credible intervals are for gyms that have the largest number of trial customers participating in Yoga stretching classes (i.e.&nbsp;gyms 1 and 4). The opposite is also observable. Gyms lacking data for traditional stretching have wide credible intervals for <span class="math inline">\(\alpha\)</span> (e.g.&nbsp;gym 10) and gyms lacking data for yoga stretching do not improve on the prior uncertainty in <span class="math inline">\(\beta\)</span> (e.g.&nbsp;gyms 11 and 12).</p>
<p>This no pooling model is not terrible in the sense that each gym gets statistically modeled. Let’s do some challenging data manipulation and do a posterior predictive check:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get DF of observed data and remove target measure</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> gymDF <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>nSigned)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get 20 random draws of posterior</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>paramsDF <span class="ot">=</span> drawsDF <span class="sc">%&gt;%</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampDrawID =</span> <span class="fu">row_number</span>()) </span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a><span class="do">## when data like gym_id is in the name of column </span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="do">## headings, e.g. alpha_4,</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="do">## we use the tidyr package pivot_longer function </span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a><span class="do">## to turn headings into data</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a><span class="do">## and extract the gymID information from the heading</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>tidyParamDF <span class="ot">=</span> paramsDF <span class="sc">%&gt;%</span> </span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>sampDrawID) <span class="sc">%&gt;%</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gymID =</span> <span class="fu">str_extract</span>(name, <span class="st">'[0-9]+'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gymID =</span> <span class="fu">as.integer</span>(gymID)) <span class="sc">%&gt;%</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">paramName =</span> <span class="fu">str_extract</span>(name, <span class="st">'[:alpha:]+'</span>))</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a><span class="do">## now we get explanatory variable info </span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="do">## combined with relevant params</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tidyParamDF, <span class="at">by =</span> <span class="st">"gymID"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in left_join(., tidyParamDF, by = "gymID"): Detected an unexpected many-to-many relationship between `x` and `y`.
ℹ Row 1 of `x` matches multiple rows in `y`.
ℹ Row 1 of `y` matches multiple rows in `x`.
ℹ If a many-to-many relationship is expected, set `relationship =
  "many-to-many"` to silence this warning.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 44 observations * 2 params per row * 20 sims </span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="do">## = 1,760 rows</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get relevant alpha and beta on same row</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>simPredDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> gymID<span class="sc">:</span>sampDrawID,</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> paramName,</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> value)</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="do">## if no yoga, then y=alpha.  If yoga, then y=alpha+beta</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>simPredDF <span class="ot">=</span> simPredDF <span class="sc">%&gt;%</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">ifelse</span>(yogaStretch <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>                    alpha, alpha<span class="sc">+</span>beta)) <span class="sc">%&gt;%</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>y))) <span class="sc">%&gt;%</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nSigned =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">size =</span> nTrialCustomers,</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prob =</span> theta))</span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>obsDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">obs =</span> gymDF<span class="sc">$</span>nSigned)</span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"simulated"</span> <span class="ot">=</span> <span class="st">"cadetblue"</span>, </span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>           <span class="st">"observed"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>)</span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a><span class="do">## make plot</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simPredDF) <span class="sc">+</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density</span>(<span class="fu">aes</span>(<span class="at">x=</span>nSigned, </span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>                   <span class="at">group =</span> sampDrawID,</span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> <span class="st">"simulated"</span>),</span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">"line"</span>,</span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density</span>(<span class="at">data =</span> obsDF, <span class="fu">aes</span>(<span class="at">x=</span>obs, </span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">color =</span> <span class="st">"observed"</span>),</span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">"line"</span>,  </span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>               <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>               <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"# of Monthly Signups"</span>,</span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density Estimated from Data"</span>,</span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Data Type"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-132-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This posterior predictive check looks really good. Yet, the estimates above revealed there are credible intervals which can be made smaller; uncertainty bands can be narrowed for gym’s missing one type of class. We know, from previous observation at all the gyms, that yoga’s effect seems small. Hence, the wide uncertainty bands are not warranted. Going the other way, we should have more confidence in gym 10’s recruitment rate (). Gym 10 is a star performer and I do not think dropping the yoga-stretch will lead to enormous drops in rate. Overall, I think we should agree that learning about one gym might tell us something about another gym. In fact, I would argue that learning about 12 gym’s should tell us what we might expect when the next 100 gyms are opened. The next model explores this and shows us we can do better.</p>
</section>
</section>
<section id="partial-pooling" class="level3">
<h3 class="anchored" data-anchor-id="partial-pooling">Partial pooling</h3>
<p>The partial pooling model imagines that the Crossfit Gyms business model produces gyms with similar characteristics. Some gyms will do better than average and some gyms will do worse, but there is some relationship between each gym’s performance. In this case, learning about one gym’s success in recruiting provides information about that gym as well as the entire population of Crossfit gyms.</p>
<p>To accomodate this structure (i.e.&nbsp;known as hierarchical or multi-level structure), we add parent nodes to the gym-level coefficients in the previous generative DAG (stored in <code>graph2</code>) and change the statistical model for those gym-level coefficients as well. The partial pooling model generative DAG (<code>graph3</code>) can be specified as:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>graph3 <span class="ot">=</span> <span class="fu">dag_create</span>() <span class="sc">%&gt;%</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Signups"</span>,<span class="st">"k"</span>,</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">binomial</span>(nTrials,theta),</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nSigned) <span class="sc">%&gt;%</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Signup Probability"</span>,<span class="st">"theta"</span>,</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y))) <span class="sc">%&gt;%</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Number of Trials"</span>,<span class="st">"nTrials"</span>,</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"k"</span>,</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>nTrialCustomers) <span class="sc">%&gt;%</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Linear Predictor"</span>,<span class="st">"y"</span>,</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> x,</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"theta"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Yoga Stretch Flag"</span>,<span class="st">"x"</span>,</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> gymDF<span class="sc">$</span>yogaStretch,</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Gym Intercept"</span>,<span class="st">"alpha"</span>,</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(mu_alpha,sd_alpha),</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Gym Yoga Slope Coeff"</span>,<span class="st">"beta"</span>,</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(mu_beta,sd_beta),</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg Crossfit Intercept"</span>,<span class="st">"mu_alpha"</span>,</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">1.5</span>),</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"alpha"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Avg Crossfit Yoga Slope"</span>,<span class="st">"mu_beta"</span>,</span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.75</span>),</span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"beta"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"SD Crossfit Intercept"</span>,<span class="st">"sd_alpha"</span>,</span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="dv">3</span>),</span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"alpha"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"SD Crossfit Yoga Slope"</span>,<span class="st">"sd_beta"</span>,</span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">rhs =</span> <span class="fu">uniform</span>(<span class="dv">0</span>,<span class="fl">1.5</span>),</span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">child =</span> <span class="st">"beta"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Gym"</span>,<span class="st">"j"</span>,</span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>),</span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> gymDF<span class="sc">$</span>gymID,</span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">addDataNode =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Observation"</span>,<span class="st">"i"</span>,</span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"x"</span>,<span class="st">"j"</span>,</span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"nTrials"</span>,<span class="st">"theta"</span>,<span class="st">"y"</span>))</span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>graph3 <span class="sc">%&gt;%</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-9e5c90bfa43893a2d8ed" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-9e5c90bfa43893a2d8ed">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"8\" [label = \"Avg Crossfit Intercept\nmu_alpha ~ normal(-1,1.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"9\" [label = \"Avg Crossfit Yoga Slope\nmu_beta ~ normal(0,0.75)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"10\" [label = \"SD Crossfit Intercept\nsd_alpha ~ uniform(0,3)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"11\" [label = \"SD Crossfit Yoga Slope\nsd_beta ~ uniform(0,1.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Gym j [12]\"\n  \"6\" [label = \"Gym Intercept\nalpha ~ normal(mu_alpha,sd_alpha)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Gym Yoga Slope Coeff\nbeta ~ normal(mu_beta,sd_beta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\nsubgraph cluster3{\nlabel=\"Observation i [44]\"\n  \"1\" [label = \"Number of Signups\nk ~ binomial(nTrials,theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Signup Probability\ntheta = 1 / (1 + exp(-y))\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Number of Trials\nnTrials\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Linear Predictor\ny = alpha[j] + beta[j] * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Yoga Stretch Flag\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"12\" [label = \"Gym\nj\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"6\"->\"4\" [style = \"dashed\"] \n\"7\"->\"4\" [style = \"dashed\"] \n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"2\" [style = \"solid\"] \n\"5\"->\"4\" [style = \"solid\"] \n\"8\"->\"6\" [style = \"solid\"] \n\"9\"->\"7\" [style = \"solid\"] \n\"10\"->\"6\" [style = \"solid\"] \n\"11\"->\"7\" [style = \"solid\"] \n\"12\"->\"4\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Model with partially pooled observations</strong> - all gyms share common parent nodes. The data informs both the parameters of the parent nodes as well as the parameters of their children, i.e.&nbsp;the gym-level coefficients. Think of gyms as children of the Crossfit chain - each child is different, but probably shares some underlying characterstics.</p>
</div>
</div>
<p>Take note of the top row of random variables in the generative DAG above, which characterize the population of gyms. Think of the first two nodes as characterizing the base conversion rate for the population of crossfit gyms - one represents an expectation of any single gym’s intercept and the other represents how much deviation should be expected between the intercept’s of all the gyms. For example, a high <code>mu_alpha</code> and a small <code>sd_alpha</code> would suggest any randomly chosen Crossfit gym will have a high base-level probability for membership sign-ups and additionally, no matter which gym is chosen, its likely to have a similarly high base-level probability.</p>
<p>For priors, we used our previous prior for gym-level intercept to now be the prior for its parent, <code>mu_alpha</code> which is the expected base intercept for any Crossfit gym. The standard deviation component, <code>sd_alpha</code>, uses a uniform distribution that is twice the standard deviation prior for <code>mu_alpha</code>; chosen so the variation in base conversion rates will be on a similar scale to our own uncertainty in the corresponding mean, i.e.&nbsp;<code>mu_alpha</code>.</p>
<p>The next two nodes atop the generative DAG suggest that every gym’s slope coefficient for yoga is drawn from a distribution characterized by an average effect of yoga stretching for any Crossfit gym, <code>mu_beta</code>, and a standard deviation, <code>sd_beta</code> measuring how likely any individual gym’s effect might deviate from the average. Priors are chosen as was done for the first two nodes.</p>
<p>Through these population parameters, each gym’s <span class="math inline">\(\alpha_j\)</span> and <span class="math inline">\(\beta_j\)</span> are related; in cases of minimal gym data, the population parameters will be very important in estimating gym performance, conversely, in cases a gym shows strong deviation from the population parameters over a lot of trial customers, then these population parameters will get ignored.</p>
<p>With generative DAG in place, we can compute and visualize the posterior in the standard way:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph3 <span class="sc">%&gt;%</span> <span class="fu">dag_numpyro</span>()</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="sc">%&gt;%</span> <span class="fu">dagp_plot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-134-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure below shows a slightly different snapshot of the posterior distribution. In addition to the partial pooling posterior, the previous <em>no-pooling</em> posterior is also put on the graph for comparison. This will help us see what gains are made (or not) by adding the four hyperparameters (i.e.&nbsp;<code>mu_alpha</code>,<code>mu_beta</code>,<code>sd_alpha</code>,<code>sd_beta</code>).</p>
<p><img src="images/clipboard-4243588728.png" class="img-fluid"></p>
<p>Visually comparing the estimates of the two models helps us learn how to think about the multi-level model’s (i.e.&nbsp;partial pooling) interpretation:</p>
<ul>
<li><p>Uncertainty interval widths have shrunk; especially for gym/stretching combinations that have yet to be seen. For example, gym10 has only two observations, both yoga, no traditional stretching observations. Now look at the change in , the base conversion rate parameter without yoga. Its a narrower interval than with no pooling. The narrowness is because we have learned about the effects of yoga from the other gyms and hence, can reason better about this unobserved base rate. This base rate remains high because we have also learned that differences due to yoga are never that dramatic.</p></li>
<li><p>There is increased confidence that yoga stretching would be effective at each gym. Look at the rightward shift of most of the partial pooling <code>beta</code> estimates. Also, <code>mu_beta</code>, the average effect of yoga is clearly greater than zero; hence, it seems like a good idea for Crossfit to promote yoga.</p></li>
<li><p>Not all gym’s are equal. Looking at gym 9 where there are 3 time periods of observations - one with traditional stretching that seemed better than the others. From the partial-pooling posterior, you see a rightward shift of <code>beta_9</code> as compared to the no-pooling model because we’ve learned that yoga works at other gyms. The uncertainty interval is clearly both positive and negative indicating we need more data to confidently dismiss or accept the idea of yoga.</p></li>
<li><p>Both <code>alpha</code> and <code>beta</code> intervals in the partial pooling model often (but not always) get pulled towards their means, <code>mu_alpha</code> and <code>mu_beta</code> respectively. Because we are sharing information through these parents, their impact gets felt at the gym level - especially in cases of gym’s without much data. For example, gym 12 only has one time period of observation, so both <code>alpha_12</code> and <code>beta_12</code> intervals are pushed towards the expected values of their parent nodes. Gym 5 has alot of data and as a result does not respond to these parental node influences.</p></li>
<li><p>The interval for <code>sd_alpha</code> being away from zero suggests that there is alot of deviation between gyms in terms of average expected base conversion rate. Recruitment rate is quite gym-specific. We can also see this in the original data as gym 10 seems exceptional and gym 2 needs new management.</p></li>
</ul>
<p>Overall, the partial pooling model is mildly helpful in reducing our uncertainty. Perhaps the best conclusion enabled by partial pooiling is that <code>mu_beta</code> being greater than zero; yoga is helpful, a point that was not crystal clear when just looking at the gym data. More importantly, this partial-pooling model tells a story of related gyms where insights at one gym help inform our opinion about other gyms.</p>
<section id="posterior-predictive-checks-2" class="level4">
<h4 class="anchored" data-anchor-id="posterior-predictive-checks-2">Posterior predictive checks</h4>
<p>While these more confident and revealing estimates seem like a good thing, a posterior predictive check is in order to ensure that our model is still capable of producing data that might occassionally look like the actual data that we saw. Below is code for the posterior predictive check - its identical to the no-pooling model as we do NOT need to worry about the hyperparameters. As long as we have the parent-nodes of the linear-predictor, we do not need to worry about how they were generated by the grand-parent nodes.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> gymDF <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>nSigned)</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="do">## get 20 random draws of posterior</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>paramsDF <span class="ot">=</span> drawsDF <span class="sc">%&gt;%</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sampDrawID =</span> <span class="fu">row_number</span>())</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>tidyParamDF <span class="ot">=</span> paramsDF <span class="sc">%&gt;%</span> </span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>sampDrawID) <span class="sc">%&gt;%</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gymID =</span> <span class="fu">str_extract</span>(name, <span class="st">'[0-9]+'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gymID =</span> <span class="fu">as.integer</span>(gymID)) <span class="sc">%&gt;%</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">paramName =</span> <span class="fu">str_extract</span>(name, <span class="st">'[:alpha:]+'</span>))</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a><span class="do">## combine needed info</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>simDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tidyParamDF, <span class="at">by =</span> <span class="st">"gymID"</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in left_join(., tidyParamDF, by = "gymID"): Detected an unexpected many-to-many relationship between `x` and `y`.
ℹ Row 1 of `x` matches multiple rows in `y`.
ℹ Row 1 of `y` matches multiple rows in `x`.
ℹ If a many-to-many relationship is expected, set `relationship =
  "many-to-many"` to silence this warning.</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get relevant alpha and beta on same row</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>simPredDF <span class="ot">=</span> simDF <span class="sc">%&gt;%</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> gymID<span class="sc">:</span>sampDrawID,</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> paramName,</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> value)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="do">## if no yoga, then y=alpha. If yoga,then y=alpha+beta</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>simPredDF <span class="ot">=</span> simPredDF <span class="sc">%&gt;%</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">ifelse</span>(yogaStretch <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>                    alpha, alpha<span class="sc">+</span>beta)) <span class="sc">%&gt;%</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>y))) <span class="sc">%&gt;%</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nSigned =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">size =</span> nTrialCustomers,</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">prob =</span> theta))</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>obsDF <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">obs =</span> gymDF<span class="sc">$</span>nSigned)</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"simulated"</span> <span class="ot">=</span> <span class="st">"cadetblue"</span>, </span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>           <span class="st">"observed"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>)</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a><span class="do">## make plot</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(simPredDF) <span class="sc">+</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density</span>(<span class="fu">aes</span>(<span class="at">x=</span>nSigned, </span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>                   <span class="at">group =</span> sampDrawID,</span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> <span class="st">"simulated"</span>),</span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">"line"</span>, </span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_density</span>(<span class="at">data =</span> obsDF, <span class="fu">aes</span>(<span class="at">x=</span>obs, </span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">color =</span> <span class="st">"observed"</span>),</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">"line"</span>,  </span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"# of Monthly Signups"</span>,</span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density Estimated from Data"</span>,</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Data Type"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-135-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The figure above is encouraging!! It looks like the actual data might get generated from our posterior distribution. The partial pooling model seems to work! Hooray! Next chapter we interpret the results of this model for decision making.</p>
</section>
</section>
</section>
<section id="compelling-decisions-and-actions-under-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="compelling-decisions-and-actions-under-uncertainty">Compelling decisions and actions under uncertainty</h2>
<p>We now continue last chapter’s investigation of Crossfit Gym’s use of yoga. Our goal is to bring the mathematical estimates of our posterior distribution’s parameters back into the real-world with compelling and visually-based recommendations. To do this, we 1) define our <em>outcomes of interest</em>, 2) <em>compute a posterior distribution</em> for those outcomes, and 3) communicate our beliefs about those outcomes by <em>visualizing the outcomes of interest</em>.</p>
<section id="outcomes-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="outcomes-of-interest">Outcomes of interest</h3>
<p>Our main outcome of interest is signup probability. We will investigate signup probability by investigating that particular node in relation to our decision. Representing this is the deceptively simple generative decision DAG shown below.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dag_create</span>() <span class="sc">%&gt;%</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Yoga Stretching?"</span>,<span class="st">"yoga"</span>,</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">dec =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_node</span>(<span class="st">"Signup Probability"</span>,<span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_edge</span>(<span class="st">"yoga"</span>,<span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_plate</span>(<span class="st">"Stretch Type"</span>,<span class="st">""</span>,</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">nodeLabels =</span> <span class="fu">c</span>(<span class="st">"yoga"</span>,<span class="st">"prob"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dag_render</span>(<span class="at">shortLabel =</span> <span class="cn">TRUE</span>, <span class="at">wrapWidth =</span> <span class="dv">12</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-a0410349e08474188736" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-a0410349e08474188736">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\nsubgraph cluster1{\nlabel=\"Stretch Type X\"\n  \"1\" [label = \"Yoga\nStretching?\", shape = \"rect\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Signup\nProbability\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\n\"1\"->\"2\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>The top-down narrative of the generative decision DAG above is as follows. Crossfit Gyms decides on whether to offer yoga stretching and the sign-up probability across their gyms changes as a result. Our job is to quantify this change and form an opinion on whether to offer yoga stretching or not across the gyms; we will form our opinion using the posterior distribution.</p>
</section>
<section id="computing-posterior-distributions-for-outcomes-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="computing-posterior-distributions-for-outcomes-of-interest">Computing posterior distributions for outcomes of interest</h3>
<p>The last model in the previous chapter gets us the generative DAG of Figure <a href="https://www.causact.com/compelling-decisions-and-actions-under-uncertainty#fig:partPoolingGM2">24.1</a>. Running it through the <code>dag_numpyro()</code> function yields a posterior distribution, but our job as analysts is not over. We now have to make sense of the posterior distribution and communicate its implications to stakeholders.</p>
<p>Rerun the analysis at the end of the previous chapter concluding with:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>drawsDF <span class="ot">=</span> graph3 <span class="sc">%&gt;%</span> <span class="fu">dag_numpyro</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>where <code>drawsDF</code> is a representative sample of the posterior distribution associated with partial pooling model. This data frame is a sample of 4,000 draws of 28 variables. Let’s list the 28 variables using <code>names(drawsDF)</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(drawsDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "alpha_1"  "alpha_2"  "alpha_3"  "alpha_4"  "alpha_5"  "alpha_6" 
 [7] "alpha_7"  "alpha_8"  "alpha_9"  "alpha_10" "alpha_11" "alpha_12"
[13] "beta_1"   "beta_2"   "beta_3"   "beta_4"   "beta_5"   "beta_6"  
[19] "beta_7"   "beta_8"   "beta_9"   "beta_10"  "beta_11"  "beta_12" 
[25] "mu_alpha" "mu_beta"  "sd_alpha" "sd_beta" </code></pre>
</div>
</div>
<p>Perusing our posterior’s 28 random variables, we might notice that <code>theta</code> is not one of them. Bummer! We are going to need to do some coding to get a representative sample for <code>theta</code>.</p>
<p><code>theta</code> is omitted because it is a calculated node; its realization is a deterministic function of its parent <code>y</code> which is also a calculated node. Note that an oval’s double-perimeter is the visual clue for a calculated node. Its parents include both random and observed nodes. So to actually determine <code>theta</code>, we need follow the generative recipe from grandparents (<code>alpha</code>,<code>beta</code>,<code>j</code>, and <code>x</code>) to grandchild (<code>theta</code>) via linear predictor <code>y</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>graph3 <span class="sc">%&gt;%</span> <span class="fu">dag_render</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-d8542c91a99e85c6bc68" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d8542c91a99e85c6bc68">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       labelloc = \"b\",\n       labeljust = \"r\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"ellipse\",\n      fixedsize = \"false\",\n      width = \"0.9\",\n      style = \"filled\",\n      fillcolor = \"AliceBlue\",\n      color = \"gray20\",\n      fontcolor = \"black\",\n      height = \"0.5\",\n      margin = \"0.05,0.05\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray20\",\n     arrowsize = \"0.5\",\n     fontcolor = \"black\"]\n\n  \"8\" [label = \"Avg Crossfit Intercept\nmu_alpha ~ normal(-1,1.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"9\" [label = \"Avg Crossfit Yoga Slope\nmu_beta ~ normal(0,0.75)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"10\" [label = \"SD Crossfit Intercept\nsd_alpha ~ uniform(0,3)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"11\" [label = \"SD Crossfit Yoga Slope\nsd_beta ~ uniform(0,1.5)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \nsubgraph cluster2{\nlabel=\"Gym j [12]\"\n  \"6\" [label = \"Gym Intercept\nalpha ~ normal(mu_alpha,sd_alpha)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"7\" [label = \"Gym Yoga Slope Coeff\nbeta ~ normal(mu_beta,sd_beta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"aliceblue\", fontcolor = \"black\"] }\n\nsubgraph cluster3{\nlabel=\"Observation i [44]\"\n  \"1\" [label = \"Number of Signups\nk ~ binomial(nTrials,theta)\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"2\" [label = \"Signup Probability\ntheta = 1 / (1 + exp(-y))\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"3\" [label = \"Number of Trials\nnTrials\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"4\" [label = \"Linear Predictor\ny = alpha[j] + beta[j] * x\", shape = \"ellipse\", peripheries = \"2\", fillcolor = \"aliceblue\", fontcolor = \"black\"] \n  \"5\" [label = \"Yoga Stretch Flag\nx\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] \n  \"12\" [label = \"Gym\nj\", shape = \"ellipse\", peripheries = \"1\", fillcolor = \"cadetblue\", fontcolor = \"black\"] }\n\n\"6\"->\"4\" [style = \"dashed\"] \n\"7\"->\"4\" [style = \"dashed\"] \n\"2\"->\"1\" [style = \"solid\"] \n\"3\"->\"1\" [style = \"solid\"] \n\"4\"->\"2\" [style = \"solid\"] \n\"5\"->\"4\" [style = \"solid\"] \n\"8\"->\"6\" [style = \"solid\"] \n\"9\"->\"7\" [style = \"solid\"] \n\"10\"->\"6\" [style = \"solid\"] \n\"11\"->\"7\" [style = \"solid\"] \n\"12\"->\"4\" [style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Notice, we do not care about <code>mu_alpha</code> and the other parents of <code>alpha</code> and <code>beta</code>. Once we have a representative sample of <code>alpha</code> and <code>beta</code>, plus the observed nodes <code>j</code> and <code>x</code> , then we can calculate <code>theta</code>.</p>
<p>For example, let’s estimate the additional sign-up probability when using “Yoga Stretch” at gym number 12?</p>
<ol type="1">
<li>Get a single draw of the required nodes from the representative sample:</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>draw <span class="ot">=</span> drawsDF <span class="sc">%&gt;%</span> </span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># get a random draw</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(alpha_12,beta_12)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="2" type="1">
<li>Compute a value for the linear predictor with and without yoga (i.e.&nbsp;<code>x=1</code> and <code>x=0</code>, respectively) using the formula shown for this node in the generative decision DAG. Plugging in for <code>x</code>, we get the two different values of linear preditor <code>y</code> that interest us: <code>x=1</code> <span class="math inline">\(\rightarrow y_{yoga} = \alpha{12}+\beta{12}*1\)</span>) and without yoga (<code>x=0</code> <span class="math inline">\(\rightarrow y_{trad} = \alpha{12}+\beta{12}*0 = \alpha_{12}\)</span>):</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>draw <span class="ot">=</span> draw <span class="sc">%&gt;%</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_yoga =</span> alpha_12 <span class="sc">+</span> beta_12 <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_trad =</span> alpha_12)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="3" type="1">
<li>Compute the values for <code>theta</code> with and without yoga at gym12 using the inverse-logit function (i.e.&nbsp;the link function formula shown for this node in the generative decision DAG):</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>draw <span class="ot">=</span> draw <span class="sc">%&gt;%</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta_yoga =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y_yoga))) <span class="sc">%&gt;%</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta_trad =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y_trad)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="4" type="1">
<li>Compute the increased probability of signup when using yoga at gym12:</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>draw <span class="ot">=</span> draw <span class="sc">%&gt;%</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">probIncDueToYoga =</span> </span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>           theta_yoga <span class="sc">-</span> theta_trad)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And now, viewing these computed values:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>draw</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">alpha_12</th>
<th style="text-align: right;">beta_12</th>
<th style="text-align: right;">y_yoga</th>
<th style="text-align: right;">y_trad</th>
<th style="text-align: right;">theta_yoga</th>
<th style="text-align: right;">theta_trad</th>
<th style="text-align: right;">probIncDueToYoga</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-2.992</td>
<td style="text-align: right;">0.6414</td>
<td style="text-align: right;">-2.351</td>
<td style="text-align: right;">-2.992</td>
<td style="text-align: right;">0.087</td>
<td style="text-align: right;">0.0478</td>
<td style="text-align: right;">0.0392</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>we see that for this draw, around 21% of yoga trial customers end up signing up for a membership versus 15% of customers doing traditional stretching. According to this draw then, approximately 6% is the signup probability increase due to yoga stretching.</p>
<p>Let’s get a little mathematical and declare this difference in probabilities to be a new random variable <code>Z_{gymID}</code> like:</p>
<p><span class="math display">\[
Z_{12} \equiv \textrm{ Probability increase due to yoga stretching at gym 12}
\]</span></p>
<p>The following code scales the above four steps for creating one draw to creating a column of representative samples for <span class="math inline">\(Z_{12}\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>postDF <span class="ot">=</span> drawsDF <span class="sc">%&gt;%</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(alpha_12,beta_12) <span class="sc">%&gt;%</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_yoga =</span> alpha_12 <span class="sc">+</span> beta_12 <span class="sc">*</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_trad =</span> alpha_12) <span class="sc">%&gt;%</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta_yoga =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y_yoga))) <span class="sc">%&gt;%</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">theta_trad =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>y_trad))) <span class="sc">%&gt;%</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z_12 =</span> theta_yoga <span class="sc">-</span> theta_trad)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The column we just made, <code>z_12</code>, is our posterior distribution for the change in probability due to yoga stretching. We can visualize and summarize this posterior density:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_density</span>(<span class="sc">~</span> z_12, <span class="at">data =</span> postDF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-146-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(postDF<span class="sc">$</span>z_12)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-0.2027  0.0182  0.0515  0.0656  0.0956  0.6562 </code></pre>
</div>
</div>
<p>and form only a mild opinion that yoga is probably helpful at gym 12 (i.e.&nbsp;most of the plausible values are above zero).</p>
</section>
<section id="visual-advocacy-for-decisions-which-improve-outcomes-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="visual-advocacy-for-decisions-which-improve-outcomes-of-interest">Visual advocacy for decisions which improve outcomes of interest</h3>
<p>To convert posterior probabilities into decisions, we want a visual that communicates a recommendation. In business, a random variable outcome of interest is usually made more compelling by converting it to some measure of money. Let’s assume that that the value of each new customer is estimated to be $500 in <em>net present value</em> terms. We can then create a mathematical formula for value created by yoga stretching per trial customer:</p>
<p><span class="math display">\[
\textrm{ValueOfYogaStretchingForGym12} = 500 \times Z_{12}
\]</span></p>
<p>and also, represent it computationally:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>moneyDF <span class="ot">=</span> postDF <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ValueCreated =</span> <span class="dv">500</span> <span class="sc">*</span> z_12)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We now have a random variable of the per customer profit estimate if gym12 adopts yoga stretching for the next year versus not adopting yoga stretching. We can summarize this random variable graphically:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_density</span>(<span class="sc">~</span> ValueCreated, <span class="at">data =</span> moneyDF) <span class="sc">|&gt;</span> <span class="fu">gf_refine</span>(<span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="fu">dollar_format</span>()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-149-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>which shows both the plausibility of losing money as well as making up to say $100 per customer as a result of the decision. We can find some additional metrics:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(moneyDF<span class="sc">$</span>ValueCreated)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-101.34    9.12   25.77   32.78   47.80  328.11 </code></pre>
</div>
</div>
<p>telling us the median value for gym12 is about $24 of extra value per customer. This means that we assign a 50/50 chance to being above or below this number in terms of value created per customer. Hence, if it costs extra money (e.g.&nbsp;licensing fees, additional labor expense, additional equipment expense, etc.), say $25 per customer to offer the class, then this investment at gym12 might not be recovered.</p>
<p>Lastly, since continuous probability estimates are sometimes difficult for decision makers (and ourselves) to understand, we can create a discrete probability distribution by creating bins:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1000</span>,<span class="sc">-</span><span class="dv">20</span>,<span class="dv">0</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>,<span class="dv">80</span>,<span class="dv">100</span>,<span class="dv">1000</span>)</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"&lt;-$20"</span>,<span class="st">"-$20 - $0"</span>,<span class="st">"$0 - $20"</span>,</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$20 - 40$"</span>,<span class="st">"$40 - $60"</span>,<span class="st">"$60 - $80"</span>,</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$80-$100"</span>,<span class="st">"$100+"</span>)</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">=</span> <span class="fu">cut</span>(moneyDF<span class="sc">$</span>ValueCreated, </span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>           breaks, </span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">include.lowest =</span> T, </span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">right=</span><span class="cn">FALSE</span>, </span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">labels=</span>labels)</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>moneyDF<span class="sc">$</span>bins <span class="ot">=</span> bins  <span class="do">## add new column</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="do">## add label for percentage in each bin</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>plotDF <span class="ot">=</span> moneyDF <span class="sc">%&gt;%</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(bins) <span class="sc">%&gt;%</span></span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">countInBin =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pctInBin =</span> countInBin <span class="sc">/</span> <span class="fu">sum</span>(countInBin)) <span class="sc">%&gt;%</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>pctInBin,<span class="dv">0</span>),<span class="st">"%"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">makeMoney =</span> <span class="fu">ifelse</span>(bins <span class="sc">%in%</span> <span class="fu">levels</span>(bins)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Not Profitable"</span>,</span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Profitable"</span>))</span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Create more interpretable plot</span></span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a>plotDF <span class="sc">%&gt;%</span></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bins, <span class="at">y =</span> pctInBin, </span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> makeMoney)) <span class="sc">+</span></span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>label), <span class="at">nudge_y =</span> <span class="fl">0.015</span>) <span class="sc">+</span></span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Value Added Per Trial Customer"</span>) <span class="sc">+</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability of Outcome"</span>) <span class="sc">+</span></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightcoral"</span>,</span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"cadetblue"</span>)) <span class="sc">+</span></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Making Yoga Stretching Mandatory for Gym 12"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causact_files/figure-html/unnamed-chunk-151-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the above, we can easily talk to any decision maker about the possiblities for various outcomes. For example, summing the bottom two percentages tells us there is an approximately 14% chance of yoga stretching creating negative value. Additionally, if Crossfit anticipates a cost of $20 per customer, then there is a 46% chance of not breaking even by using this policy.</p>
</section>
</section>
<section id="the-journey-continues" class="level2">
<h2 class="anchored" data-anchor-id="the-journey-continues">The journey continues</h2>
<p><span class="smallcaps">CONGRATULATIONS!!!</span> You have journeyed through a challenging path and persevered. You are now equipped to “release the BAW”. In your journey, you learned to coordinate three languages – 1) graphical models to aid business communication , 2) probability theory for Bayesian inference, and 3) the R programming language to manipulate and visualize data as well as to give you access to statistical computation. The use of generative DAGs from the <code>causact</code> package enabled you to reduce the friction between these languages. As a tradeoff, however, your knowledge in any one of the languages only runs so deep. Now is the time to keep going and pick from the below resources to further develop your skills.</p>
<section id="additional-readings" class="level3">
<h3 class="anchored" data-anchor-id="additional-readings">Additional readings</h3>
<ul>
<li><p>Michael Betancourt (2018Michael Betancourt. 2018. <em>Towards a Principled Bayesian Workflow (RStan)</em>. <a href="https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html" class="uri">https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html</a>.) provides the <em>scientific philosophy of Bayesian statistics</em> and associated computational methods with mathematical rigor and beautiful pictures.</p></li>
<li><p>Gelman, Hill, and Vehtari (2020Gelman, Andrew, Jennifer Hill, and Aki Vehtari. 2020. <em>Regression and Other Stories</em>. Cambridge University Press.) dives much deeper into <em>multilevel regression</em> than is done in this text. These three authors are gurus of applied Bayesian statistics.</p></li>
<li><p>Grolemund and Wickham (2018Grolemund, Garrett, and Hadley Wickham. 2018. “R for Data Science.”) is a fundamental read on <em>R programming</em>, data manipulation, and using R in analytics workflows.</p></li>
<li><p>McElreath (2020McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in r and Stan</em>. CRC press.) made a pedagogical masterpiece that teaches more mathematically rigorous <em>Bayesian statistics</em> in a fun way. I highly recommend this as the next book in your journey.</p></li>
<li><p>Wilke (2019Wilke, Claus O. 2019. <em>Fundamentals of Data Visualization: A Primer on Making Informative and Compelling Figures</em>. O’Reilly Media.) is a wonderful read for exploring <em>data visualization</em>. All the code for numerous beautiful <code>ggplots</code> is made available to the reader.</p></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>